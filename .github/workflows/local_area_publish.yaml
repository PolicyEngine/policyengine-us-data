name: Publish Local Area H5 Files

on:
  push:
    branches: [main]
    paths:
      - 'policyengine_us_data/datasets/cps/local_area_calibration/**'
      - '.github/workflows/local_area_publish.yaml'
  repository_dispatch:
    types: [calibration-updated]
  workflow_dispatch:

# Trigger strategy:
# 1. Automatic: Code changes to local_area_calibration/ pushed to main
# 2. repository_dispatch: Calibration workflow triggers after uploading new weights
# 3. workflow_dispatch: Manual trigger when you update weights/data on HF yourself

jobs:
  publish-local-area:
    runs-on: self-hosted
    permissions:
      contents: read
      id-token: write
    env:
      HUGGING_FACE_TOKEN: ${{ secrets.HUGGING_FACE_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/322898545428/locations/global/workloadIdentityPools/policyengine-research-id-pool/providers/prod-github-provider"
          service_account: "policyengine-research@policyengine-research.iam.gserviceaccount.com"

      - name: Install package
        run: uv pip install -e .[dev] --system

      - name: Download checkpoint (if exists)
        continue-on-error: true
        run: |
          gsutil cp gs://policyengine-us-data/checkpoints/completed_states.txt . || true
          gsutil cp gs://policyengine-us-data/checkpoints/completed_districts.txt . || true
          gsutil cp gs://policyengine-us-data/checkpoints/completed_cities.txt . || true

      - name: Build and publish local area H5 files
        run: make publish-local-area

      - name: Upload checkpoint
        if: always()
        run: |
          gsutil cp completed_states.txt gs://policyengine-us-data/checkpoints/ || true
          gsutil cp completed_districts.txt gs://policyengine-us-data/checkpoints/ || true
          gsutil cp completed_cities.txt gs://policyengine-us-data/checkpoints/ || true

      - name: Clean up checkpoints on success
        if: success()
        run: |
          gsutil rm gs://policyengine-us-data/checkpoints/completed_states.txt || true
          gsutil rm gs://policyengine-us-data/checkpoints/completed_districts.txt || true
          gsutil rm gs://policyengine-us-data/checkpoints/completed_cities.txt || true
