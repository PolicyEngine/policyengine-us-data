{"version":3,"kind":"Notebook","sha256":"a70db758ed54d3377121a8fb7c10accaf160cc1a74c73e25df7935b33f9dcf20","slug":"local-area-calibration-setup","location":"/local_area_calibration_setup.ipynb","dependencies":[],"frontmatter":{"title":"Local Area Calibration Setup","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","source_url":"https://github.com/policyengine/policyengine-us-data/blob/main/docs/local_area_calibration_setup.ipynb","edit_url":"https://github.com/policyengine/policyengine-us-data/edit/main/docs/local_area_calibration_setup.ipynb","exports":[{"format":"ipynb","filename":"local_area_calibration_setup.ipynb","url":"/policyengine-us-data/build/local_area_calibrati-9b5da00b3154bb3053f50d83636f97a2.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates the clone-based calibration pipeline: how raw CPS records become a calibration matrix and, ultimately, CD-level stacked datasets.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"T8ZraA5shm"}],"key":"aFD5R22MLB"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The paradigm shift from the old approach: instead of replicating every household into every congressional district, we ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"hhejogocJ1"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"clone","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"OKvqoAPCl8"}],"key":"iIcwoftlDH"},{"type":"text","value":" each record N times and assign each clone a ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"asHSfkhMsK"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"random census block","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"SJbBueIp3Q"}],"key":"Sje89NoMEW"},{"type":"text","value":" drawn from a population-weighted distribution. Each clone inherits a state, CD, and block — and gets re-simulated under the rules of its assigned state.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"sdD5qb8Mim"}],"key":"BnZ1fVpeIy"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We follow one household (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"HH1l4KUpnK"},{"type":"inlineCode","value":"record_idx=8629","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"adLq0Owbsf"},{"type":"text","value":", household_id 128694, SNAP $18,396) through the entire pipeline:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"HVShQivvvD"}],"key":"f0CbUwJo1j"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":8,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Clone and assign geography","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Cje8hfHBsW"}],"key":"eoqrw0bYzv"}],"key":"DdBng8mNyS"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Simulate under new state rules (","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"xmnhHRgvgD"},{"type":"inlineCode","value":"_simulate_clone","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"Hfd3qqqH40"},{"type":"text","value":")","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"I4YF2QJYVj"}],"key":"wpuekDZMhP"}],"key":"zXKTKnqn4P"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Geographic column masking","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"L7000E4AlY"}],"key":"D1MEfDXtsA"}],"key":"j3hihZMyJd"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Re-randomize takeup per census block","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"m3EOWkDqby"}],"key":"hdCuuNVmNd"}],"key":"WB4OPcoRFm"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Build the calibration matrix","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"dHduNF635n"}],"key":"XqtnScWc9Y"}],"key":"EmZoYB9IZO"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Create stacked datasets from calibrated weights","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"c48EZKfUCJ"}],"key":"YQBkE40vZB"}],"key":"HNdI9OraBq"}],"key":"eRq7rF8He7"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"strong","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Companion notebook:","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"nNbXtoACBl"}],"key":"vHPZvp6jKY"},{"type":"text","value":" ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"dSDE3jnONv"},{"type":"link","url":"/policyengine-us-data/build/calibration_matrix-d485e24e65a1cd23cb63714c81d7f6ef.ipynb","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"calibration​_matrix​.ipynb","key":"xSw4cosozY"}],"urlSource":"calibration_matrix.ipynb","static":true,"protocol":"file","key":"Ysg6cCvuWa"},{"type":"text","value":" covers the ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"gmGRAYSyk1"},{"type":"emphasis","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"finished","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"QthQ6iAUPn"}],"key":"x41a01teb7"},{"type":"text","value":" matrix — row/column anatomy, target groups, sparsity. This notebook covers the ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"mGt0yJxMol"},{"type":"emphasis","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"process","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"ydR0bh05vi"}],"key":"cEDkDLWL9D"},{"type":"text","value":" that creates it and what happens after (stacked datasets).","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"CGJqWLJu8A"}],"key":"a2M4VO30is"},{"type":"paragraph","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"strong","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Requirements:","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"NzaNAAtr4M"}],"key":"uA9iuS5gD4"},{"type":"text","value":" ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"H84lYq6ucc"},{"type":"inlineCode","value":"policy_data.db","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"SXx4Wo3ODj"},{"type":"text","value":", ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"Q6AWSojK9O"},{"type":"inlineCode","value":"block_cd_distributions.csv.gz","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"zsYPmPgiZh"},{"type":"text","value":", and the stratified CPS h5 file in ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"FrYdnoapQe"},{"type":"inlineCode","value":"STORAGE_FOLDER","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"r460L6Otlj"},{"type":"text","value":".","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"l33rdLXolg"}],"key":"vAHbxt0Wup"}],"key":"sy1VCmZIQj"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 1: Setup & Configuration","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JntUorMT87"}],"identifier":"section-1-setup-configuration","label":"Section 1: Setup & Configuration","html_id":"section-1-setup-configuration","implicit":true,"key":"ZgbPOrLgP2"}],"key":"UZZmGe7dkl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nimport pandas as pd\nfrom collections import defaultdict\n\nfrom policyengine_us import Microsimulation\nfrom policyengine_us_data.storage import STORAGE_FOLDER\nfrom policyengine_us_data.calibration.clone_and_assign import (\n    assign_random_geography,\n    GeographyAssignment,\n    load_global_block_distribution,\n)\nfrom policyengine_us_data.calibration.unified_matrix_builder import (\n    UnifiedMatrixBuilder,\n)\nfrom policyengine_us_data.calibration.unified_calibration import (\n    rerandomize_takeup,\n    SIMPLE_TAKEUP_VARS,\n)\nfrom policyengine_us_data.utils.randomness import seeded_rng\nfrom policyengine_us_data.parameters import load_take_up_rate\nfrom policyengine_us_data.datasets.cps.local_area_calibration.calibration_utils import (\n    get_calculated_variables,\n    STATE_CODES,\n    get_all_cds_from_database,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.stacked_dataset_builder import (\n    create_sparse_cd_stacked_dataset,\n)\n\ndb_path = STORAGE_FOLDER / \"calibration\" / \"policy_data.db\"\ndb_uri = f\"sqlite:///{db_path}\"\ndataset_path = str(STORAGE_FOLDER / \"stratified_extended_cps_2024.h5\")\n\nN_CLONES = 3\nSEED = 42","key":"i1GbRffg7p"},{"type":"outputs","id":"7Jtc3qd8yMTJlWeE86ECk","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/home/baogorek/envs/sep/lib/python3.13/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html\n  from .autonotebook import tqdm as notebook_tqdm\n"},"children":[],"key":"JJtFGovbga"}],"key":"shsVsxLmKZ"}],"key":"rwLH6B2P2i"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim = Microsimulation(dataset=dataset_path)\nhh_ids = sim.calculate(\"household_id\", map_to=\"household\").values\nsnap_values = sim.calculate(\"snap\", map_to=\"household\").values\nn_records = len(hh_ids)\n\nrecord_idx = 8629  # High SNAP ($18k), lands in TX/PA/NY with seed=42\nexample_hh_id = hh_ids[record_idx]\nprint(f\"Base dataset: {n_records:,} households\")\nprint(\n    f\"Example household: record_idx={record_idx}, \"\n    f\"household_id={example_hh_id}, \"\n    f\"SNAP=${snap_values[record_idx]:,.2f}\"\n)","key":"AGvwhPWJ58"},{"type":"outputs","id":"Lisv7H1vkOBFNuAshjGzz","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Base dataset: 11,999 households\nExample household: record_idx=8629, household_id=128694, SNAP=$18,396.00\n"},"children":[],"key":"KKiEyhkV7N"}],"key":"aDl8p1vVrF"}],"key":"PhI70OglDq"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 2: Geography Assignment","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zdVhmXz5ws"}],"identifier":"section-2-geography-assignment","label":"Section 2: Geography Assignment","html_id":"section-2-geography-assignment","implicit":true,"key":"hpf9TPQfR3"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"assign_random_geography","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dEBHoRpCBD"},{"type":"text","value":" creates ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CfVgp8OyPv"},{"type":"inlineCode","value":"n_records * n_clones","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nixBF7Nnc1"},{"type":"text","value":" total records, each assigned a random census block from a population-weighted distribution. State and CD are derived from the block GEOID. The result is a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"P2st2rteMT"},{"type":"inlineCode","value":"GeographyAssignment","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"a9s0meupwS"},{"type":"text","value":" dataclass with arrays indexed as ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cYiPNFuY2H"},{"type":"inlineCode","value":"clone_idx * n_records + record_idx","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jmDMRiS192"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WUYiMTmVwT"}],"key":"nxAGLnDKfd"}],"key":"XxJWF74j0d"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"geography = assign_random_geography(n_records, n_clones=N_CLONES, seed=SEED)\nn_total = n_records * N_CLONES\n\nprint(f\"Total cloned records: {n_total:,}\")\nprint(f\"Unique states: {len(np.unique(geography.state_fips))}\")\nprint(f\"Unique CDs: {len(np.unique(geography.cd_geoid))}\")\nprint(f\"Unique blocks: {len(np.unique(geography.block_geoid))}\")","key":"X2pYsZBthX"},{"type":"outputs","id":"rIPrjtqW7vCxRh_v-uwbZ","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Total cloned records: 35,997\nUnique states: 50\nUnique CDs: 435\nUnique blocks: 35508\n"},"children":[],"key":"Q2o6ZJcSUh"}],"key":"LG40tbx3HD"}],"key":"v9kuzBXRJC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\n    f\"Example household (record_idx={record_idx}) across {N_CLONES} clones:\\n\"\n)\nrows = []\nfor c in range(N_CLONES):\n    col = c * n_records + record_idx\n    rows.append(\n        {\n            \"clone\": c,\n            \"col\": col,\n            \"state_fips\": geography.state_fips[col],\n            \"abbr\": STATE_CODES.get(geography.state_fips[col], \"??\"),\n            \"cd_geoid\": geography.cd_geoid[col],\n            \"block_geoid\": geography.block_geoid[col],\n        }\n    )\npd.DataFrame(rows)","key":"Ajn2nqITNm"},{"type":"outputs","id":"2mqOBngaAnoQ15hvUZH9n","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Example household (record_idx=8629) across 3 clones:\n\n"},"children":[],"key":"SWIv8T9B5L"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>clone</th>\n      <th>col</th>\n      <th>state_fips</th>\n      <th>abbr</th>\n      <th>cd_geoid</th>\n      <th>block_geoid</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>8629</td>\n      <td>48</td>\n      <td>TX</td>\n      <td>4817</td>\n      <td>481450004002026</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1</td>\n      <td>20628</td>\n      <td>42</td>\n      <td>PA</td>\n      <td>4201</td>\n      <td>420171058013029</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>2</td>\n      <td>32627</td>\n      <td>36</td>\n      <td>NY</td>\n      <td>3611</td>\n      <td>360850208041023</td>\n    </tr>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"   clone    col  state_fips abbr cd_geoid      block_geoid\n0      0   8629          48   TX     4817  481450004002026\n1      1  20628          42   PA     4201  420171058013029\n2      2  32627          36   NY     3611  360850208041023","content_type":"text/plain"}}},"children":[],"key":"Jfk9L07PZR"}],"key":"DXvqV7aYD1"}],"key":"i9zGofHNN3"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"One household, three parallel geographic identities. Each clone will be simulated under different state rules, producing different benefit amounts.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EgzVEJoYpx"}],"key":"ah0fe5q5Ao"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Note:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CaHsiAJ36e"}],"key":"Ys0kbdya4B"},{"type":"text","value":" With only N_CLONES=3 (~36K total samples), small-population areas like DC may not appear in the random draw. The production pipeline uses N_CLONES=10, which covers all 51 state-equivalents and 436 CDs.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"SGIqwRvEnU"}],"key":"r3dgNChKJf"}],"key":"WhL7zjnmsy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"blocks, cds, states, probs = load_global_block_distribution()\nprint(f\"Global block distribution: {len(blocks):,} blocks\")\nprint(f\"Top 5 states by total probability:\")\nstate_prob = pd.Series(probs, index=states).groupby(level=0).sum()\ntop5 = state_prob.nlargest(5)\nfor fips, p in top5.items():\n    print(f\"  {STATE_CODES.get(fips, '??')} ({fips}): {p:.3%}\")","key":"r1Pco9RSlI"},{"type":"outputs","id":"MD98miXjbLKvMCGYJXZk8","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Global block distribution: 5,765,442 blocks\nTop 5 states by total probability:\n  CA (6): 11.954%\n  TX (48): 8.736%\n  FL (12): 6.437%\n  NY (36): 5.977%\n  PA (42): 3.908%\n"},"children":[],"key":"aazysmOTIY"}],"key":"PZDQLoIw2z"}],"key":"D4VQTb7D7s"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 3: Inside ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Da2g5lhS4A"},{"type":"inlineCode","value":"_simulate_clone","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qCO34HdfO5"},{"type":"text","value":" — State-Swap","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PZknkCj13x"}],"identifier":"section-3-inside-simulate-clone-state-swap","label":"Section 3: Inside _simulate_clone — State-Swap","html_id":"section-3-inside-simulate-clone-state-swap","implicit":true,"key":"WENxsMtqN7"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"For each clone, ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FepJdN2Ztg"},{"type":"inlineCode","value":"_simulate_clone","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mYM4Y5zGuj"},{"type":"text","value":" does four things:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yVgcnjMBT1"}],"key":"C3ayYesw5i"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Creates a ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"emgNqxeXsW"},{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"fresh","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"bqVrfkM87v"}],"key":"UQNoeg41RP"},{"type":"text","value":" ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Xmko6yH0bc"},{"type":"inlineCode","value":"Microsimulation","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"PTpHNmwBxy"},{"type":"text","value":" from the base dataset","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"alLSutRaoF"}],"key":"gzfE8vSCOn"}],"key":"SfAlgusxVK"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Overwrites ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KL1c8ofKww"},{"type":"inlineCode","value":"state_fips","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"SDCzLi56pV"},{"type":"text","value":" with the clone’s assigned states","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"SbKKMQ6deW"}],"key":"gft5VF6t8P"}],"key":"frdxDOkKPE"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Optionally calls a ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"KnV10Q9vxv"},{"type":"inlineCode","value":"sim_modifier","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ZVfkfWNsna"},{"type":"text","value":" (e.g., takeup re-randomization)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"NQExnuXyFV"}],"key":"MhIOEAXntw"}],"key":"dCU8Cf3N0w"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Clears cached formulas","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"RqWhDnee6h"}],"key":"T3RqZ6fV05"},{"type":"text","value":" via ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lqrkwbwatt"},{"type":"inlineCode","value":"get_calculated_variables","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"qv1nq6CIWt"},{"type":"text","value":" — preserving survey inputs and IDs while forcing recalculation of state-dependent variables like SNAP","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"MuAxGCpM2L"}],"key":"WHhDuSuGYC"}],"key":"dWbSr4WxLr"}],"key":"tGehiQre2F"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Let’s reproduce this manually for clone 0.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"C2CYynizMG"}],"key":"PtxfZvc4gp"}],"key":"zldfTrjtCC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"clone_idx = 0\ncol_start = clone_idx * n_records\ncol_end = col_start + n_records\nclone_states = geography.state_fips[col_start:col_end]\n\nclone_sim = Microsimulation(dataset=dataset_path)\nclone_sim.set_input(\"state_fips\", 2024, clone_states.astype(np.int32))\nfor var in get_calculated_variables(clone_sim):\n    clone_sim.delete_arrays(var)\n\nnew_snap = clone_sim.calculate(\"snap\", map_to=\"household\").values\n\norig_state = sim.calculate(\"state_fips\", map_to=\"household\").values[record_idx]\nnew_state = clone_states[record_idx]\n\nprint(f\"Example household (record_idx={record_idx}):\")\nprint(\n    f\"  Original state: {STATE_CODES.get(int(orig_state), '??')} \"\n    f\"({int(orig_state)})\"\n)\nprint(\n    f\"  Clone 0 state:  {STATE_CODES.get(int(new_state), '??')} \"\n    f\"({int(new_state)})\"\n)\nprint(f\"  Original SNAP:  ${snap_values[record_idx]:,.2f}\")\nprint(f\"  Clone 0 SNAP:   ${new_snap[record_idx]:,.2f}\")","key":"QOxab4kory"},{"type":"outputs","id":"m4qsDyqT8wjjVHabLjDtF","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Example household (record_idx=8629):\n  Original state: NC (37)\n  Clone 0 state:  TX (48)\n  Original SNAP:  $18,396.00\n  Clone 0 SNAP:   $18,396.00\n"},"children":[],"key":"UjBUCodkYN"}],"key":"SGpFObpjki"}],"key":"w3I52jvEqo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f\"SNAP for record_idx={record_idx} across all {N_CLONES} clones:\\n\")\nrows = []\nfor c in range(N_CLONES):\n    cs = geography.state_fips[c * n_records + record_idx]\n    s = Microsimulation(dataset=dataset_path)\n    s.set_input(\n        \"state_fips\",\n        2024,\n        geography.state_fips[c * n_records : (c + 1) * n_records].astype(\n            np.int32\n        ),\n    )\n    for var in get_calculated_variables(s):\n        s.delete_arrays(var)\n    clone_snap = s.calculate(\"snap\", map_to=\"household\").values\n    rows.append(\n        {\n            \"clone\": c,\n            \"state\": STATE_CODES.get(int(cs), \"??\"),\n            \"state_fips\": int(cs),\n            \"SNAP\": f\"${clone_snap[record_idx]:,.2f}\",\n        }\n    )\npd.DataFrame(rows)","key":"za6frjcLlr"},{"type":"outputs","id":"6KumZu244wEqngVFtIpHU","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"SNAP for record_idx=8629 across all 3 clones:\n\n"},"children":[],"key":"pNDQSlnS5L"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>clone</th>\n      <th>state</th>\n      <th>state_fips</th>\n      <th>SNAP</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>TX</td>\n      <td>48</td>\n      <td>$18,396.00</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1</td>\n      <td>PA</td>\n      <td>42</td>\n      <td>$18,396.00</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>2</td>\n      <td>NY</td>\n      <td>36</td>\n      <td>$18,396.00</td>\n    </tr>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"   clone state  state_fips        SNAP\n0      0    TX          48  $18,396.00\n1      1    PA          42  $18,396.00\n2      2    NY          36  $18,396.00","content_type":"text/plain"}}},"children":[],"key":"S0EKMn2VTx"}],"key":"Drs4JdOlyb"}],"key":"N4IwqCwonA"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"get_calculated_variables","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ijfojS9Y6U"},{"type":"text","value":" is selective: it identifies variables with formulas (state-dependent computations) while preserving survey-reported inputs and entity IDs. This is what allows the same demographic household to produce different benefit amounts under different state rules.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cVldavUay8"}],"key":"TdCzgYln5u"}],"key":"xkilOj4dqg"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 4: Geographic Column Masking","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FqKlUqD8I2"}],"identifier":"section-4-geographic-column-masking","label":"Section 4: Geographic Column Masking","html_id":"section-4-geographic-column-masking","implicit":true,"key":"mI8Ftw2H2n"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When assembling the calibration matrix, each target row only “sees” columns (clones) whose geography matches the target’s geography. This is implemented via ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Z8wqiTjAWD"},{"type":"inlineCode","value":"state_to_cols","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jSRjO1kic6"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"b4v85Yth3g"},{"type":"inlineCode","value":"cd_to_cols","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yTF0mQ2LjF"},{"type":"text","value":" dictionaries built from the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LkS3GIPaEt"},{"type":"inlineCode","value":"GeographyAssignment","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oFB8oCrWvQ"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bPtUd6ZfdY"}],"key":"QB25qN8mdW"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"This is step 3 of ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"sO0a9Xw4JL"},{"type":"inlineCode","value":"build_matrix","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"CSoHQqgCFb"},{"type":"text","value":" — reproduced here for transparency.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KuuQsHKa9l"}],"key":"Dt2aQGWoWZ"}],"key":"n8gw9ak3Jx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"state_col_lists = defaultdict(list)\ncd_col_lists = defaultdict(list)\nfor col in range(n_total):\n    state_col_lists[int(geography.state_fips[col])].append(col)\n    cd_col_lists[str(geography.cd_geoid[col])].append(col)\n\nstate_to_cols = {s: np.array(c) for s, c in state_col_lists.items()}\ncd_to_cols = {cd: np.array(c) for cd, c in cd_col_lists.items()}\n\nprint(f\"Unique states mapped: {len(state_to_cols)}\")\nprint(f\"Unique CDs mapped: {len(cd_to_cols)}\")\n\nstate_counts = {s: len(c) for s, c in state_to_cols.items()}\nsc_series = pd.Series(state_counts)\nprint(\n    f\"\\nColumns per state: min={sc_series.min()}, \"\n    f\"median={sc_series.median():.0f}, max={sc_series.max()}\"\n)","key":"olPVdYHGYC"},{"type":"outputs","id":"-QK4LEF5katrQLyR2sqA0","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Unique states mapped: 50\nUnique CDs mapped: 435\n\nColumns per state: min=62, median=494, max=4311\n"},"children":[],"key":"AWdIp78UhS"}],"key":"MEcLZFTcAx"}],"key":"ZJyFXsOEoA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f\"Example household clone visibility:\\n\")\nfor c in range(N_CLONES):\n    col = c * n_records + record_idx\n    state = int(geography.state_fips[col])\n    cd = str(geography.cd_geoid[col])\n    abbr = STATE_CODES.get(state, \"??\")\n    print(f\"Clone {c} ({abbr}, CD {cd}):\")\n    print(\n        f\"  Visible to {abbr} state targets: \"\n        f\"col {col} in state_to_cols[{state}]? \"\n        f\"{col in state_to_cols.get(state, [])}\"\n    )\n    print(\n        f\"  Visible to CD {cd} targets: \"\n        f\"col {col} in cd_to_cols['{cd}']? \"\n        f\"{col in cd_to_cols.get(cd, [])}\"\n    )\n    # Check an unrelated state\n    print(\n        f\"  Visible to NC (37) targets: \" f\"{col in state_to_cols.get(37, [])}\"\n    )\n    print()","key":"Y1TSWa7KFM"},{"type":"outputs","id":"D0sPGRNCXZmhqJT26PowE","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Example household clone visibility:\n\nClone 0 (TX, CD 4817):\n  Visible to TX state targets: col 8629 in state_to_cols[48]? True\n  Visible to CD 4817 targets: col 8629 in cd_to_cols['4817']? True\n  Visible to NC (37) targets: False\n\nClone 1 (PA, CD 4201):\n  Visible to PA state targets: col 20628 in state_to_cols[42]? True\n  Visible to CD 4201 targets: col 20628 in cd_to_cols['4201']? True\n  Visible to NC (37) targets: False\n\nClone 2 (NY, CD 3611):\n  Visible to NY state targets: col 32627 in state_to_cols[36]? True\n  Visible to CD 3611 targets: col 32627 in cd_to_cols['3611']? True\n  Visible to NC (37) targets: False\n\n"},"children":[],"key":"XJasiBij2R"}],"key":"tKMfdQJN50"}],"key":"cuL68B6rCO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This is the mechanism behind the sparsity pattern in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ETFpbQx7y9"},{"type":"inlineCode","value":"calibration_matrix.ipynb","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uBbxTkzaXY"},{"type":"text","value":": a household clone assigned to TX can contribute to TX state targets and TX CD targets, but produces a zero entry for NC or AK targets. The matrix is sparse because each clone only intersects a small fraction of all geographic targets.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BxwDxy6ao7"}],"key":"eL2k345CM4"}],"key":"YvRhPgr0rW"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 5: Takeup Re-randomization","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"j0Jj2JJ1Zq"}],"identifier":"section-5-takeup-re-randomization","label":"Section 5: Takeup Re-randomization","html_id":"section-5-takeup-re-randomization","implicit":true,"key":"ls6b9f6xjg"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The base CPS has fixed takeup decisions (e.g., “this household takes up SNAP”). But when we clone a household into different census blocks, each block should have independently drawn takeup — otherwise every clone of a SNAP-participating household would still participate, regardless of geography.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"RHku7Wntly"}],"key":"qQULD40kRm"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"rerandomize_takeup","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yCwBaw617I"},{"type":"text","value":" solves this: for each census block, it uses ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"nIfKztNTMg"},{"type":"inlineCode","value":"seeded_rng(variable_name, salt=block_geoid)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"xPNxhbmSvJ"},{"type":"text","value":" to draw new takeup booleans. The seed is deterministic per (variable, block) pair, so results are reproducible.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"SE74fOEklD"}],"key":"t2dVjaMpiA"}],"key":"jF1zAOrGvL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f\"{len(SIMPLE_TAKEUP_VARS)} takeup variables:\\n\")\nfor spec in SIMPLE_TAKEUP_VARS:\n    rate_key = spec[\"rate_key\"]\n    if rate_key == \"voluntary_filing\":\n        rate = 0.05\n    else:\n        rate = load_take_up_rate(rate_key, 2024)\n    rate_str = (\n        f\"{rate:.2%}\"\n        if isinstance(rate, float)\n        else f\"dict ({len(rate)} entries)\"\n    )\n    print(\n        f\"  {spec['variable']:40s} \"\n        f\"entity={spec['entity']:10s} rate={rate_str}\"\n    )","key":"xp2EoZp6ch"},{"type":"outputs","id":"WZrI0WgdE7ePcynJmZd4_","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"8 takeup variables:\n\n  takes_up_snap_if_eligible                entity=spm_unit   rate=82.00%\n  takes_up_aca_if_eligible                 entity=tax_unit   rate=67.20%\n  takes_up_dc_ptc                          entity=tax_unit   rate=32.00%\n  takes_up_head_start_if_eligible          entity=person     rate=30.00%\n  takes_up_early_head_start_if_eligible    entity=person     rate=9.00%\n  takes_up_ssi_if_eligible                 entity=person     rate=50.00%\n  would_file_taxes_voluntarily             entity=tax_unit   rate=5.00%\n  takes_up_medicaid_if_eligible            entity=person     rate=dict (51 entries)\n"},"children":[],"key":"x79zIPT6Lu"}],"key":"U3TW7hGNqO"}],"key":"NkPH7UETs0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"block_a = \"482011234567890\"\nblock_b = \"170311234567890\"\nvar = \"takes_up_snap_if_eligible\"\n\nrng_a1 = seeded_rng(var, salt=block_a)\nrng_a2 = seeded_rng(var, salt=block_a)\nrng_b = seeded_rng(var, salt=block_b)\nrng_other = seeded_rng(\"takes_up_aca_if_eligible\", salt=block_a)\n\ndraws_a1 = rng_a1.random(5)\ndraws_a2 = rng_a2.random(5)\ndraws_b = rng_b.random(5)\ndraws_other = rng_other.random(5)\n\nprint(\"Same block + same var (reproducible):\")\nprint(f\"  {draws_a1}\")\nprint(f\"  {draws_a2}\")\nprint(f\"  Match: {np.allclose(draws_a1, draws_a2)}\")\nprint(f\"\\nDifferent block, same var:\")\nprint(f\"  {draws_b}\")\nprint(f\"  Match: {np.allclose(draws_a1, draws_b)}\")\nprint(f\"\\nSame block, different var:\")\nprint(f\"  {draws_other}\")\nprint(f\"  Match: {np.allclose(draws_a1, draws_other)}\")","key":"kTVMBCAoyA"},{"type":"outputs","id":"s32pzmRhsO45sNidsapLN","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Same block + same var (reproducible):\n  [0.50514599 0.75213437 0.9703409  0.18048868 0.31969517]\n  [0.50514599 0.75213437 0.9703409  0.18048868 0.31969517]\n  Match: True\n\nDifferent block, same var:\n  [0.15503168 0.96707026 0.79019745 0.67544525 0.85245009]\n  Match: False\n\nSame block, different var:\n  [0.93155876 0.8912794  0.50838888 0.32192278 0.01005173]\n  Match: False\n"},"children":[],"key":"JrpU64slNo"}],"key":"aRXaLZ1nqw"}],"key":"A9LcZ4H1Q8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"test_sim = Microsimulation(dataset=dataset_path)\nclone_0_states = geography.state_fips[:n_records]\nclone_0_blocks = geography.block_geoid[:n_records]\ntest_sim.set_input(\"state_fips\", 2024, clone_0_states.astype(np.int32))\n\nbefore = {}\nfor spec in SIMPLE_TAKEUP_VARS:\n    v = spec[\"variable\"]\n    vals = test_sim.calculate(v, map_to=spec[\"entity\"]).values\n    before[v] = vals.mean()\n\nrerandomize_takeup(test_sim, clone_0_blocks, clone_0_states, 2024)\n\nprint(\"Takeup rates before/after re-randomization (clone 0):\\n\")\nfor spec in SIMPLE_TAKEUP_VARS:\n    v = spec[\"variable\"]\n    vals = test_sim.calculate(v, map_to=spec[\"entity\"]).values\n    after = vals.mean()\n    print(f\"  {v:40s} before={before[v]:.3%}  after={after:.3%}\")","key":"MbSxPboqzy"},{"type":"outputs","id":"4BI5VP8Xu7ybKO1rOOP3P","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Takeup rates before/after re-randomization (clone 0):\n\n  takes_up_snap_if_eligible                before=82.333%  after=82.381%\n  takes_up_aca_if_eligible                 before=66.718%  after=67.486%\n  takes_up_dc_ptc                          before=31.483%  after=32.044%\n  takes_up_head_start_if_eligible          before=29.963%  after=29.689%\n  takes_up_early_head_start_if_eligible    before=8.869%  after=8.721%\n  takes_up_ssi_if_eligible                 before=100.000%  after=49.776%\n  would_file_taxes_voluntarily             before=0.000%  after=4.905%\n  takes_up_medicaid_if_eligible            before=84.496%  after=80.051%\n"},"children":[],"key":"DWoQEsUN0Z"}],"key":"StWHB638wr"}],"key":"BfRN4s1pLv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"medicaid_rates = load_take_up_rate(\"medicaid\", 2024)\nprint(\"Medicaid takeup rates (state-specific), first 10 states:\\n\")\nfor state, rate in sorted(medicaid_rates.items())[:10]:\n    print(f\"  {state}: {rate:.2%}\")","key":"Bmzspx5v88"},{"type":"outputs","id":"OMHeE24xTcf3GwK5unTJS","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Medicaid takeup rates (state-specific), first 10 states:\n\n  AK: 88.00%\n  AL: 92.00%\n  AR: 79.00%\n  AZ: 95.00%\n  CA: 78.00%\n  CO: 99.00%\n  CT: 89.00%\n  DC: 99.00%\n  DE: 86.00%\n  FL: 98.00%\n"},"children":[],"key":"OvkcAlBCo0"}],"key":"pOQfIuWMip"}],"key":"KMQA67x0am"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"In the full pipeline, ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zC3g7aiFeP"},{"type":"inlineCode","value":"rerandomize_takeup","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ORyEgulacS"},{"type":"text","value":" is passed to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"p4704NtWY1"},{"type":"inlineCode","value":"build_matrix","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"X0tMDHYtsP"},{"type":"text","value":" as a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xUqBICxuYY"},{"type":"inlineCode","value":"sim_modifier","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"k0NE8q9ax1"},{"type":"text","value":" callback. For each clone, after ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AkSrLzPGic"},{"type":"inlineCode","value":"state_fips","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GJNviOr0Qw"},{"type":"text","value":" is set but before formula caches are cleared, the callback draws new takeup booleans per census block. This means the same household in block A might take up SNAP while in block B it doesn’t — matching the statistical reality that takeup varies by geography.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aOoziEpGV8"}],"key":"lAowtEgPda"}],"key":"X6K5HV1pxp"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 6: Matrix Build Verification","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CYvQsJY2TS"}],"identifier":"section-6-matrix-build-verification","label":"Section 6: Matrix Build Verification","html_id":"section-6-matrix-build-verification","implicit":true,"key":"IarRhZssum"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Let’s run the full ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"F4z2muPizs"},{"type":"inlineCode","value":"build_matrix","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"c1HQ9qCH5w"},{"type":"text","value":" pipeline and verify the example household’s pattern matches our Section 4 predictions. We use the same ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"X6aFkqAOxx"},{"type":"inlineCode","value":"target_filter","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nn1Eg6rcRv"},{"type":"text","value":" as in ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"P8EclaBMVs"},{"type":"inlineCode","value":"calibration_matrix.ipynb","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GDe0wDfW1b"},{"type":"text","value":" but ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XU7okNG075"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"without","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NfgXfdLksI"}],"key":"mtLBiPqz0j"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DwhGel6cQa"},{"type":"inlineCode","value":"sim_modifier","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"x4WW3tNPs9"},{"type":"text","value":" to match that notebook’s output.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"y7XLPLkGsV"}],"key":"Dnp3XshH7F"}],"key":"l5qX2gvanj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"builder = UnifiedMatrixBuilder(\n    db_uri=db_uri,\n    time_period=2024,\n    dataset_path=dataset_path,\n)\n\ntargets_df, X_sparse, target_names = builder.build_matrix(\n    geography,\n    sim,\n    target_filter={\"domain_variables\": [\"snap\"]},\n)\n\nprint(f\"Matrix shape: {X_sparse.shape}\")\nprint(f\"Non-zero entries: {X_sparse.nnz:,}\")\nprint(f\"Density: {X_sparse.nnz / (X_sparse.shape[0] * X_sparse.shape[1]):.6f}\")","key":"LpmuY66KuS"},{"type":"outputs","id":"bzFOkwFevSWUBVIg84Bh-","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2026-02-13 17:11:22,384 - INFO - Processing clone 1/3 (cols 0-11998, 50 unique states)...\n2026-02-13 17:11:23,509 - INFO - Processing clone 2/3 (cols 11999-23997, 50 unique states)...\n2026-02-13 17:11:24,645 - INFO - Processing clone 3/3 (cols 23998-35996, 50 unique states)...\n2026-02-13 17:11:25,769 - INFO - Assembling matrix from 3 clones...\n2026-02-13 17:11:25,771 - INFO - Matrix: 538 targets x 35997 cols, 14946 nnz\n"},"children":[],"key":"OwtjG8Wxwz"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Matrix shape: (538, 35997)\nNon-zero entries: 14,946\nDensity: 0.000772\n"},"children":[],"key":"d3fd6CabJo"}],"key":"x6DZy73pP7"}],"key":"WrSs8l4c0r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f\"Example household non-zero pattern across clones:\\n\")\nfor c in range(N_CLONES):\n    col = c * n_records + record_idx\n    col_vec = X_sparse[:, col]\n    nz_rows = col_vec.nonzero()[0]\n    state = int(geography.state_fips[col])\n    cd = geography.cd_geoid[col]\n    abbr = STATE_CODES.get(state, \"??\")\n    print(f\"Clone {c} ({abbr}, CD {cd}): {len(nz_rows)} non-zero rows\")\n    for r in nz_rows:\n        row = targets_df.iloc[r]\n        print(\n            f\"  row {r}: {row['variable']} \"\n            f\"(geo={row['geographic_id']}): \"\n            f\"{X_sparse[r, col]:.2f}\"\n        )","key":"H1477NBU6o"},{"type":"outputs","id":"aV-4ycCLY3s4N8SZxMJY2","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Example household non-zero pattern across clones:\n\nClone 0 (TX, CD 4817): 3 non-zero rows\n  row 39: household_count (geo=48): 1.00\n  row 90: snap (geo=48): 18396.00\n  row 410: household_count (geo=4817): 1.00\nClone 1 (PA, CD 4201): 3 non-zero rows\n  row 34: household_count (geo=42): 1.00\n  row 85: snap (geo=42): 18396.00\n  row 358: household_count (geo=4201): 1.00\nClone 2 (NY, CD 3611): 3 non-zero rows\n  row 27: household_count (geo=36): 1.00\n  row 78: snap (geo=36): 18396.00\n  row 292: household_count (geo=3611): 1.00\n"},"children":[],"key":"yTkTzdeXqs"}],"key":"mjfOLd4gxg"}],"key":"j9NvtRWp7e"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 7: From Weights to Datasets","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xiTAgVOkxF"}],"identifier":"section-7-from-weights-to-datasets","label":"Section 7: From Weights to Datasets","html_id":"section-7-from-weights-to-datasets","implicit":true,"key":"GQ8Prfu6aa"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"create_sparse_cd_stacked_dataset","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YFRWwFxpJO"},{"type":"text","value":" takes calibrated weights and builds an h5 file with only the non-zero-weight households, reindexed per CD. Internally it does its own state-swap simulation — loading the base dataset, assigning ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZasUf5kTph"},{"type":"inlineCode","value":"state_fips","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yFjg01C0Kh"},{"type":"text","value":" for the target CD’s state, and recalculating benefits from scratch. This means SNAP values in the output reflect the destination state’s rules (e.g., a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TUzwDVqfZ7"},{"type":"inlineMath","value":"70 SNAP household from ME may get ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>70</mn><mi>S</mi><mi>N</mi><mi>A</mi><mi>P</mi><mi>h</mi><mi>o</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>h</mi><mi>o</mi><mi>l</mi><mi>d</mi><mi>f</mi><mi>r</mi><mi>o</mi><mi>m</mi><mi>M</mi><mi>E</mi><mi>m</mi><mi>a</mi><mi>y</mi><mi>g</mi><mi>e</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">70 SNAP household from ME may get </annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\">70</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">SN</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">se</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">df</span><span class=\"mord mathnormal\">ro</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">ME</span><span class=\"mord mathnormal\">ma</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">t</span></span></span></span>","key":"mEkFslBNuA"},{"type":"text","value":"0 under AK rules).","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WtaDYqXwz0"}],"key":"OBniFIlUr1"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Format gap:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rxD80QAZVh"}],"key":"V8XPHPmbug"},{"type":"text","value":" The calibration produces weights in clone layout ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"jm7jHpDGRm"},{"type":"inlineCode","value":"(n_records * n_clones,)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"EQDxq8i5MY"},{"type":"text","value":" where each clone maps to one specific CD via the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"awM9bM5ou0"},{"type":"inlineCode","value":"GeographyAssignment","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dtRo77Zose"},{"type":"text","value":". The stacked dataset builder expects CD layout ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"lk4FfsiOlW"},{"type":"inlineCode","value":"(n_cds * n_households,)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"U0wkHFNybP"},{"type":"text","value":" where every CD has a weight slot for every household. Converting between these — accumulating clone weights into their assigned CDs — is a separate step not yet implemented. The demo below constructs artificial CD-layout weights directly to show how the builder works.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"awyPDYPlQS"}],"key":"NVDgEZdssq"}],"key":"cib2q1uVBP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"Dimension mismatch:\")\nprint(\n    f\"  Calibration output: ({n_records} * {N_CLONES},) \"\n    f\"= {n_records * N_CLONES:,} (clone layout)\"\n)\n\nall_cds = get_all_cds_from_database(db_uri)\nn_cds = len(all_cds)\nprint(\n    f\"  Stacked builder expects: ({n_cds} * {n_records},) \"\n    f\"= {n_cds * n_records:,} (CD layout)\"\n)","key":"dshvn1PR8f"},{"type":"outputs","id":"dI0mBrRBqGU_vXb1uPoqs","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Dimension mismatch:\n  Calibration output: (11999 * 3,) = 35,997 (clone layout)\n  Stacked builder expects: (436 * 11999,) = 5,231,564 (CD layout)\n"},"children":[],"key":"gSZaBkWJ7Q"}],"key":"rdWQditnjs"}],"key":"rRGHClAFAs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\n\ndemo_cds = [\"3701\", \"201\"]\nn_demo_cds = len(demo_cds)\n\nw = (\n    np.random.default_rng(42)\n    .binomial(n=1, p=0.01, size=n_demo_cds * n_records)\n    .astype(float)\n)\n\n# Seed our example household into both CDs\ncd_idx_3701 = demo_cds.index(\"3701\")\nw[cd_idx_3701 * n_records + record_idx] = 2.5\n\ncd_idx_201 = demo_cds.index(\"201\")\nw[cd_idx_201 * n_records + record_idx] = 3.5\n\noutput_dir = \"calibration_output\"\nos.makedirs(output_dir, exist_ok=True)\noutput_path = os.path.join(output_dir, \"results.h5\")\n\nprint(\n    f\"Weight vector: {len(w):,} entries \"\n    f\"({n_demo_cds} CDs x {n_records:,} HH)\"\n)\nprint(f\"Non-zero weights: {(w > 0).sum()}\")\nprint(\n    f\"Example HH weight in CD 3701: {w[cd_idx_3701 * n_records + record_idx]}\"\n)\nprint(f\"Example HH weight in CD 201: {w[cd_idx_201 * n_records + record_idx]}\")","key":"aScTc8uupK"},{"type":"outputs","id":"x-egxmSyCh3iX4mGocDhq","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Weight vector: 23,998 entries (2 CDs x 11,999 HH)\nNon-zero weights: 277\nExample HH weight in CD 3701: 2.5\nExample HH weight in CD 201: 3.5\n"},"children":[],"key":"G5Jru1irhW"}],"key":"oHsJAZHenE"}],"key":"GxkalB3WVY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"create_sparse_cd_stacked_dataset(\n    w,\n    demo_cds,\n    cd_subset=demo_cds,\n    dataset_path=dataset_path,\n    output_path=output_path,\n)","key":"LrlutiwBli"},{"type":"outputs","id":"vqKHvpHpmEFUbuQ9eBnJI","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Processing subset of 2 CDs: 3701, 201...\nOutput path: calibration_output/results.h5\n\nOriginal dataset has 11,999 households\nExtracted weights for 2 CDs from full weight matrix\nTotal active household-CD pairs: 277\nTotal weight in W matrix: 281\nProcessing CD 201 (2/2)...\n"},"children":[],"key":"Jgut0sjDzB"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2026-02-13 17:11:40,873 - INFO - HTTP Request: GET https://huggingface.co/api/models/policyengine/policyengine-us-data \"HTTP/1.1 200 OK\"\n2026-02-13 17:11:40,899 - INFO - HTTP Request: HEAD https://huggingface.co/policyengine/policyengine-us-data/resolve/main/enhanced_cps_2024.h5 \"HTTP/1.1 302 Found\"\nWarning: You are sending unauthenticated requests to the HF Hub. Please set a HF_TOKEN to enable higher rate limits and faster downloads.\n2026-02-13 17:11:40,899 - WARNING - Warning: You are sending unauthenticated requests to the HF Hub. Please set a HF_TOKEN to enable higher rate limits and faster downloads.\n"},"children":[],"key":"K8iqgLsY6o"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\nCombining 2 CD DataFrames...\nTotal households across all CDs: 277\nCombined DataFrame shape: (726, 222)\n\nReindexing all entity IDs using 25k ranges per CD...\n  Created 277 unique households across 2 CDs\n  Reindexing persons using 25k ranges...\n  Reindexing tax units...\n  Reindexing SPM units...\n  Reindexing marital units...\n  Reindexing families...\n  Final persons: 726\n  Final households: 277\n  Final tax units: 373\n  Final SPM units: 291\n  Final marital units: 586\n  Final families: 309\n\nWeights in combined_df AFTER reindexing:\n  HH weight sum: 0.00M\n  Person weight sum: 0.00M\n  Ratio: 1.00\n\nOverflow check:\n  Max person ID after reindexing: 5,025,335\n  Max person ID × 100: 502,533,500\n  int32 max: 2,147,483,647\n  ✓ No overflow risk!\n\nCreating Dataset from combined DataFrame...\nBuilding simulation from Dataset...\n\nSaving to calibration_output/results.h5...\nFound 175 input variables to save\nVariables saved: 218\nVariables skipped: 3763\nSparse CD-stacked dataset saved successfully!\nHousehold mapping saved to calibration_output/mappings/results_household_mapping.csv\n\nVerifying saved file...\n  Final households: 277\n  Final persons: 726\n  Total population (from household weights): 281\n"},"children":[],"key":"BTt2BqKFsr"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":18,"metadata":{},"data":{"text/plain":{"content":"'calibration_output/results.h5'","content_type":"text/plain"}}},"children":[],"key":"RijaTlcmLw"}],"key":"zk96Mu3I99"}],"key":"i0y35WgjFK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim_after = Microsimulation(dataset=f\"./{output_path}\")\nhh_after_df = pd.DataFrame(\n    sim_after.calculate_dataframe(\n        [\n            \"household_id\",\n            \"congressional_district_geoid\",\n            \"household_weight\",\n            \"state_fips\",\n            \"snap\",\n        ]\n    )\n)\nprint(f\"Stacked dataset: {len(hh_after_df)} households\\n\")\n\nmapping_df = pd.read_csv(\n    f\"{output_dir}/mappings/results_household_mapping.csv\"\n)\nexample_mapping = mapping_df.loc[\n    mapping_df.original_household_id == example_hh_id\n]\nprint(f\"Example household (original_id={example_hh_id}) \" f\"in mapping:\\n\")\nprint(example_mapping.to_string(index=False))\n\nnew_ids = example_mapping.new_household_id\nprint(f\"\\nIn stacked dataset:\\n\")\nprint(\n    hh_after_df.loc[hh_after_df.household_id.isin(new_ids)].to_string(\n        index=False\n    )\n)","key":"akVpEhPyer"},{"type":"outputs","id":"up7O8tkInmgcZc3BAhkTk","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Stacked dataset: 277 households\n\nExample household (original_id=128694) in mapping:\n\n new_household_id  original_household_id  congressional_district  state_fips\n              108                 128694                     201           2\n            25097                 128694                    3701          37\n\nIn stacked dataset:\n\n household_id  congressional_district_geoid  household_weight  state_fips    snap\n          108                           201               3.5           2 23640.0\n        25097                          3701               2.5          37 18396.0\n"},"children":[],"key":"UjQS2uvKs9"}],"key":"yEkDFSVqoc"}],"key":"HeHxxCp0WV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import shutil\n\nshutil.rmtree(output_dir)\nprint(f\"Cleaned up {output_dir}/\")","key":"k6VWBra1VM"},{"type":"outputs","id":"mJerH_LZuavkbv6WmKtwn","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Cleaned up calibration_output/\n"},"children":[],"key":"JNAtRigq7a"}],"key":"ZXSnvmcd4V"}],"key":"KyTQ7R0ewX"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Summary","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Xu9NLOllLD"}],"identifier":"summary","label":"Summary","html_id":"summary","implicit":true,"key":"TELnIIibSR"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The clone-based calibration pipeline has six stages:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xEDkT37PCi"}],"key":"qzwOafFa5z"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Clone + assign geography","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"h5BqYYjBgN"}],"key":"aCiWMbTTU3"},{"type":"text","value":" — ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"n4mI1mb1Ga"},{"type":"inlineCode","value":"assign_random_geography()","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GxydLC9oBC"},{"type":"text","value":" creates N copies of each CPS record, each with a population-weighted random census block.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"amtEWmQOZg"}],"key":"O8t1PDbgYa"}],"key":"guySoc8ZYH"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Simulate","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"FTDJ9hQHO5"}],"key":"BwVZHaV6jl"},{"type":"text","value":" — ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"DP017pWYEB"},{"type":"inlineCode","value":"_simulate_clone()","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"iXvUvtjIPu"},{"type":"text","value":" sets each clone’s ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"WKnMO9wZ3w"},{"type":"inlineCode","value":"state_fips","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"dQjYU87oi7"},{"type":"text","value":" and recalculates state-dependent benefits.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"vhrEE1Xe1L"}],"key":"vW205zbCRL"}],"key":"TbSXc6Srbc"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Geographic masking","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"gths6l09rE"}],"key":"ply1Ilf5qE"},{"type":"text","value":" — ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bvr5cxmBZp"},{"type":"inlineCode","value":"state_to_cols","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jyP9mZLR4D"},{"type":"text","value":" / ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"IzCpPm0tTv"},{"type":"inlineCode","value":"cd_to_cols","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"OdbWrlgpk5"},{"type":"text","value":" restrict each target row to geographically relevant columns.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ytuwv6iWiO"}],"key":"yZ1eVuVIra"}],"key":"cL8QLReGSm"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Re-randomize takeup","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"zMqtY8zJcp"}],"key":"nUhzRMdlRF"},{"type":"text","value":" — ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"KnMrP0eM9K"},{"type":"inlineCode","value":"rerandomize_takeup()","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"TjkajUA5eF"},{"type":"text","value":" draws new takeup per census block, breaking the fixed-takeup assumption.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"kTuLIfu7tg"}],"key":"kw0R7WPy3i"}],"key":"toEhxp4rql"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Build matrix","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"YMfhtt2f1h"}],"key":"ZQYThxGRYA"},{"type":"text","value":" — ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"EBXBDdfQhl"},{"type":"inlineCode","value":"UnifiedMatrixBuilder.build_matrix()","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"CZ3eD20AhL"},{"type":"text","value":" assembles the sparse CSR matrix from all clones.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"cVphrSDOBI"}],"key":"Uc4643GSmY"}],"key":"LwM2GC9gkl"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Stacked datasets","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"I6uBwVeB2r"}],"key":"ylqpLZ7YzO"},{"type":"text","value":" — ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"yFKnIFoHZ9"},{"type":"inlineCode","value":"create_sparse_cd_stacked_dataset()","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"JnOxEHThcC"},{"type":"text","value":" converts calibrated weights into CD-level h5 files.","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"BDImkfhAwg"}],"key":"aBUA6sKgeu"}],"key":"wZe4aTsnph"}],"key":"CrHNGNKNZA"},{"type":"paragraph","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"For matrix diagnostics (row/column anatomy, target groups, sparsity analysis), see ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"TO6IPRwcC6"},{"type":"link","url":"/policyengine-us-data/build/calibration_matrix-d485e24e65a1cd23cb63714c81d7f6ef.ipynb","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"calibration​_matrix​.ipynb","key":"ObcDqn1BFe"}],"urlSource":"calibration_matrix.ipynb","static":true,"protocol":"file","key":"UPdKKE9YXe"},{"type":"text","value":".","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"IllYhwmDDA"}],"key":"ETvGEvEEK6"}],"key":"l0GyrBeQeO"}],"key":"xDwvg2GY81"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Long Term Projections","url":"/long-term-projections","group":"PolicyEngine US Data"},"next":{"title":"Discussion","url":"/discussion","group":"PolicyEngine US Data"}}},"domain":"http://localhost:3000"}