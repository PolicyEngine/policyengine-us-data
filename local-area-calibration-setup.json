{"version":3,"kind":"Notebook","sha256":"c744718bcddf6e398832be61f37693cdff4f67b57a765775e7354be7e2d28206","slug":"local-area-calibration-setup","location":"/local_area_calibration_setup.ipynb","dependencies":[],"frontmatter":{"title":"Local Area Calibration Setup","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","source_url":"https://github.com/policyengine/policyengine-us-data/blob/main/docs/local_area_calibration_setup.ipynb","edit_url":"https://github.com/policyengine/policyengine-us-data/edit/main/docs/local_area_calibration_setup.ipynb","exports":[{"format":"ipynb","filename":"local_area_calibration_setup.ipynb","url":"/policyengine-us-data/build/local_area_calibrati-acc9fe5d9b039dd1a949700f9e60888a.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates the sparse matrix construction for local area (congressional district) calibration. It uses a subset of CDs from NC, HI, MT, and AK for manageable runtime.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"d3Ggh8H8T4"}],"key":"kdUW5lC7Ua"}],"key":"Ju4EuKlmDH"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 1: Setup & Configuration","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TFsbEKJt6O"}],"identifier":"section-1-setup-configuration","label":"Section 1: Setup & Configuration","html_id":"section-1-setup-configuration","implicit":true,"key":"rn7dtdhJuE"}],"key":"ZqyRQ9hUsX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from sqlalchemy import create_engine, text\nimport pandas as pd\nimport numpy as np\n\nfrom policyengine_us import Microsimulation\nfrom policyengine_us_data.storage import STORAGE_FOLDER\nfrom policyengine_us_data.datasets.cps.local_area_calibration.sparse_matrix_builder import (\n    SparseMatrixBuilder,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.matrix_tracer import (\n    MatrixTracer,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.calibration_utils import (\n    get_calculated_variables,\n    create_target_groups,\n)","key":"S3kkb5IZVz"},{"type":"outputs","id":"q8gJq5r3bKEbhbiJ9aAPi","children":[],"key":"BzUCveLayI"}],"key":"D6L27eF27c"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"db_path = STORAGE_FOLDER / \"policy_data.db\"\ndb_uri = f\"sqlite:///{db_path}\"\ndataset_path = str(STORAGE_FOLDER / \"stratified_extended_cps_2023.h5\")\n\nengine = create_engine(db_uri)","key":"fLk10Fe4xT"},{"type":"outputs","id":"wQNxJv-f8ieYLctSPQqJi","children":[],"key":"dJ6aRFfhYZ"}],"key":"EcJqKE1q2I"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 2: Select Test Congressional Districts","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xpwiYvIc9p"}],"identifier":"section-2-select-test-congressional-districts","label":"Section 2: Select Test Congressional Districts","html_id":"section-2-select-test-congressional-districts","implicit":true,"key":"N9WY353FmE"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We use CDs from 4 states for testing:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"RPtOMYRnTX"}],"key":"nwpMK454UF"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"NC (37)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ddsRTDOimM"}],"key":"hKVLOqrXtj"},{"type":"text","value":": 14 CDs (3701-3714) - provides same-state different-CD test cases","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Cw2Dtmn2NI"}],"key":"xw2Xv03iJC"}],"key":"kDz6tKkpdH"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"HI (15)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"JzsPEPuUu9"}],"key":"xDYR63R22f"},{"type":"text","value":": 2 CDs (1501-1502)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"U2eJ5JcMMf"}],"key":"NQ7iMpy8wo"}],"key":"NBjrFIaM6g"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"MT (30)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Zksig1hrua"}],"key":"jLz7Ajs7JM"},{"type":"text","value":": 2 CDs (3001-3002)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"iOe4k9iaaB"}],"key":"ztdNsBhN0X"}],"key":"Uyu0aR4Eu6"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"AK (2)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"qiygN3S9Tl"}],"key":"R9kOWBWIqy"},{"type":"text","value":": 1 CD (200)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"c2p2wX0JIB"}],"key":"akJ0GVf3Uw"}],"key":"mPAjacppTB"}],"key":"UyFSdq7bEh"}],"key":"SBnh0WrdxX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"query = \"\"\"\nSELECT DISTINCT sc.value as cd_geoid\nFROM strata s\nJOIN stratum_constraints sc ON s.stratum_id = sc.stratum_id\nWHERE s.stratum_group_id = 1\n  AND sc.constraint_variable = 'congressional_district_geoid'\n  AND (\n    sc.value LIKE '37__'\n    OR sc.value LIKE '150_'\n    OR sc.value LIKE '300_'\n    OR sc.value = '200' OR sc.value = '201'\n  )\nORDER BY sc.value\n\"\"\"\n\nwith engine.connect() as conn:\n    result = conn.execute(text(query)).fetchall()\n    test_cds = [row[0] for row in result]\n\nprint(f\"Testing with {len(test_cds)} congressional districts:\")\nprint(f\"  NC (37): {[cd for cd in test_cds if cd.startswith('37')]}\")\nprint(f\"  HI (15): {[cd for cd in test_cds if cd.startswith('15')]}\")\nprint(f\"  MT (30): {[cd for cd in test_cds if cd.startswith('30')]}\")\nprint(f\"  AK (2):  {[cd for cd in test_cds if cd.startswith('20')]}\")","key":"EjwqSHXWQo"},{"type":"outputs","id":"CXq84Z2OYaUr-fPr3BnMK","children":[],"key":"OvMzlXjRj3"}],"key":"zQNkXCSMci"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 3: Build the Sparse Matrix","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FA7s1dss1R"}],"identifier":"section-3-build-the-sparse-matrix","label":"Section 3: Build the Sparse Matrix","html_id":"section-3-build-the-sparse-matrix","implicit":true,"key":"fF74SCLJFW"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The sparse matrix ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gCksQOmsRB"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"G5BwUBmMPK"},{"type":"text","value":" has:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dRWZ5XJm5v"}],"key":"r6CLSeZvCY"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Rows","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ieQnhkieyy"}],"key":"SBMRp3o3kZ"},{"type":"text","value":": Calibration targets (e.g., SNAP totals by geography)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"oFKgmVfMwy"}],"key":"RL7AkCpsdN"}],"key":"DglRvrQMoC"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Columns","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"HCG6vWpVcU"}],"key":"RXKHa39atE"},{"type":"text","value":": (household × CD) pairs - each household appears once per CD","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"fCitGsoSOz"}],"key":"a9uLKvLl4L"}],"key":"oxIa7liAfW"}],"key":"XiVyuqpTiS"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We filter to SNAP targets only (stratum_group_id=4) for this demonstration.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"WvQTrsYi8G"}],"key":"lxkfeE4HUg"}],"key":"TC3ZKUPQi4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim = Microsimulation(dataset=dataset_path)\n\nbuilder = SparseMatrixBuilder(\n    db_uri,\n    time_period=2023,\n    cds_to_calibrate=test_cds,\n    dataset_path=dataset_path,\n)\n\ntargets_df, X_sparse, household_id_mapping = builder.build_matrix(\n    sim, target_filter={\"stratum_group_ids\": [4], \"variables\": [\"snap\"]}\n)\n\nprint(f\"X_sparse shape: {X_sparse.shape}\")\nprint(f\"  Rows (targets): {X_sparse.shape[0]}\")\nprint(f\"  Columns (household × CD pairs): {X_sparse.shape[1]}\")\nprint(f\"  Non-zero entries: {X_sparse.nnz:,}\")\nprint(f\"  Sparsity: {1 - X_sparse.nnz / (X_sparse.shape[0] * X_sparse.shape[1]):.2%}\")","key":"AjIc8jmool"},{"type":"outputs","id":"7Hmk4vr4ZkaK5BUURNATZ","children":[],"key":"olrTGE6IY9"}],"key":"Rk3AMlouL4"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 4: Understanding the Matrix Structure with MatrixTracer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PqFJiUSxUk"}],"identifier":"section-4-understanding-the-matrix-structure-with-matrixtracer","label":"Section 4: Understanding the Matrix Structure with MatrixTracer","html_id":"section-4-understanding-the-matrix-structure-with-matrixtracer","implicit":true,"key":"ykm8wIZ3mr"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TWCCraxc9E"},{"type":"inlineCode","value":"MatrixTracer","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"X2wOgYwwet"},{"type":"text","value":" helps navigate the sparse matrix by providing lookups between:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xjSnr59kpb"}],"key":"hz5TUad1H7"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Column indices ↔ (household_id, CD) pairs","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"sJLpIK26Ml"}],"key":"q68xF4lTww"}],"key":"ro8BmFajXA"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Row indices ↔ target definitions","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"hkaoI1GtuY"}],"key":"IDsTanQNRK"}],"key":"Fuo55sBCkl"}],"key":"MHbPdoRnia"}],"key":"U0ihbZxzAb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracer = MatrixTracer(\n    targets_df, X_sparse, household_id_mapping, test_cds, sim\n)\n\ntracer.print_matrix_structure()","key":"DitURqHlOu"},{"type":"outputs","id":"0pyD_bAjP7a4-SlCNEgV7","children":[],"key":"NzoVkl2KnY"}],"key":"vA3AWBV7vi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_groups, group_info = create_target_groups(targets_df)","key":"OeYYQ0AzxX"},{"type":"outputs","id":"OOFmVA7rw-36JXzN3eFvp","children":[],"key":"g0dXQuIv9y"}],"key":"hpgcp0Y63m"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nrow_loc = target_group.iloc[28]['row_index']  # Manually found the index value 28\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for North Carolina's SNAP benefit amount:\")\nprint(row_info)","key":"CJn4KYngJb"},{"type":"outputs","id":"SByOPfcKDxjTu8ywwFxAv","children":[],"key":"nsiVMECKaV"}],"key":"xPUXFouyOR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hh_snap_df = pd.DataFrame(sim.calculate_dataframe([\n    \"household_id\", \"household_weight\", \"state_fips\", \"snap\"])                                        \n)\nprint(hh_snap_df)","key":"jwOiQrYdhs"},{"type":"outputs","id":"X15-9vPp431MtNUuEccZx","children":[],"key":"WWkXs5OSpB"}],"key":"wo9lieAbL8"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If we were to include ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gxIAY1uckr"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TnJ7nX5fL2"},{"type":"text","value":" above, they would all be zeros. It’s not until we do the calibration, i.e., come back with a vector of weights ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aHc7t8O5Pz"},{"type":"inlineCode","value":"w","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"atANxVQiSZ"},{"type":"text","value":" to multiply ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LWTMWsWcTO"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XzdU85Lcp9"},{"type":"text","value":" with, that we will set ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IFkpawmaKR"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z7hXrdh1aB"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K1ZCA657UX"}],"key":"hfGOMISuEx"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"However, every household is already a donor to every contressional district. You can get the column positions for every household (remember targets are on the rows, donor households on the columns) by running tracer’s get_household_column_positions with the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wkHk5f7m3m"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"original","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NFYLXRMUPm"}],"key":"M9rw3NFxVR"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"M5en4Xt31t"},{"type":"inlineCode","value":"household_id","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FRCTYgwWmj"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yq62UOkZkt"}],"key":"P4q0reSYth"}],"key":"eGozWFh98G"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Reverse lookup: get all column positions for a specific household\nhh_id = hh_snap_df.loc[hh_snap_df.snap > 0].household_id.values[0]\nprint(hh_snap_df.loc[hh_snap_df.household_id == hh_id])\n\nprint(\"\\nEvaluating the tracer.get_household_column_positions dictionary:\\n\")\npositions = tracer.get_household_column_positions(hh_id)\nprint(positions)","key":"eA2vaOdl4R"},{"type":"outputs","id":"IquWMA737Cg7s31_5XgWZ","children":[],"key":"JZMStgLTlH"}],"key":"MxsAKIxQni"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yEcgnnbqRW"}],"identifier":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","label":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","html_id":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","implicit":true,"key":"sYjTjM9V2j"}],"key":"XKSWY1LuJt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"Remember, this is a North Carolina target:\\n\")\nprint(targets_df.iloc[row_loc])\n\nprint(\"\\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['3702']])  # Household donated to NC's 2nd district\n\nprint(\"\\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['201']])  # Household donated to AK's at Large District","key":"ot7MqNdpc0"},{"type":"outputs","id":"V3xMaZyD_gtwrMwJVPBEu","children":[],"key":"QtRunrVIdV"}],"key":"vOI4L4udNe"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Key property: For state-level targets, only CDs in that state should have non-zero values.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"T9oTgEd4sZ"}],"key":"rqmwicSM2Y"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Example: A NC state SNAP target should have zeros for HI, MT, and AK CD columns.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Mz3ICvxNHC"}],"key":"xcFbt4prqb"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"So let’s see that same household’s value for the Alaska state target:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"npN6XoA1b7"}],"key":"cu6fPBFKfm"}],"key":"pTH84JHx5C"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nnew_row_loc = target_group.iloc[10]['row_index']   # Manually found the index value 10\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for Alaska's SNAP benefit amount:\")\nprint(row_info)","key":"JUF8q87VZt"},{"type":"outputs","id":"zJcQ5SeE2NeomZDR7SrbY","children":[],"key":"d1gKCtRLaJ"}],"key":"uBNkEng0aa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"\\nHousehold donated to AK's 1st district, 2023 SNAP dollars:\")\nprint(X_sparse[new_row_loc, positions['201']])  # Household donated to AK's at Large District","key":"ewQRDY5Iuq"},{"type":"outputs","id":"-3zFP5ejFpeWCaaNo-Atm","children":[],"key":"kkaXnrY0Es"}],"key":"yKpHXGuWuj"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 6: Simulating State-Swapped Calculations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wd3khjo6l1"}],"identifier":"section-6-simulating-state-swapped-calculations","label":"Section 6: Simulating State-Swapped Calculations","html_id":"section-6-simulating-state-swapped-calculations","implicit":true,"key":"bZRVo8T28r"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When a household is “transplanted” to a different state, state-dependent benefits like SNAP are recalculated under the destination state’s rules.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"EQwNVArpQx"}],"key":"GhmFywpd6k"}],"key":"ixWusLwxef"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def create_state_simulation(state_fips):\n    \"\"\"Create a simulation with all households assigned to a specific state.\"\"\"\n    s = Microsimulation(dataset=dataset_path)\n    s.set_input(\n        \"state_fips\", 2023, np.full(hh_snap_df.shape[0], state_fips, dtype=np.int32)\n    )\n    for var in get_calculated_variables(s):\n        s.delete_arrays(var)\n    return s\n\n# Compare SNAP for first 5 households under NC vs AK rules\nnc_sim = create_state_simulation(37)  # NC\nak_sim = create_state_simulation(2)   # AK\n\nnc_snap = nc_sim.calculate(\"snap\", map_to=\"household\").values[:5]\nak_snap = ak_sim.calculate(\"snap\", map_to=\"household\").values[:5]\n\nprint(\"SNAP values for first 5 households under different state rules:\")\nprint(f\"  NC rules: {nc_snap}\")\nprint(f\"  AK rules: {ak_snap}\")\nprint(f\"  Difference: {ak_snap - nc_snap}\")","key":"uVfteJ9Izm"},{"type":"outputs","id":"EAzSkVVFOYSeiBoGkNRaG","children":[],"key":"E9exznurxm"}],"key":"GZOLc1jiaD"}],"key":"ZQwBcpPc3j"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Long Term Projections","url":"/long-term-projections","group":"PolicyEngine US Data"},"next":{"title":"Discussion","url":"/discussion","group":"PolicyEngine US Data"}}},"domain":"http://localhost:3000"}