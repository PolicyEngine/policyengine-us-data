{"version":3,"kind":"Notebook","sha256":"c744718bcddf6e398832be61f37693cdff4f67b57a765775e7354be7e2d28206","slug":"local-area-calibration-setup","location":"/local_area_calibration_setup.ipynb","dependencies":[],"frontmatter":{"title":"Local Area Calibration Setup","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","source_url":"https://github.com/policyengine/policyengine-us-data/blob/main/docs/local_area_calibration_setup.ipynb","edit_url":"https://github.com/policyengine/policyengine-us-data/edit/main/docs/local_area_calibration_setup.ipynb","exports":[{"format":"ipynb","filename":"local_area_calibration_setup.ipynb","url":"/policyengine-us-data/build/local_area_calibrati-57e6ca06cfa2f0315efab110f6d5247f.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates the sparse matrix construction for local area (congressional district) calibration. It uses a subset of CDs from NC, HI, MT, and AK for manageable runtime.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"M2qhwVhp4R"}],"key":"rt8NKvKjUv"}],"key":"oeScXtOtYY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 1: Setup & Configuration","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ehuJYima9z"}],"identifier":"section-1-setup-configuration","label":"Section 1: Setup & Configuration","html_id":"section-1-setup-configuration","implicit":true,"key":"nyIZQP08EX"}],"key":"cOcUtfdU0V"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from sqlalchemy import create_engine, text\nimport pandas as pd\nimport numpy as np\n\nfrom policyengine_us import Microsimulation\nfrom policyengine_us_data.storage import STORAGE_FOLDER\nfrom policyengine_us_data.datasets.cps.local_area_calibration.sparse_matrix_builder import (\n    SparseMatrixBuilder,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.matrix_tracer import (\n    MatrixTracer,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.calibration_utils import (\n    get_calculated_variables,\n    create_target_groups,\n)","key":"rjo3cFgsM6"},{"type":"outputs","id":"2B1TTl3ETXRiMCisaRu5h","children":[],"key":"eLjlnSmHRX"}],"key":"hLJdXmgjtg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"db_path = STORAGE_FOLDER / \"policy_data.db\"\ndb_uri = f\"sqlite:///{db_path}\"\ndataset_path = str(STORAGE_FOLDER / \"stratified_extended_cps_2023.h5\")\n\nengine = create_engine(db_uri)","key":"Nu2KqgIPrd"},{"type":"outputs","id":"qI8ljxxWglxRiG4kBRz0L","children":[],"key":"oG7yuXRqgm"}],"key":"Xe7JV2Ba0W"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 2: Select Test Congressional Districts","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PMaL2FpyOX"}],"identifier":"section-2-select-test-congressional-districts","label":"Section 2: Select Test Congressional Districts","html_id":"section-2-select-test-congressional-districts","implicit":true,"key":"Nx15EiRvSD"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We use CDs from 4 states for testing:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OYkFmVvrv2"}],"key":"m4TIHq0qoi"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"NC (37)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"H7vWi6iOpI"}],"key":"PWuXxnHzjx"},{"type":"text","value":": 14 CDs (3701-3714) - provides same-state different-CD test cases","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"n3NxJ0uuyf"}],"key":"qEskIraST0"}],"key":"HZ0NyjHSGm"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"HI (15)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"wgsjx9q1B9"}],"key":"IX1NBql2F0"},{"type":"text","value":": 2 CDs (1501-1502)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QWMJ5d4e9A"}],"key":"EqWeXNkoKi"}],"key":"UI7GNNZkxL"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"MT (30)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"QXVCluEwkY"}],"key":"JbMJVae9eu"},{"type":"text","value":": 2 CDs (3001-3002)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ms9mF0RTyS"}],"key":"rjzx4dqwug"}],"key":"eGf263vkkH"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"AK (2)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"flFePEBsH5"}],"key":"kQqdOT2M7F"},{"type":"text","value":": 1 CD (200)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"yQ6eMHI5Zs"}],"key":"DrIcHGG6QI"}],"key":"AiAc6x9PHe"}],"key":"x4c1i6S6XI"}],"key":"RyuOkdYhtX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"query = \"\"\"\nSELECT DISTINCT sc.value as cd_geoid\nFROM strata s\nJOIN stratum_constraints sc ON s.stratum_id = sc.stratum_id\nWHERE s.stratum_group_id = 1\n  AND sc.constraint_variable = 'congressional_district_geoid'\n  AND (\n    sc.value LIKE '37__'\n    OR sc.value LIKE '150_'\n    OR sc.value LIKE '300_'\n    OR sc.value = '200' OR sc.value = '201'\n  )\nORDER BY sc.value\n\"\"\"\n\nwith engine.connect() as conn:\n    result = conn.execute(text(query)).fetchall()\n    test_cds = [row[0] for row in result]\n\nprint(f\"Testing with {len(test_cds)} congressional districts:\")\nprint(f\"  NC (37): {[cd for cd in test_cds if cd.startswith('37')]}\")\nprint(f\"  HI (15): {[cd for cd in test_cds if cd.startswith('15')]}\")\nprint(f\"  MT (30): {[cd for cd in test_cds if cd.startswith('30')]}\")\nprint(f\"  AK (2):  {[cd for cd in test_cds if cd.startswith('20')]}\")","key":"aExfKvOSS3"},{"type":"outputs","id":"-a5ki__LbvRf5UAxD_DS2","children":[],"key":"xMYfW9DVXQ"}],"key":"EDZJyJj1B2"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 3: Build the Sparse Matrix","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QUO0akEgGm"}],"identifier":"section-3-build-the-sparse-matrix","label":"Section 3: Build the Sparse Matrix","html_id":"section-3-build-the-sparse-matrix","implicit":true,"key":"sNL8yEgyAN"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The sparse matrix ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"n4pE7Udgg2"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"y3XQ7Lm6Xw"},{"type":"text","value":" has:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CfwuiTGZV8"}],"key":"iPV9ycq0Si"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Rows","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"IWCtruClvf"}],"key":"FIEcdy53oe"},{"type":"text","value":": Calibration targets (e.g., SNAP totals by geography)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"hBfatGCOvs"}],"key":"NQmBr9ywK5"}],"key":"oCPw6c8W2s"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Columns","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"vle0o1w0ag"}],"key":"qpcsPsir16"},{"type":"text","value":": (household × CD) pairs - each household appears once per CD","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"xXmJElqEYz"}],"key":"bCInrBPYWg"}],"key":"OSyTjxpJP4"}],"key":"DWWmttkb90"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We filter to SNAP targets only (stratum_group_id=4) for this demonstration.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"NHsd6uF4Dz"}],"key":"HWEBqwIsCO"}],"key":"x4Iys33n2W"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim = Microsimulation(dataset=dataset_path)\n\nbuilder = SparseMatrixBuilder(\n    db_uri,\n    time_period=2023,\n    cds_to_calibrate=test_cds,\n    dataset_path=dataset_path,\n)\n\ntargets_df, X_sparse, household_id_mapping = builder.build_matrix(\n    sim, target_filter={\"stratum_group_ids\": [4], \"variables\": [\"snap\"]}\n)\n\nprint(f\"X_sparse shape: {X_sparse.shape}\")\nprint(f\"  Rows (targets): {X_sparse.shape[0]}\")\nprint(f\"  Columns (household × CD pairs): {X_sparse.shape[1]}\")\nprint(f\"  Non-zero entries: {X_sparse.nnz:,}\")\nprint(f\"  Sparsity: {1 - X_sparse.nnz / (X_sparse.shape[0] * X_sparse.shape[1]):.2%}\")","key":"nYSDAr8xkQ"},{"type":"outputs","id":"zY7cHdRIJpQCSHNEdwXA2","children":[],"key":"IbEhlUunnl"}],"key":"OC351ZNGZv"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 4: Understanding the Matrix Structure with MatrixTracer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LWwTPu9pNV"}],"identifier":"section-4-understanding-the-matrix-structure-with-matrixtracer","label":"Section 4: Understanding the Matrix Structure with MatrixTracer","html_id":"section-4-understanding-the-matrix-structure-with-matrixtracer","implicit":true,"key":"trZyvtLhUN"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aTDeVvVuLd"},{"type":"inlineCode","value":"MatrixTracer","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"d9zjwAk0M6"},{"type":"text","value":" helps navigate the sparse matrix by providing lookups between:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vog9WDeKyc"}],"key":"pP193WjED8"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Column indices ↔ (household_id, CD) pairs","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"pDQ0FJc5qV"}],"key":"iuwtkDSt2Y"}],"key":"CQzpyGRn5g"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Row indices ↔ target definitions","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"vGzdi2WyFl"}],"key":"HHKI3p7gKA"}],"key":"GcEjsnAINf"}],"key":"GZOLPu7FEU"}],"key":"ta199OI6In"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracer = MatrixTracer(\n    targets_df, X_sparse, household_id_mapping, test_cds, sim\n)\n\ntracer.print_matrix_structure()","key":"PqyqDo7iEc"},{"type":"outputs","id":"1XoqaWiXXkYTAEut4nCH_","children":[],"key":"UnJhZPhJWp"}],"key":"liuEyCyLwT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_groups, group_info = create_target_groups(targets_df)","key":"BKAvFUam1H"},{"type":"outputs","id":"C1BHt1p_JZ5vX-vufNzzR","children":[],"key":"Kqrt2LMzsg"}],"key":"jvFDb4wsaa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nrow_loc = target_group.iloc[28]['row_index']  # Manually found the index value 28\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for North Carolina's SNAP benefit amount:\")\nprint(row_info)","key":"Gw1QOUMrR0"},{"type":"outputs","id":"jpKKXe4GjnZX0e590Me1a","children":[],"key":"HX3DLllCtM"}],"key":"kVajK6Vb8n"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hh_snap_df = pd.DataFrame(sim.calculate_dataframe([\n    \"household_id\", \"household_weight\", \"state_fips\", \"snap\"])                                        \n)\nprint(hh_snap_df)","key":"OcGyN9UO5e"},{"type":"outputs","id":"X2Gw5jJOIR4QE06M7SmsG","children":[],"key":"NxmZj1HKJe"}],"key":"G2YfIbiVhy"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If we were to include ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VgEMZBuZwr"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gGTumwFJNA"},{"type":"text","value":" above, they would all be zeros. It’s not until we do the calibration, i.e., come back with a vector of weights ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IDZBfvd7hi"},{"type":"inlineCode","value":"w","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pf5L2AEvgy"},{"type":"text","value":" to multiply ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y8kMc3RhNz"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cmBbqXXzyR"},{"type":"text","value":" with, that we will set ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nGJX5NJ2eK"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zsBAvG8iHD"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tJtXGZFU5S"}],"key":"mQRBsyWXsB"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"However, every household is already a donor to every contressional district. You can get the column positions for every household (remember targets are on the rows, donor households on the columns) by running tracer’s get_household_column_positions with the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KjKWtLuPQp"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"original","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"iG5lw4sm2u"}],"key":"B665GzCqad"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"AcIAv83lOo"},{"type":"inlineCode","value":"household_id","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pFZLg555S3"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NE7Czq9S2B"}],"key":"d1YyuDz1Np"}],"key":"MKLie4iXvt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Reverse lookup: get all column positions for a specific household\nhh_id = hh_snap_df.loc[hh_snap_df.snap > 0].household_id.values[0]\nprint(hh_snap_df.loc[hh_snap_df.household_id == hh_id])\n\nprint(\"\\nEvaluating the tracer.get_household_column_positions dictionary:\\n\")\npositions = tracer.get_household_column_positions(hh_id)\nprint(positions)","key":"FnLZSy8iPy"},{"type":"outputs","id":"crDkvpHGhVF3jDfgOMnIo","children":[],"key":"IwVsTv5Dc7"}],"key":"TfjNn1kCIM"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jbbJBLPWl8"}],"identifier":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","label":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","html_id":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","implicit":true,"key":"kZuqw5AAS8"}],"key":"Zg9QhhrWNS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"Remember, this is a North Carolina target:\\n\")\nprint(targets_df.iloc[row_loc])\n\nprint(\"\\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['3702']])  # Household donated to NC's 2nd district\n\nprint(\"\\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['201']])  # Household donated to AK's at Large District","key":"BdrzhQVVWo"},{"type":"outputs","id":"YUlEOTP0qkinQGozWa4Nl","children":[],"key":"T1Ngkr5kXF"}],"key":"Epfh3WJSo5"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Key property: For state-level targets, only CDs in that state should have non-zero values.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Nf60fm0iLA"}],"key":"n1bDEBWxGK"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Example: A NC state SNAP target should have zeros for HI, MT, and AK CD columns.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eTchQ0FCh1"}],"key":"x1zaRMlfZt"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"So let’s see that same household’s value for the Alaska state target:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GvkeAStasP"}],"key":"rzICJSAEsj"}],"key":"ZgNuNS4wRh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nnew_row_loc = target_group.iloc[10]['row_index']   # Manually found the index value 10\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for Alaska's SNAP benefit amount:\")\nprint(row_info)","key":"HI9EpONQGW"},{"type":"outputs","id":"IkusDsJGSIKdG3r1HlkZ-","children":[],"key":"pewIAnqB9J"}],"key":"K9iZXRb9CB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"\\nHousehold donated to AK's 1st district, 2023 SNAP dollars:\")\nprint(X_sparse[new_row_loc, positions['201']])  # Household donated to AK's at Large District","key":"qe1f38o0XF"},{"type":"outputs","id":"WKPgc3oDl7h-KtTRqHPZ_","children":[],"key":"XcTFcnPmVq"}],"key":"j8oJKseeFO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 6: Simulating State-Swapped Calculations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YzGdfjPk0G"}],"identifier":"section-6-simulating-state-swapped-calculations","label":"Section 6: Simulating State-Swapped Calculations","html_id":"section-6-simulating-state-swapped-calculations","implicit":true,"key":"QGSBJBEnrT"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When a household is “transplanted” to a different state, state-dependent benefits like SNAP are recalculated under the destination state’s rules.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aeXVMcJJ5e"}],"key":"V877VJnKg5"}],"key":"BnwkFXDB36"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def create_state_simulation(state_fips):\n    \"\"\"Create a simulation with all households assigned to a specific state.\"\"\"\n    s = Microsimulation(dataset=dataset_path)\n    s.set_input(\n        \"state_fips\", 2023, np.full(hh_snap_df.shape[0], state_fips, dtype=np.int32)\n    )\n    for var in get_calculated_variables(s):\n        s.delete_arrays(var)\n    return s\n\n# Compare SNAP for first 5 households under NC vs AK rules\nnc_sim = create_state_simulation(37)  # NC\nak_sim = create_state_simulation(2)   # AK\n\nnc_snap = nc_sim.calculate(\"snap\", map_to=\"household\").values[:5]\nak_snap = ak_sim.calculate(\"snap\", map_to=\"household\").values[:5]\n\nprint(\"SNAP values for first 5 households under different state rules:\")\nprint(f\"  NC rules: {nc_snap}\")\nprint(f\"  AK rules: {ak_snap}\")\nprint(f\"  Difference: {ak_snap - nc_snap}\")","key":"uqxh6ruEsg"},{"type":"outputs","id":"U2bqGbIBxfbhQDYjdyPAa","children":[],"key":"dDey2FqJlB"}],"key":"vh66i3ehuo"}],"key":"Uo8pB1h7hi"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Long Term Projections","url":"/long-term-projections","group":"PolicyEngine US Data"},"next":{"title":"Discussion","url":"/discussion","group":"PolicyEngine US Data"}}},"domain":"http://localhost:3000"}