{"version":3,"kind":"Notebook","sha256":"f4330ff66f42253cf4eeded7b0294f100e8f468f56a1684df16453eaba262629","slug":"local-area-calibration-setup","location":"/local_area_calibration_setup.ipynb","dependencies":[],"frontmatter":{"title":"Local Area Calibration Setup","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","source_url":"https://github.com/policyengine/policyengine-us-data/blob/main/docs/local_area_calibration_setup.ipynb","edit_url":"https://github.com/policyengine/policyengine-us-data/edit/main/docs/local_area_calibration_setup.ipynb","exports":[{"format":"ipynb","filename":"local_area_calibration_setup.ipynb","url":"/policyengine-us-data/build/local_area_calibrati-05acecbf3e0ac37f17f4adc1f4739a05.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates the sparse matrix construction for local area (congressional district) calibration. It uses a subset of CDs from NC, HI, MT, and AK for manageable runtime.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"lkTcxrMPEM"}],"key":"J1wD0JTZA5"}],"key":"SEYsH5ENWz"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 1: Setup & Configuration","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Lg6hhnqYQh"}],"identifier":"section-1-setup-configuration","label":"Section 1: Setup & Configuration","html_id":"section-1-setup-configuration","implicit":true,"key":"Wym0qOsNAx"}],"key":"o4pV4tCK30"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from sqlalchemy import create_engine, text\nimport pandas as pd\nimport numpy as np\n\nfrom policyengine_us import Microsimulation\nfrom policyengine_us_data.storage import STORAGE_FOLDER\nfrom policyengine_us_data.datasets.cps.local_area_calibration.sparse_matrix_builder import (\n    SparseMatrixBuilder,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.matrix_tracer import (\n    MatrixTracer,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.calibration_utils import (\n    get_calculated_variables,\n    create_target_groups,\n)","key":"VktlKkqoWT"},{"type":"outputs","id":"tIiSRV0wcyxOT2UAWMKSa","children":[],"key":"mrRQL0Op37"}],"key":"h0rsWvy5Je"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"db_path = STORAGE_FOLDER / \"calibration\" / \"policy_data.db\"\ndb_uri = f\"sqlite:///{db_path}\"\ndataset_path = str(STORAGE_FOLDER / \"stratified_extended_cps_2024.h5\")\n\nengine = create_engine(db_uri)","key":"AN3BL2JlBl"},{"type":"outputs","id":"-rlhYwICVBcFfVtCCkno6","children":[],"key":"wEQUFVAgox"}],"key":"oqY6oMSMaY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 2: Select Test Congressional Districts","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uVnhhHuFe3"}],"identifier":"section-2-select-test-congressional-districts","label":"Section 2: Select Test Congressional Districts","html_id":"section-2-select-test-congressional-districts","implicit":true,"key":"qkO8Z9Dkgr"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We use CDs from 4 states for testing:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PDgYGC4Hhq"}],"key":"T9LawmGKRl"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"NC (37)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ubn040kqyk"}],"key":"Odg674Q2kx"},{"type":"text","value":": 14 CDs (3701-3714) - provides same-state different-CD test cases","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"tQOunCgLbt"}],"key":"BzUg8OntPp"}],"key":"O347C7HBxX"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"HI (15)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"OtzRvpkDdF"}],"key":"qCWXSEPCvi"},{"type":"text","value":": 2 CDs (1501-1502)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"JbSRvOQ9WQ"}],"key":"zeuKSW7GBd"}],"key":"HFkEEppL4E"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"MT (30)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"DENZ9y0btw"}],"key":"cCywyUL9aW"},{"type":"text","value":": 2 CDs (3001-3002)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"VLLjqpUzZN"}],"key":"KMkXn3uE2r"}],"key":"ds1akGskh1"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"AK (2)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"HTwjLbIxoL"}],"key":"lRAXybrn7d"},{"type":"text","value":": 1 CD (200)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EFmei3pVWe"}],"key":"yHgbJXiaIr"}],"key":"r7zrtnm6MQ"}],"key":"EcULZbrDSf"}],"key":"m21HyM3q1W"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"query = \"\"\"\nSELECT DISTINCT sc.value as cd_geoid\nFROM stratum_constraints sc\nWHERE sc.constraint_variable = 'congressional_district_geoid'\n  AND (\n    sc.value LIKE '37__'\n    OR sc.value LIKE '150_'\n    OR sc.value LIKE '300_'\n    OR sc.value = '200' OR sc.value = '201'\n  )\nORDER BY sc.value\n\"\"\"\n\nwith engine.connect() as conn:\n    result = conn.execute(text(query)).fetchall()\n    test_cds = [row[0] for row in result]\n\nprint(f\"Testing with {len(test_cds)} congressional districts:\")\nprint(f\"  NC (37): {[cd for cd in test_cds if cd.startswith('37')]}\")\nprint(f\"  HI (15): {[cd for cd in test_cds if cd.startswith('15')]}\")\nprint(f\"  MT (30): {[cd for cd in test_cds if cd.startswith('30')]}\")\nprint(f\"  AK (2):  {[cd for cd in test_cds if cd.startswith('20')]}\")","key":"Ad3KWEZ6JL"},{"type":"outputs","id":"G0xkCrUyTkhA4uxYy2bsB","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Testing with 19 congressional districts:\n  NC (37): ['3701', '3702', '3703', '3704', '3705', '3706', '3707', '3708', '3709', '3710', '3711', '3712', '3713', '3714']\n  HI (15): ['1501', '1502']\n  MT (30): ['3001', '3002']\n  AK (2):  ['201']\n"},"children":[],"key":"RRjndGKvYo"}],"key":"tvAFQhjQ96"}],"key":"dTdSGJ72Yo"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 3: Build the Sparse Matrix","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WimU9DrcP2"}],"identifier":"section-3-build-the-sparse-matrix","label":"Section 3: Build the Sparse Matrix","html_id":"section-3-build-the-sparse-matrix","implicit":true,"key":"wIvPRtDgc8"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The sparse matrix ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xT9P9q9iQY"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vDdXqAD99O"},{"type":"text","value":" has:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"n8AGy4viSo"}],"key":"kmaktzvyqe"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Rows","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"gs0rjDnlkq"}],"key":"MwMAJ4GeAM"},{"type":"text","value":": Calibration targets (e.g., SNAP totals by geography)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"vmJ4IkPa2P"}],"key":"HpMrtESf2r"}],"key":"fRSk9gOGqK"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Columns","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"cXQKVLJl6k"}],"key":"q1Mh3KWgoG"},{"type":"text","value":": (household × CD) pairs - each household appears once per CD","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dPMrYqXqjW"}],"key":"sRo4kWVtcQ"}],"key":"T2VQyoFCv1"}],"key":"pNvGxcB9G9"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We filter to SNAP targets using the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Rv9yLYyeH1"},{"type":"inlineCode","value":"domain_variables","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Mik7lruZLk"},{"type":"text","value":" filter for this demonstration.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"T1Khfv1CKJ"}],"key":"GlyxHiMpGe"}],"key":"tKcpNwbT4U"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim = Microsimulation(dataset=dataset_path)\n\nbuilder = SparseMatrixBuilder(\n    db_uri,\n    time_period=2024,\n    cds_to_calibrate=test_cds,\n    dataset_path=dataset_path,\n)\n\ntargets_df, X_sparse, household_id_mapping = builder.build_matrix(\n    sim, target_filter={\"domain_variables\": [\"snap\"], \"variables\": [\"snap\"]}\n)\n\nprint(f\"X_sparse shape: {X_sparse.shape}\")\nprint(f\"  Rows (targets): {X_sparse.shape[0]}\")\nprint(f\"  Columns (household × CD pairs): {X_sparse.shape[1]}\")\nprint(f\"  Non-zero entries: {X_sparse.nnz:,}\")\nprint(f\"  Sparsity: {1 - X_sparse.nnz / (X_sparse.shape[0] * X_sparse.shape[1]):.2%}\")","key":"GrySlVqGkd"},{"type":"outputs","id":"7msO-Zc2XroAg7y7kegT3","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"X_sparse shape: (539, 227981)\n  Rows (targets): 539\n  Columns (household × CD pairs): 227981\n  Non-zero entries: 141,536\n  Sparsity: 99.88%\n"},"children":[],"key":"gtJrrAvnUV"}],"key":"vLoqWE93KL"}],"key":"vPBfi7srGh"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 4: Understanding the Matrix Structure with MatrixTracer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u39NtX9tog"}],"identifier":"section-4-understanding-the-matrix-structure-with-matrixtracer","label":"Section 4: Understanding the Matrix Structure with MatrixTracer","html_id":"section-4-understanding-the-matrix-structure-with-matrixtracer","implicit":true,"key":"rW9BZfiz6z"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GM3LYEuUce"},{"type":"inlineCode","value":"MatrixTracer","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hFZwQQeUbl"},{"type":"text","value":" helps navigate the sparse matrix by providing lookups between:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wYErim0QQj"}],"key":"w4SpQevJC9"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Column indices ↔ (household_id, CD) pairs","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"mNQGnjk0V5"}],"key":"sRI5DIF5pC"}],"key":"KgySELRGVm"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Row indices ↔ target definitions","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"iPV2MfR2b7"}],"key":"yDjk6HSQ48"}],"key":"GbYeMQFMNO"}],"key":"DP5lvx9HUI"}],"key":"PAqGcnowl1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracer = MatrixTracer(\n    targets_df, X_sparse, household_id_mapping, test_cds, sim\n)\n\ntracer.print_matrix_structure()","key":"xxLx26vm9l"},{"type":"outputs","id":"1_lhifrVyCUy1SEeCXnt0","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\n================================================================================\nMATRIX STRUCTURE BREAKDOWN\n================================================================================\n\nMatrix dimensions: 539 rows x 227981 columns\n  Rows = 539 targets\n  Columns = 11999 households x 19 CDs\n           = 11,999 x 19 = 227,981\n\n--------------------------------------------------------------------------------\nCOLUMN STRUCTURE (Households stacked by CD)\n--------------------------------------------------------------------------------\n\nShowing first and last 5 CDs of 19 total:\n\nFirst 5 CDs:\ncd_geoid  start_col  end_col  n_households\n    1501          0    11998         11999\n    1502      11999    23997         11999\n     201      23998    35996         11999\n    3001      35997    47995         11999\n    3002      47996    59994         11999\n\nLast 5 CDs:\ncd_geoid  start_col  end_col  n_households\n    3710     167986   179984         11999\n    3711     179985   191983         11999\n    3712     191984   203982         11999\n    3713     203983   215981         11999\n    3714     215982   227980         11999\n\n--------------------------------------------------------------------------------\nROW STRUCTURE (Targets)\n--------------------------------------------------------------------------------\n\nTotal targets: 539\n\nTargets by domain variable:\n                 n_targets  n_unique_vars\ndomain_variable                          \nsnap                   538              2\n\n--------------------------------------------------------------------------------\nTARGET GROUPS (for loss calculation)\n--------------------------------------------------------------------------------\n\n=== Creating Target Groups ===\n\nNational targets:\n  Group 0: Snap = 93,730,290,000\n\nState targets:\n  Group 1: SNAP Household Count (51 targets)\n  Group 2: Snap (51 targets)\n\nDistrict targets:\n  Group 3: SNAP Household Count (436 targets)\n\nTotal groups created: 4\n========================================\n  Group 0: National Snap (1 target, value=93,730,290,000) - rows [0]\n  Group 1: State SNAP Household Count (51 targets) - rows [1, 2, 3, ..., 50, 51]\n  Group 2: State Snap (51 targets) - rows [52, 53, 54, ..., 101, 102]\n  Group 3: District SNAP Household Count (436 targets) - rows [103, 104, 105, ..., 537, 538]\n\n================================================================================\n"},"children":[],"key":"BVQIdoYHyE"}],"key":"gIyySrz5cc"}],"key":"vemP0r2blL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_groups, group_info = create_target_groups(targets_df)","key":"ISljNBFbdp"},{"type":"outputs","id":"D4N31UUFwjID6RJenf34S","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\n=== Creating Target Groups ===\n\nNational targets:\n  Group 0: Snap = 93,730,290,000\n\nState targets:\n  Group 1: SNAP Household Count (51 targets)\n  Group 2: Snap (51 targets)\n\nDistrict targets:\n  Group 3: SNAP Household Count (436 targets)\n\nTotal groups created: 4\n========================================\n"},"children":[],"key":"jWVFbrExfO"}],"key":"f2ZeeIz1Eb"}],"key":"LcOb6PeUIc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nrow_loc = target_group.iloc[28]['row_index']  # Manually found the index value 28\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for North Carolina's SNAP benefit amount:\")\nprint(row_info)","key":"iTbq9uGMzv"},{"type":"outputs","id":"IW8hp2lPGqAoqAeNlK_Vw","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Row info for North Carolina's SNAP benefit amount:\n{'row_index': 80, 'variable': 'snap', 'variable_desc': 'SNAP allotment', 'geographic_id': '37', 'target_value': 2934626410.0, 'stratum_id': 9363, 'domain_variable': 'snap'}\n"},"children":[],"key":"B7Pitkms2K"}],"key":"V8dNEOxI3O"}],"key":"a0lbdKg5er"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hh_snap_df = pd.DataFrame(sim.calculate_dataframe([\n    \"household_id\", \"household_weight\", \"state_fips\", \"snap\"])                                        \n)\nprint(hh_snap_df)","key":"diaGp8M8sT"},{"type":"outputs","id":"YruRMEcHF78JpEJFVML7K","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"       household_id  household_weight  state_fips    snap\n0                26       1205.310059          23     0.0\n1                34       2170.419922          23     0.0\n2                38        587.510010          23     0.0\n3                46       1010.840027          23     0.0\n4                71        957.460022          23     0.0\n...             ...               ...         ...     ...\n11994        177822          0.000000          15     0.0\n11995        177829          0.000000          15     0.0\n11996        177831          0.000000          15     0.0\n11997        177860          0.000000          15  6294.0\n11998        177861          0.000000          15     0.0\n\n[11999 rows x 4 columns]\n"},"children":[],"key":"Ide5JYqgWt"}],"key":"UVZsnV4lgY"}],"key":"vv64vnO20t"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If we were to include ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Bkoe7fXsD9"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uKrjjKnt5J"},{"type":"text","value":" above, they would all be zeros. It’s not until we do the calibration, i.e., come back with a vector of weights ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uOXBBkqu4e"},{"type":"inlineCode","value":"w","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zP7KUd6QVZ"},{"type":"text","value":" to multiply ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nzJOwYwoFv"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qRaCbzSF6K"},{"type":"text","value":" with, that we will set ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"t2RrvBUUTP"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QxhhrkiJRf"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TpRISeNWBh"}],"key":"a3eVHM3iiN"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"However, every household is already a donor to every contressional district. You can get the column positions for every household (remember targets are on the rows, donor households on the columns) by running tracer’s get_household_column_positions with the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yiIpP1Xkxq"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"original","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wjwMY9QVZ6"}],"key":"Q8HuxihEmx"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Q6ZpHozIki"},{"type":"inlineCode","value":"household_id","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wtHie0COqC"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"u5akBM20Cx"}],"key":"wVXususHxm"}],"key":"GGw6SZNrcQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Reverse lookup: get all column positions for a specific household\nhh_id = hh_snap_df.loc[hh_snap_df.snap > 0].household_id.values[0]\nprint(hh_snap_df.loc[hh_snap_df.household_id == hh_id])\n\nprint(\"\\nEvaluating the tracer.get_household_column_positions dictionary:\\n\")\npositions = tracer.get_household_column_positions(hh_id)\nprint(positions)","key":"zIf6YduKTY"},{"type":"outputs","id":"Tk9Zv0FzU5pW4Nhr7dtY-","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"    household_id  household_weight  state_fips       snap\n23           654       1550.660034          23  70.080002\n\nEvaluating the tracer.get_household_column_positions dictionary:\n\n{'1501': 23, '1502': 12022, '201': 24021, '3001': 36020, '3002': 48019, '3701': 60018, '3702': 72017, '3703': 84016, '3704': 96015, '3705': 108014, '3706': 120013, '3707': 132012, '3708': 144011, '3709': 156010, '3710': 168009, '3711': 180008, '3712': 192007, '3713': 204006, '3714': 216005}\n"},"children":[],"key":"c9tHU4KmuK"}],"key":"VxitFrj6yR"}],"key":"ZdzAbufL9O"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fcX7INL1DF"}],"identifier":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","label":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","html_id":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","implicit":true,"key":"hDm00xlzRD"}],"key":"vmNcImGAsE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"Remember, this is a North Carolina target:\\n\")\nprint(targets_df.iloc[row_loc])\n\nprint(\"\\nNC State target. Household donated to NC's 2nd district, 2024 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['3702']])  # Household donated to NC's 2nd district\n\nprint(\"\\nSame target, same household, donated to AK's at Large district, 2024 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['201']])  # Household donated to AK's at Large District","key":"TiV4fCtxzn"},{"type":"outputs","id":"WQK0La8PE23xQdYm_ZaA_","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Remember, this is a North Carolina target:\n\ntarget_id                  8942\nstratum_id                 9363\nvariable                   snap\nvalue              2934626410.0\nperiod                     2024\ngeo_level                 state\ngeographic_id                37\ndomain_variable            snap\noriginal_value     2934626410.0\nuprating_factor             1.0\nName: 80, dtype: object\n\nNC State target. Household donated to NC's 2nd district, 2024 SNAP dollars:\n70.08\n\nSame target, same household, donated to AK's at Large district, 2024 SNAP dollars:\n0.0\n"},"children":[],"key":"Ggtg4t9toY"}],"key":"Y0EwbID5Bt"}],"key":"AXQso88c7a"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Key property: For state-level targets, only CDs in that state should have non-zero values.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vBR0MFr4VT"}],"key":"oziZuAJ0gb"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Example: A NC state SNAP target should have zeros for HI, MT, and AK CD columns.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"po3gPVfOvc"}],"key":"OUeiF7ntsp"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"So let’s see that same household’s value for the Alaska state target:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"u9Vew0r97m"}],"key":"ISMLznrcwT"}],"key":"Lo3SzkcDkL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nnew_row_loc = target_group.iloc[10]['row_index']   # Manually found the index value 10\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for Alaska's SNAP benefit amount:\")\nprint(row_info)","key":"EWdJKpL1NI"},{"type":"outputs","id":"un4T9YSuHBTiQtROM4U23","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Row info for Alaska's SNAP benefit amount:\n{'row_index': 80, 'variable': 'snap', 'variable_desc': 'SNAP allotment', 'geographic_id': '37', 'target_value': 2934626410.0, 'stratum_id': 9363, 'domain_variable': 'snap'}\n"},"children":[],"key":"DjJsjKpcmW"}],"key":"xv65TEmjjF"}],"key":"w2u73218zO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"\\nHousehold donated to AK's 1st district, 2024 SNAP dollars:\")\nprint(X_sparse[new_row_loc, positions['201']])  # Household donated to AK's at Large District","key":"zpB5bu2zWm"},{"type":"outputs","id":"Iiy_qgSwAy0c6rNYlGCqW","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\nHousehold donated to AK's 1st district, 2024 SNAP dollars:\n0.0\n"},"children":[],"key":"HbYjk2ao1K"}],"key":"tAB9GVAGPH"}],"key":"jwBy8O5xWJ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 6: Simulating State-Swapped Calculations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oWkGpOP1IA"}],"identifier":"section-6-simulating-state-swapped-calculations","label":"Section 6: Simulating State-Swapped Calculations","html_id":"section-6-simulating-state-swapped-calculations","implicit":true,"key":"qxx1u8n3qU"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When a household is “transplanted” to a different state, state-dependent benefits like SNAP are recalculated under the destination state’s rules.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"H41Bn3zvbI"}],"key":"vLB2pbUJNo"}],"key":"uhUzCSCTAl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def create_state_simulation(state_fips):\n    \"\"\"Create a simulation with all households assigned to a specific state.\"\"\"\n    s = Microsimulation(dataset=dataset_path)\n    s.set_input(\n        \"state_fips\", 2024, np.full(hh_snap_df.shape[0], state_fips, dtype=np.int32)\n    )\n    for var in get_calculated_variables(s):\n        s.delete_arrays(var)\n    return s\n\n# Compare SNAP for first 5 households under NC vs AK rules\nnc_sim = create_state_simulation(37)  # NC\nak_sim = create_state_simulation(2)   # AK\n\nnc_snap = nc_sim.calculate(\"snap\", map_to=\"household\").values[:5]\nak_snap = ak_sim.calculate(\"snap\", map_to=\"household\").values[:5]\n\nprint(\"SNAP values for first 5 households under different state rules:\")\nprint(f\"  NC rules: {nc_snap}\")\nprint(f\"  AK rules: {ak_snap}\")\nprint(f\"  Difference: {ak_snap - nc_snap}\")","key":"BusGtRc44i"},{"type":"outputs","id":"4nVUxemE3-L4zlmUsUNUD","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"SNAP values for first 5 households under different state rules:\n  NC rules: [0. 0. 0. 0. 0.]\n  AK rules: [0. 0. 0. 0. 0.]\n  Difference: [0. 0. 0. 0. 0.]\n"},"children":[],"key":"Oyt2bdFUuJ"}],"key":"RHhw0VG2wZ"}],"key":"v96ZlIItxv"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 7: Creating the h5 files","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XIYDSI4a1j"}],"identifier":"section-7-creating-the-h5-files","label":"Section 7: Creating the h5 files","html_id":"section-7-creating-the-h5-files","implicit":true,"key":"YhSYC4C2ok"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"w","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Fe84wwlSBX"},{"type":"text","value":" (required)","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"L6ppuBUPWt"}],"key":"zxCglQqUUn"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The calibrated weight vector from L0 calibration","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"OIqtnzYoyH"}],"key":"moQjieswPG"}],"key":"zKUAhrpZIm"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Shape: (n_cds * n_households,) — a flattened matrix where each CD has weights for all households","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"s5pSdCe8dt"}],"key":"JCyxETLC0S"}],"key":"JOKatI3i2C"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Gets reshaped to (n_cds, n_households) internally","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Oj43PHxcuR"}],"key":"O2fwWutgwV"}],"key":"YkRRLUZmqS"}],"key":"SrPYku3kgo"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"inlineCode","value":"cds_to_calibrate","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"s7Esnv2gQi"},{"type":"text","value":" (required)","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"uTgumt6vsB"}],"key":"af7HyS9Mye"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The ordered list of CD GEOIDs used when building w","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"UXeu7oR2C2"}],"key":"mZEi4JlKRl"}],"key":"r6BUSjl9dz"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Serves two purposes:\na. Tells us how to reshape w (via its length)\nb. Provides the index mapping so we can extract the right rows for any cd_subset","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"vbRjk0Xh15"}],"key":"vv6jM2KxEB"}],"key":"WP49xD34Va"}],"key":"T7dxZfmdnf"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"inlineCode","value":"cd_subset","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"yy9uSmyjlE"},{"type":"text","value":" (optional, default None)","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"FRex720VBU"}],"key":"vgEjljlWiL"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Which CDs to actually include in the output dataset","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"EemdRrOE4T"}],"key":"mTVv5pa0MK"}],"key":"Pf8FoTcFAR"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Must be a subset of cds_to_calibrate","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"xtRQDwQVeG"}],"key":"aoAM9ZOG7u"}],"key":"ZDvGG8dQoR"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"If None, all CDs are included","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"r9G4eRmK6A"}],"key":"O7aYqID33x"}],"key":"zqBUBY4v5F"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Use cases: build a single-state file, a single-CD file for testing, etc.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"rv3DR3EIgJ"}],"key":"jYPsCfCTLG"}],"key":"PtFpgg0FOF"}],"key":"TYI0N7p9Zl"},{"type":"paragraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"inlineCode","value":"output_path","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"fbMKVHhrxQ"},{"type":"text","value":" (optional but effectively required — raises if None)","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"E2fh7nmK2m"}],"key":"FKNTloO3uZ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":21,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Where to save the resulting .h5 file","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"sfXtG3ZNKA"}],"key":"VImSMPyDme"}],"key":"KBRcrTTMAF"},{"type":"listItem","spread":true,"position":{"start":{"line":22,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Creates parent directories if needed","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"FoAEQJe8Eb"}],"key":"DLypn5YJ3X"}],"key":"E7Ixeh8vfB"}],"key":"H6ijI5CQCp"},{"type":"paragraph","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"inlineCode","value":"dataset_path","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"tUw7rHuOd8"},{"type":"text","value":" (optional, default None)","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"Ft5IV86weu"}],"key":"TLlPZdZbBj"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":25,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Path to the base .h5 dataset that was used during calibration","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"LfKI5wNiwl"}],"key":"dLy5eljtgQ"}],"key":"CAd4vZP2XZ"},{"type":"listItem","spread":true,"position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"This is the “template” — household structure, demographics, etc.","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"Nijfump1OE"}],"key":"gB33VaFNtZ"}],"key":"gJTo2pt6js"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The function loads this, reweights households per CD, updates geography, and stacks","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"hFWz7lsBQV"}],"key":"nPpYR91IAK"}],"key":"cCtvVf0CIG"}],"key":"M0sXWMdSON"}],"key":"wCs9Zb85mn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\n\nfrom policyengine_us_data.datasets.cps.local_area_calibration.stacked_dataset_builder import create_sparse_cd_stacked_dataset\n\n# Initialize the weights w for demonstration\n# We can't allow too many w cells to be positive for a given state, or the reindexing will fail\nw = np.random.binomial(n=1, p=0.01, size=X_sparse.shape[1]).astype(float)\n\n# We'll make sure our earlier household is included:\nhousehold_ids = sim.calculate(\"household_id\", map_to=\"household\").values\nhh_idx = np.where(household_ids == hh_id)[0][0]\n\ncd_idx = test_cds.index('3701')\nflat_idx = cd_idx * len(household_ids) + hh_idx\nw[flat_idx] = 2.5\n\ncd_idx = test_cds.index('201')\nflat_idx = cd_idx * len(household_ids) + hh_idx\nw[flat_idx] = 3.5\n\n# Create a folder for the outputs of the function that is to come.\nnew_folder_name = \"calibration_output\"\nos.makedirs(new_folder_name, exist_ok=True)\noutput_path = os.path.join(new_folder_name, \"results.h5\")","key":"WGgDIxyxDD"},{"type":"outputs","id":"anu4tZnUpNQT9t825Vpzq","children":[],"key":"XSeXQD4bBF"}],"key":"xgZPfFkLgC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cd_subset = ['3701', '201']\ncreate_sparse_cd_stacked_dataset(\n    w,\n    test_cds, # cds_to_calibrate - Defines the structure of the weight vector w\n    cd_subset=cd_subset, #  cd_subset - Specifies which CDs to actually include in the output dataset (optional, defaults to all).\n    dataset_path=dataset_path,\n    output_path=output_path,\n)","key":"XSBnZOw8As"},{"type":"outputs","id":"76fwvVn5BYzp95iMxTi07","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Processing subset of 2 CDs: 3701, 201...\nOutput path: calibration_output/results.h5\n\nOriginal dataset has 11,999 households\nExtracted weights for 2 CDs from full weight matrix\nTotal active household-CD pairs: 230\nTotal weight in W matrix: 234\nProcessing CD 201 (2/2)...\n\nCombining 2 CD DataFrames...\nTotal households across all CDs: 230\nCombined DataFrame shape: (578, 222)\n\nReindexing all entity IDs using 25k ranges per CD...\n  Created 230 unique households across 2 CDs\n  Reindexing persons using 25k ranges...\n  Reindexing tax units...\n  Reindexing SPM units...\n  Reindexing marital units...\n  Reindexing families...\n  Final persons: 578\n  Final households: 230\n  Final tax units: 314\n  Final SPM units: 236\n  Final marital units: 461\n  Final families: 249\n\nWeights in combined_df AFTER reindexing:\n  HH weight sum: 0.00M\n  Person weight sum: 0.00M\n  Ratio: 1.00\n\nOverflow check:\n  Max person ID after reindexing: 5,125,285\n  Max person ID × 100: 512,528,500\n  int32 max: 2,147,483,647\n  ✓ No overflow risk!\n\nCreating Dataset from combined DataFrame...\nBuilding simulation from Dataset...\n\nSaving to calibration_output/results.h5...\nFound 175 input variables to save\nVariables saved: 218\nVariables skipped: 3763\nSparse CD-stacked dataset saved successfully!\nHousehold mapping saved to calibration_output/mappings/results_household_mapping.csv\n\nVerifying saved file...\n  Final households: 230\n  Final persons: 578\n  Total population (from household weights): 234\n"},"children":[],"key":"OeZWMx0Aaw"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":15,"metadata":{},"data":{"text/plain":{"content":"'calibration_output/results.h5'","content_type":"text/plain"}}},"children":[],"key":"nHcqxR9P9t"}],"key":"Ug0QThYNpi"}],"key":"pf7Ozttnyr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%ls calibration_output","key":"DYU6iD6Bi6"},{"type":"outputs","id":"sOvLKcFUR87OORN0NqSpp","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\u001b[34mmappings\u001b[m\u001b[m/   results.h5\n"},"children":[],"key":"iMn7kZm2iG"}],"key":"oOLHIC1PHI"}],"key":"swaVaBS1jl"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note that there is a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jo3sNI3NO7"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"mappings","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rl1mJGrFLc"}],"key":"D5xbE0Wvlj"},{"type":"text","value":" directory that has also been created by create_sparse_cd_stacked_dataset. This contains the CSV file that links the original households to the donor households. The reason it’s a seperate folder is to keep the h5 files and the mapping CSVs organized when this function is run for all districts or states.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lE3wAQmCeg"}],"key":"rNw6MPaCTF"}],"key":"eq5ohCPbDu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%ls calibration_output/mappings","key":"YkmHhHr6r2"},{"type":"outputs","id":"MvO1qqCZ0DSlAXELxiMJC","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"results_household_mapping.csv\n"},"children":[],"key":"XLRJITdnsX"}],"key":"TSkwqwo4uA"}],"key":"tmhjmaxiqR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim_after = Microsimulation(dataset=\"./calibration_output/results.h5\")\n\nhh_after_df =  pd.DataFrame(sim_after.calculate_dataframe([\n    \"household_id\", \"congressional_district_geoid\", \"county\", \"household_weight\", \"state_fips\", \"snap\"])                                        \n)\nprint(hh_after_df)","key":"pHtfSBWJoM"},{"type":"outputs","id":"9xbROII13KzyTuBvLPehr","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"     household_id  congressional_district_geoid  \\\n0           50000                           201   \n1           50001                           201   \n2           50002                           201   \n3           50003                           201   \n4           50004                           201   \n..            ...                           ...   \n225        125113                          3701   \n226        125114                          3701   \n227        125115                          3701   \n228        125116                          3701   \n229        125117                          3701   \n\n                              county  household_weight  state_fips  \\\n0             NORTH_SLOPE_BOROUGH_AK               3.5           2   \n1      ALEUTIANS_WEST_CENSUS_AREA_AK               1.0           2   \n2    FAIRBANKS_NORTH_STAR_BOROUGH_AK               1.0           2   \n3         KENAI_PENINSULA_BOROUGH_AK               1.0           2   \n4       HOONAH_ANGOON_CENSUS_AREA_AK               1.0           2   \n..                               ...               ...         ...   \n225                TYRRELL_COUNTY_NC               1.0          37   \n226                 WILSON_COUNTY_NC               1.0          37   \n227                 WARREN_COUNTY_NC               1.0          37   \n228                 WILSON_COUNTY_NC               1.0          37   \n229                 GREENE_COUNTY_NC               1.0          37   \n\n            snap  \n0       0.000000  \n1       0.000000  \n2       0.000000  \n3       0.000000  \n4       0.000000  \n..           ...  \n225     0.000000  \n226  3438.300293  \n227     0.000000  \n228     0.000000  \n229   885.599792  \n\n[230 rows x 6 columns]\n"},"children":[],"key":"Hwlz4UmBWI"}],"key":"mNwZSffoVg"}],"key":"clIbc5Y91S"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can see one of the correct instances above but let’s confirm that this new household id does in fact link back to the original in both cases.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"j88nHnsqu5"}],"key":"zOdq5jlMXc"}],"key":"eS7n0uqFCd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"mapping_df = pd.read_csv(\"calibration_output/mappings/results_household_mapping.csv\")\nmapping_df.loc[mapping_df.original_household_id == hh_id]","key":"D9NwsB4aIj"},{"type":"outputs","id":"Zmaj0dSlh-ysvnzSVS91c","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":19,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>new_household_id</th>\n      <th>original_household_id</th>\n      <th>congressional_district</th>\n      <th>state_fips</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>50000</td>\n      <td>654</td>\n      <td>201</td>\n      <td>2</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>125000</td>\n      <td>654</td>\n      <td>3701</td>\n      <td>37</td>\n    </tr>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"   new_household_id  original_household_id  congressional_district  state_fips\n0             50000                    654                     201           2\n1            125000                    654                    3701          37","content_type":"text/plain"}}},"children":[],"key":"Qham7dRmO3"}],"key":"zdCdewHMs4"}],"key":"TqzwQeEHp8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"new_hh_ids = mapping_df.loc[mapping_df.original_household_id == hh_id].new_household_id\nhh_after_df.loc[hh_after_df.household_id.isin(new_hh_ids)]","key":"zlxQGgGBGz"},{"type":"outputs","id":"NdfBGNMNVivLKedm18tCV","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":20,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>household_id</th>\n      <th>congressional_district_geoid</th>\n      <th>county</th>\n      <th>household_weight</th>\n      <th>state_fips</th>\n      <th>snap</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>50000</td>\n      <td>201</td>\n      <td>NORTH_SLOPE_BOROUGH_AK</td>\n      <td>3.5</td>\n      <td>2</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>112</th>\n      <td>125000</td>\n      <td>3701</td>\n      <td>HALIFAX_COUNTY_NC</td>\n      <td>2.5</td>\n      <td>37</td>\n      <td>70.080002</td>\n    </tr>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"     household_id  congressional_district_geoid                  county  \\\n0           50000                           201  NORTH_SLOPE_BOROUGH_AK   \n112        125000                          3701       HALIFAX_COUNTY_NC   \n\n     household_weight  state_fips       snap  \n0                 3.5           2   0.000000  \n112               2.5          37  70.080002  ","content_type":"text/plain"}}},"children":[],"key":"FL852IkmgP"}],"key":"BCAVDRy2Yj"}],"key":"tVwVC8qiKb"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And we can see that the snap numbers still match their values from the different US state systems. However note that due to the use of policyengine-core’s random function in a component of snap_gross_income, for some households, the value in the final simulation will not match the one used in creating the X matrix (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PLqUeR0j2K"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gKff8Jj2Tr"},{"type":"text","value":" here). This is outlined in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"R8SS6vxpct"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-core/issues/412","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Issue 412","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jyzEfhlcHf"}],"urlSource":"https://github.com/PolicyEngine/policyengine-core/issues/412","data":{"kind":"issue","org":"PolicyEngine","repo":"policyengine-core","issue_number":"412"},"internal":false,"protocol":"github","key":"TmfCOaccuW"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sVbeInbIZp"}],"key":"lZjAt1nApA"}],"key":"HOTcUDsXxq"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%rm -r calibration_output","key":"PxRQ9pfFBh"},{"type":"outputs","id":"j1dsjXXTCS4YfvEYesiTS","children":[],"key":"eJTsGQmhYb"}],"key":"SBPoFZ4kIW"}],"key":"KYl8IwzZZV"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Long Term Projections","url":"/long-term-projections","group":"PolicyEngine US Data"},"next":{"title":"Discussion","url":"/discussion","group":"PolicyEngine US Data"}}},"domain":"http://localhost:3000"}