{"version":3,"kind":"Notebook","sha256":"c744718bcddf6e398832be61f37693cdff4f67b57a765775e7354be7e2d28206","slug":"local-area-calibration-setup","location":"/local_area_calibration_setup.ipynb","dependencies":[],"frontmatter":{"title":"Local Area Calibration Setup","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","source_url":"https://github.com/policyengine/policyengine-us-data/blob/main/docs/local_area_calibration_setup.ipynb","edit_url":"https://github.com/policyengine/policyengine-us-data/edit/main/docs/local_area_calibration_setup.ipynb","exports":[{"format":"ipynb","filename":"local_area_calibration_setup.ipynb","url":"/policyengine-us-data/build/local_area_calibrati-b768cd3d5cb58989f7f47f8f4ae05adf.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates the sparse matrix construction for local area (congressional district) calibration. It uses a subset of CDs from NC, HI, MT, and AK for manageable runtime.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mkaln5gaeA"}],"key":"Oynq4yHX2S"}],"key":"DGcvwYoLu7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 1: Setup & Configuration","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qrgtNEGL2b"}],"identifier":"section-1-setup-configuration","label":"Section 1: Setup & Configuration","html_id":"section-1-setup-configuration","implicit":true,"key":"pkaJWgzHbX"}],"key":"smdjHGXM9S"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from sqlalchemy import create_engine, text\nimport pandas as pd\nimport numpy as np\n\nfrom policyengine_us import Microsimulation\nfrom policyengine_us_data.storage import STORAGE_FOLDER\nfrom policyengine_us_data.datasets.cps.local_area_calibration.sparse_matrix_builder import (\n    SparseMatrixBuilder,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.matrix_tracer import (\n    MatrixTracer,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.calibration_utils import (\n    get_calculated_variables,\n    create_target_groups,\n)","key":"sqKPOkosFQ"},{"type":"outputs","id":"-ELCL4BAa3DPY9x23LJiN","children":[],"key":"SMPU4YJ20R"}],"key":"THTbQI65V2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"db_path = STORAGE_FOLDER / \"policy_data.db\"\ndb_uri = f\"sqlite:///{db_path}\"\ndataset_path = str(STORAGE_FOLDER / \"stratified_extended_cps_2023.h5\")\n\nengine = create_engine(db_uri)","key":"CsDFxrMIxv"},{"type":"outputs","id":"EGEZ0IprsBM8Mur26hn2e","children":[],"key":"UQUajouAEW"}],"key":"EE9qqWTieX"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 2: Select Test Congressional Districts","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"R2GnCINfma"}],"identifier":"section-2-select-test-congressional-districts","label":"Section 2: Select Test Congressional Districts","html_id":"section-2-select-test-congressional-districts","implicit":true,"key":"YupPM4k4ML"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We use CDs from 4 states for testing:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yUp6UivHHt"}],"key":"Rl3q207k8E"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"NC (37)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"BlYmnfdpNz"}],"key":"PG1mDPJfWq"},{"type":"text","value":": 14 CDs (3701-3714) - provides same-state different-CD test cases","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"CImDRBV1Q2"}],"key":"uNXKSYm2jY"}],"key":"ePs15MV6gB"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"HI (15)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"mw7VuXrIeH"}],"key":"ODlgUyFZxB"},{"type":"text","value":": 2 CDs (1501-1502)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"hN3EZ2triY"}],"key":"Q2gQgax1DX"}],"key":"d1PyUMwVdc"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"MT (30)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"LTCqlI7bTn"}],"key":"BtnVEANUGG"},{"type":"text","value":": 2 CDs (3001-3002)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"tHuHcf4gjZ"}],"key":"dS2g3IaOd6"}],"key":"v3C0JkwF8a"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"AK (2)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Dmk7eJ2XlK"}],"key":"JBI2YweCfF"},{"type":"text","value":": 1 CD (200)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lEYhgaAQR6"}],"key":"Oal3a3lBAr"}],"key":"F2cY5ggFjO"}],"key":"RoC7d7UPrA"}],"key":"qslnx7guyB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"query = \"\"\"\nSELECT DISTINCT sc.value as cd_geoid\nFROM strata s\nJOIN stratum_constraints sc ON s.stratum_id = sc.stratum_id\nWHERE s.stratum_group_id = 1\n  AND sc.constraint_variable = 'congressional_district_geoid'\n  AND (\n    sc.value LIKE '37__'\n    OR sc.value LIKE '150_'\n    OR sc.value LIKE '300_'\n    OR sc.value = '200' OR sc.value = '201'\n  )\nORDER BY sc.value\n\"\"\"\n\nwith engine.connect() as conn:\n    result = conn.execute(text(query)).fetchall()\n    test_cds = [row[0] for row in result]\n\nprint(f\"Testing with {len(test_cds)} congressional districts:\")\nprint(f\"  NC (37): {[cd for cd in test_cds if cd.startswith('37')]}\")\nprint(f\"  HI (15): {[cd for cd in test_cds if cd.startswith('15')]}\")\nprint(f\"  MT (30): {[cd for cd in test_cds if cd.startswith('30')]}\")\nprint(f\"  AK (2):  {[cd for cd in test_cds if cd.startswith('20')]}\")","key":"zaLLn37TRN"},{"type":"outputs","id":"4hYiGLaPgtxYxIeeGFQt2","children":[],"key":"uJlPWpdYUe"}],"key":"uuBUBJFYzF"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 3: Build the Sparse Matrix","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mvGc9KnlDZ"}],"identifier":"section-3-build-the-sparse-matrix","label":"Section 3: Build the Sparse Matrix","html_id":"section-3-build-the-sparse-matrix","implicit":true,"key":"s2XtvIhUpK"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The sparse matrix ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"G6f46tnqTR"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zCD6yiRvRB"},{"type":"text","value":" has:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"rz9FmyETeA"}],"key":"OIJ1nsnWzA"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Rows","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ciDiaF87Hx"}],"key":"yPYTI186MB"},{"type":"text","value":": Calibration targets (e.g., SNAP totals by geography)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ifNEwdXejf"}],"key":"y1WhztMoDH"}],"key":"ZY8qbwi6I6"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Columns","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yH7clKmgGc"}],"key":"Z3sjiQJQ8B"},{"type":"text","value":": (household × CD) pairs - each household appears once per CD","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"z5nc8p9pYE"}],"key":"cP7PYYxaBx"}],"key":"dc1DzskffW"}],"key":"z9WX7LQK6t"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We filter to SNAP targets only (stratum_group_id=4) for this demonstration.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jHtyHkBVXg"}],"key":"jHUEj5yZsq"}],"key":"ohKgSDpbmm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim = Microsimulation(dataset=dataset_path)\n\nbuilder = SparseMatrixBuilder(\n    db_uri,\n    time_period=2023,\n    cds_to_calibrate=test_cds,\n    dataset_path=dataset_path,\n)\n\ntargets_df, X_sparse, household_id_mapping = builder.build_matrix(\n    sim, target_filter={\"stratum_group_ids\": [4], \"variables\": [\"snap\"]}\n)\n\nprint(f\"X_sparse shape: {X_sparse.shape}\")\nprint(f\"  Rows (targets): {X_sparse.shape[0]}\")\nprint(f\"  Columns (household × CD pairs): {X_sparse.shape[1]}\")\nprint(f\"  Non-zero entries: {X_sparse.nnz:,}\")\nprint(f\"  Sparsity: {1 - X_sparse.nnz / (X_sparse.shape[0] * X_sparse.shape[1]):.2%}\")","key":"RuNYtkXFa3"},{"type":"outputs","id":"sr2_JeQLmBeK36-bfmMrG","children":[],"key":"dMf7b2AjVs"}],"key":"rFmy06WlFA"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 4: Understanding the Matrix Structure with MatrixTracer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pdlfbZtVhl"}],"identifier":"section-4-understanding-the-matrix-structure-with-matrixtracer","label":"Section 4: Understanding the Matrix Structure with MatrixTracer","html_id":"section-4-understanding-the-matrix-structure-with-matrixtracer","implicit":true,"key":"q17yXTFyJH"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"I5a7fGqRsG"},{"type":"inlineCode","value":"MatrixTracer","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Be2Zb2xrNZ"},{"type":"text","value":" helps navigate the sparse matrix by providing lookups between:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ot8lwBFmAK"}],"key":"zntgvT85iQ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Column indices ↔ (household_id, CD) pairs","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"rtZJ4EQCVv"}],"key":"fVWc9oLx01"}],"key":"iOORaulNC9"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Row indices ↔ target definitions","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"NfweEAVlHp"}],"key":"T432Ef8qDr"}],"key":"WD54DZoTmB"}],"key":"RozSqnf0Aa"}],"key":"U8JLMOHNPu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracer = MatrixTracer(\n    targets_df, X_sparse, household_id_mapping, test_cds, sim\n)\n\ntracer.print_matrix_structure()","key":"UxppCnpOqf"},{"type":"outputs","id":"u5xzR8L5ba1S1H9jaQ3d3","children":[],"key":"hZ2ZnNBJBz"}],"key":"DnWH5zQhEA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_groups, group_info = create_target_groups(targets_df)","key":"kRIYP3Rtnk"},{"type":"outputs","id":"jtGM6Pli5TphKiSRdFP2B","children":[],"key":"iYwS8GN6di"}],"key":"W3xcccVR2l"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nrow_loc = target_group.iloc[28]['row_index']  # Manually found the index value 28\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for North Carolina's SNAP benefit amount:\")\nprint(row_info)","key":"hGnjjr4dOu"},{"type":"outputs","id":"VSab16NDMH3lpgagNVNQv","children":[],"key":"TWAEZmOaar"}],"key":"HEbuf0FeWQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hh_snap_df = pd.DataFrame(sim.calculate_dataframe([\n    \"household_id\", \"household_weight\", \"state_fips\", \"snap\"])                                        \n)\nprint(hh_snap_df)","key":"wkssr1s6cJ"},{"type":"outputs","id":"vQjY9SewEnpGKi6Cmtoq7","children":[],"key":"yTMFksQLwP"}],"key":"TqMovPAUtE"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If we were to include ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ifo9iQi9Y2"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PGX9MrHRXP"},{"type":"text","value":" above, they would all be zeros. It’s not until we do the calibration, i.e., come back with a vector of weights ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hz5u58rIBI"},{"type":"inlineCode","value":"w","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mowSiquXMY"},{"type":"text","value":" to multiply ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AO8aFVVoyN"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QyDp6wcuqO"},{"type":"text","value":" with, that we will set ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LM9ryyscrW"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xHKVnLhCZo"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"My5P5HsANv"}],"key":"Kgi6LtqUjj"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"However, every household is already a donor to every contressional district. You can get the column positions for every household (remember targets are on the rows, donor households on the columns) by running tracer’s get_household_column_positions with the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dyQHqngS9R"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"original","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qTGNYWUUnw"}],"key":"JXkB3nmB1T"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"t7hbc1V71d"},{"type":"inlineCode","value":"household_id","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dHDUEnpQL6"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aBp6Eit3j9"}],"key":"U8VBT3xOl3"}],"key":"rk6SUjcECW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Reverse lookup: get all column positions for a specific household\nhh_id = hh_snap_df.loc[hh_snap_df.snap > 0].household_id.values[0]\nprint(hh_snap_df.loc[hh_snap_df.household_id == hh_id])\n\nprint(\"\\nEvaluating the tracer.get_household_column_positions dictionary:\\n\")\npositions = tracer.get_household_column_positions(hh_id)\nprint(positions)","key":"KCmlMyLIZf"},{"type":"outputs","id":"Z42Gl-T0d827DdSh46ihT","children":[],"key":"iwdeCD3xOv"}],"key":"Cu5YSLIUVS"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yvGVPvOvmg"}],"identifier":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","label":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","html_id":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","implicit":true,"key":"a0kd1kw5GQ"}],"key":"P3I0oMan31"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"Remember, this is a North Carolina target:\\n\")\nprint(targets_df.iloc[row_loc])\n\nprint(\"\\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['3702']])  # Household donated to NC's 2nd district\n\nprint(\"\\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['201']])  # Household donated to AK's at Large District","key":"qdiOEBJg4l"},{"type":"outputs","id":"-JxQAHerWQKQTJ4GOKO1Z","children":[],"key":"oF6SmlQV5V"}],"key":"iOxgtnYVtX"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Key property: For state-level targets, only CDs in that state should have non-zero values.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TxNvTEinGY"}],"key":"g8DyyHgSdW"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Example: A NC state SNAP target should have zeros for HI, MT, and AK CD columns.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"h5fzbmI18O"}],"key":"DTtSOMFre7"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"So let’s see that same household’s value for the Alaska state target:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"TnePG7feD4"}],"key":"TsNHGdhmu5"}],"key":"NocWhi4oOQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nnew_row_loc = target_group.iloc[10]['row_index']   # Manually found the index value 10\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for Alaska's SNAP benefit amount:\")\nprint(row_info)","key":"FFoZJThEqI"},{"type":"outputs","id":"oyArMjHNX2hRwLmPJFvDI","children":[],"key":"Ip9uBpowpJ"}],"key":"PM9mm7sBIp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"\\nHousehold donated to AK's 1st district, 2023 SNAP dollars:\")\nprint(X_sparse[new_row_loc, positions['201']])  # Household donated to AK's at Large District","key":"ZBeymr40Kn"},{"type":"outputs","id":"WbCwk3mN-aMRAOCugFDlN","children":[],"key":"qIBRU1uoR3"}],"key":"twoDJwfdNY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 6: Simulating State-Swapped Calculations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"viUgW8cZZC"}],"identifier":"section-6-simulating-state-swapped-calculations","label":"Section 6: Simulating State-Swapped Calculations","html_id":"section-6-simulating-state-swapped-calculations","implicit":true,"key":"tXUDukmUKg"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When a household is “transplanted” to a different state, state-dependent benefits like SNAP are recalculated under the destination state’s rules.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hPm6qOBxbl"}],"key":"hYE1OABX6J"}],"key":"g85f07pb2r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def create_state_simulation(state_fips):\n    \"\"\"Create a simulation with all households assigned to a specific state.\"\"\"\n    s = Microsimulation(dataset=dataset_path)\n    s.set_input(\n        \"state_fips\", 2023, np.full(hh_snap_df.shape[0], state_fips, dtype=np.int32)\n    )\n    for var in get_calculated_variables(s):\n        s.delete_arrays(var)\n    return s\n\n# Compare SNAP for first 5 households under NC vs AK rules\nnc_sim = create_state_simulation(37)  # NC\nak_sim = create_state_simulation(2)   # AK\n\nnc_snap = nc_sim.calculate(\"snap\", map_to=\"household\").values[:5]\nak_snap = ak_sim.calculate(\"snap\", map_to=\"household\").values[:5]\n\nprint(\"SNAP values for first 5 households under different state rules:\")\nprint(f\"  NC rules: {nc_snap}\")\nprint(f\"  AK rules: {ak_snap}\")\nprint(f\"  Difference: {ak_snap - nc_snap}\")","key":"BwTSaf1y6Q"},{"type":"outputs","id":"C2LxFvD8xF4llZAcs_tnO","children":[],"key":"HLEOiuXMHe"}],"key":"hreJAG8tvR"}],"key":"DpnqjiEDnr"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Methodology","url":"/methodology","group":"PolicyEngine US Data"},"next":{"title":"Long Term Projections","url":"/long-term-projections","group":"PolicyEngine US Data"}}},"domain":"http://localhost:3000"}