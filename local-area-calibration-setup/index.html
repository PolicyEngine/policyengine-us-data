<!DOCTYPE html><html lang="en" class="" style="scroll-padding:60px"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Local Area Calibration Setup - PolicyEngine US Data</title><meta property="og:title" content="Local Area Calibration Setup - PolicyEngine US Data"/><meta name="generator" content="mystmd"/><meta name="keywords" content=""/><link rel="stylesheet" href="/policyengine-us-data/build/_assets/app-OIHP3NGU.css"/><link rel="stylesheet" href="/policyengine-us-data/build/_assets/thebe-core-VKVHG5VY.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jupyter-matplotlib@0.11.3/css/mpl_widget.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous"/><link rel="icon" href="/policyengine-us-data/favicon.ico"/><link rel="stylesheet" href="/policyengine-us-data/myst-theme.css"/><script>
  const savedTheme = localStorage.getItem("myst:theme");
  const theme = window.matchMedia("(prefers-color-scheme: light)").matches ? 'light' : 'dark';
  const classes = document.documentElement.classList;
  const hasAnyTheme = classes.contains('light') || classes.contains('dark');
  if (!hasAnyTheme) classes.add(savedTheme ?? theme);
</script></head><body class="m-0 transition-colors duration-500 bg-white dark:bg-stone-900"><div class="myst-skip-to-article fixed top-1 left-1 h-[0px] w-[0px] focus-within:z-40 focus-within:h-auto focus-within:w-auto bg-white overflow-hidden focus-within:p-2 focus-within:ring-1" aria-label="skip to content options"><a href="#skip-to-frontmatter" class="myst-skip-to-link block px-2 py-1 text-black underline">Skip to article frontmatter</a><a href="#skip-to-article" class="myst-skip-to-link block px-2 py-1 text-black underline">Skip to article content</a></div><dialog id="myst-no-css" style="position:fixed;left:0px;top:0px;width:100vw;height:100vh;font-size:4rem;padding:1rem;color:black;background:white"><strong>Site not loading correctly?</strong><p>This may be due to an incorrect <code>BASE_URL</code> configuration. See<!-- --> <a href="https://mystmd.org/guide/deployment#deploy-base-url">the MyST Documentation</a> <!-- -->for reference.</p><script>
    (() => {
            // Test for has-styling variable set by the MyST stylesheet
            const node = document.currentScript.parentNode;
            const hasCSS = window.getComputedStyle(node).getPropertyValue("--has-styling");
            if (hasCSS === ""){
                    node.showModal();
            }

    })()
</script></dialog><div class="myst-top-nav bg-white/80 backdrop-blur dark:bg-stone-900/80 shadow dark:shadow-stone-700 p-3 md:px-8 sticky w-screen top-0 z-30 h-[60px]"><nav class="myst-top-nav-bar flex items-center justify-between flex-nowrap max-w-[1440px] mx-auto"><div class="flex flex-row xl:min-w-[19.5rem] mr-2 sm:mr-7 justify-start items-center shrink-0"><div class="block xl:hidden"><button class="myst-top-nav-menu-button flex items-center justify-center border-stone-400 text-stone-800 hover:text-stone-900 dark:text-stone-200 hover:dark:text-stone-100 w-10 h-10"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" width="1.5rem" height="1.5rem"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd"></path></svg><span class="sr-only">Open Menu</span></button></div><a class="myst-home-link flex items-center ml-3 dark:text-white w-fit md:ml-5 xl:ml-7" href="/policyengine-us-data/"><div class="myst-home-link-logo mr-3 flex items-center dark:bg-white dark:rounded px-1"><img src="/policyengine-us-data/build/logo-3819769fbc672330a888a5cbb49b5159.png" class="h-9" height="2.25rem"/></div><span class="text-md sm:text-xl tracking-tight sm:mr-5 sr-only">Made with MyST</span></a></div><div class="flex items-center flex-grow w-auto"><div class="flex-grow hidden text-md lg:block"></div><div class="flex-grow block"></div><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R75cp:" data-state="closed" class="myst-search-bar flex items-center h-10 aspect-square sm:w-64 text-left text-gray-600 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 myst-search-bar-disabled hover:ring-blue-500 dark:hover:ring-blue-500 hover:border-blue-500 dark:hover:border-blue-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="p-2.5 h-10 w-10 aspect-square"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd"></path></svg><span class="myst-search-text-placeholder hidden sm:block grow">Search</span><div aria-hidden="true" class="myst-search-shortcut items-center hidden mx-1 font-mono text-sm text-gray-600 sm:flex gap-x-1"><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none hide-mac">CTRL</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none show-mac">⌘</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none ">K</kbd><script>
;(() => {
const script = document.currentScript;
const root = script.parentElement;

const isMac = /mac/i.test(
      window.navigator.userAgentData?.platform ?? window.navigator.userAgent,
    );
root.querySelectorAll(".hide-mac").forEach(node => {node.classList.add(isMac ? "hidden" : "block")});
root.querySelectorAll(".show-mac").forEach(node => {node.classList.add(!isMac ? "hidden" : "block")});
})()</script></div></button><button class="myst-theme-button theme rounded-full aspect-square border border-stone-700 dark:border-white hover:bg-neutral-100 border-solid overflow-hidden text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 w-10 h-10 mx-3" title="Toggle theme between light and dark mode" aria-label="Toggle theme between light and dark mode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="myst-theme-moon-icon h-full w-full p-0.5 hidden dark:block"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd"></path></svg><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="myst-theme-sun-icon h-full w-full p-0.5 dark:hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"></path></svg></button><div class="block sm:hidden"></div><div class="hidden sm:block"></div></div></nav></div><div class="myst-primary-sidebar fixed xl:article-grid grid-gap xl:w-screen xl:pointer-events-none overflow-auto max-xl:min-w-[300px] hidden z-10" style="top:60px"><div class="myst-primary-sidebar-pointer pointer-events-auto xl:col-margin-left flex-col overflow-hidden hidden xl:flex"><div class="myst-primary-sidebar-nav flex-grow py-6 overflow-y-auto primary-scrollbar"><nav aria-label="Navigation" class="myst-primary-sidebar-topnav overflow-y-hidden transition-opacity ml-3 xl:ml-0 mr-3 max-w-[350px] lg:hidden"><div class="w-full px-1 dark:text-white font-medium"></div></nav><div class="my-3 border-b-2 lg:hidden"></div><nav aria-label="Table of Contents" class="myst-primary-sidebar-toc flex-grow overflow-y-hidden transition-opacity ml-3 xl:ml-0 mr-3 max-w-[350px]"><div class="myst-toc w-full px-1 dark:text-white"><a title="PolicyEngine US Data" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30 font-bold" href="/policyengine-us-data/">PolicyEngine US Data</a><a title="Introduction" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/introduction">Introduction</a><a title="Background" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/background">Background</a><a title="Data Sources" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/data">Data Sources</a><a title="Methodology" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/methodology">Methodology</a><a title="Long Term Projections" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/long-term-projections">Long Term Projections</a><a title="Local Area Calibration Setup" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/local-area-calibration-setup">Local Area Calibration Setup</a><a title="Discussion" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/discussion">Discussion</a><a title="Conclusion" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/conclusion">Conclusion</a><a title="Appendix" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/policyengine-us-data/appendix">Appendix</a></div></nav></div><div class="myst-primary-sidebar-footer flex-none py-6 transition-all duration-700 translate-y-6 opacity-0"><a class="myst-made-with-myst flex mx-auto text-gray-700 w-fit hover:text-blue-700 dark:text-gray-200 dark:hover:text-blue-400" href="https://mystmd.org/made-with-myst" target="_blank" rel="noreferrer"><svg style="width:24px;height:24px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" stroke="none"><g id="icon"><path fill="currentColor" d="M23.8,54.8v-3.6l4.7-0.8V17.5l-4.7-0.8V13H36l13.4,31.7h0.2l13-31.7h12.6v3.6l-4.7,0.8v32.9l4.7,0.8v3.6h-15
          v-3.6l4.9-0.8V20.8H65L51.4,53.3h-3.8l-14-32.5h-0.1l0.2,17.4v12.1l5,0.8v3.6H23.8z"></path><path fill="#F37726" d="M47,86.9c0-5.9-3.4-8.8-10.1-8.8h-8.4c-5.2,0-9.4-1.3-12.5-3.8c-3.1-2.5-5.4-6.2-6.8-11l4.8-1.6
          c1.8,5.6,6.4,8.6,13.8,8.8h9.2c6.4,0,10.8,2.5,13.1,7.5c2.3-5,6.7-7.5,13.1-7.5h8.4c7.8,0,12.7-2.9,14.6-8.7l4.8,1.6
          c-1.4,4.9-3.6,8.6-6.8,11.1c-3.1,2.5-7.3,3.7-12.4,3.8H63c-6.7,0-10,2.9-10,8.8"></path></g></svg><span class="self-center ml-2 text-sm">Made with MyST</span></a></div></div></div><main class="article-grid grid-gap"><article class="article-grid subgrid-gap col-screen article content"><div class="hidden"></div><div id="skip-to-frontmatter" aria-label="article frontmatter" class="myst-fm-block mb-8 pt-9"><div class="myst-fm-block-header flex items-center mb-5 h-6 text-sm font-light"><div class="flex-grow"></div><div class="myst-fm-block-badges"><a href="https://github.com/policyengine/policyengine-us-data" title="GitHub Repository: policyengine/policyengine-us-data" target="_blank" rel="noopener noreferrer" class="myst-fm-github-link text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem" class="myst-fm-github-icon inline-block mr-1 opacity-60 hover:opacity-100"><path d="M12 2.5c-5.4 0-9.8 4.4-9.8 9.7 0 4.3 2.8 8 6.7 9.2.5.1.7-.2.7-.5v-1.8c-2.4.5-3.1-.6-3.3-1.1-.1-.3-.6-1.1-1-1.4-.3-.2-.8-.6 0-.6s1.3.7 1.5 1c.9 1.5 2.3 1.1 2.8.8.1-.6.3-1.1.6-1.3-2.2-.2-4.4-1.1-4.4-4.8 0-1.1.4-1.9 1-2.6-.1-.2-.4-1.2.1-2.6 0 0 .8-.3 2.7 1 .8-.2 1.6-.3 2.4-.3.8 0 1.7.1 2.4.3 1.9-1.3 2.7-1 2.7-1 .5 1.3.2 2.3.1 2.6.6.7 1 1.5 1 2.6 0 3.7-2.3 4.6-4.4 4.8.4.3.7.9.7 1.8V21c0 .3.2.6.7.5 3.9-1.3 6.6-4.9 6.6-9.2 0-5.4-4.4-9.8-9.8-9.8z"></path></svg></a></div><a href="https://github.com/policyengine/policyengine-us-data/edit/main/docs/local_area_calibration_setup.ipynb" title="Edit This Page" target="_blank" rel="noopener noreferrer" class="myst-fm-edit-link text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem" class="myst-fm-edit-icon inline-block mr-1 opacity-60 hover:opacity-100"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"></path></svg></a><div class="myst-fm-downloads-dropdown relative flex inline-block mx-1 grow-0" data-headlessui-state=""><button class="myst-fm-downloads-button relative ml-2 -mr-1" id="headlessui-menu-button-:Rs8ucp:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Downloads</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem" class="myst-fm-downloads-icon"><title>Download</title><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg></button></div></div><h1 class="myst-fm-block-title mb-0">Local Area Calibration Setup</h1><header class="myst-fm-authors-affiliations mt-4 not-prose"><div class="myst-fm-authors-list"><span class="myst-fm-author font-semibold text-sm myst-fm-author-item inline-block"><button class="myst-fm-author-popover focus:shadow-[0_0_0_2px] focus:shadow-black outline-none hover:underline" aria-label="Author Details" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R78ucp:" data-state="closed"><span class="myst-fm-author-name">PolicyEngine Team</span></button></span></div></header></div><div class="block my-10 lg:sticky lg:z-10 lg:h-0 lg:pt-0 lg:my-0 lg:ml-10 lg:col-margin-right" style="top:60px"><nav></nav></div><div id="skip-to-article"></div><div id="SWflHsDo1S" class="myst-jp-nb-block relative group/block"><p>This notebook demonstrates the sparse matrix construction for local area (congressional district) calibration. It uses a subset of CDs from NC, HI, MT, and AK for manageable runtime.</p></div><div id="yTrQIeddwl" class="myst-jp-nb-block relative group/block"><h2 id="section-1-setup-configuration" class="relative group"><span class="heading-text">Section 1: Setup &amp; Configuration</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#section-1-setup-configuration" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="WK6DT4fyac" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">from sqlalchemy import create_engine, text
import pandas as pd
import numpy as np

from policyengine_us import Microsimulation
from policyengine_us_data.storage import STORAGE_FOLDER
from policyengine_us_data.datasets.cps.local_area_calibration.sparse_matrix_builder import (
    SparseMatrixBuilder,
)
from policyengine_us_data.datasets.cps.local_area_calibration.matrix_tracer import (
    MatrixTracer,
)
from policyengine_us_data.datasets.cps.local_area_calibration.calibration_utils import (
    get_calculated_variables,
    create_target_groups,
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="XopmPZLCDuk_TdsTwtknI" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>/home/baogorek/envs/pe/lib/python3.13/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</span></code></pre></div></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>TEST_LITE == False
</span></code></pre></div></div></div></div><div id="VHEuYvpwCi" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">db_path = STORAGE_FOLDER / &quot;calibration&quot; / &quot;policy_data.db&quot;
db_uri = f&quot;sqlite:///{db_path}&quot;
dataset_path = str(STORAGE_FOLDER / &quot;stratified_extended_cps_2023.h5&quot;)

engine = create_engine(db_uri)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="ZCMYXBQEkCZMkVHTIhWCs" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="KumCWbfNy9" class="myst-jp-nb-block relative group/block"><h2 id="section-2-select-test-congressional-districts" class="relative group"><span class="heading-text">Section 2: Select Test Congressional Districts</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#section-2-select-test-congressional-districts" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>We use CDs from 4 states for testing:</p><ul><li><p><strong>NC (37)</strong>: 14 CDs (3701-3714) - provides same-state different-CD test cases</p></li><li><p><strong>HI (15)</strong>: 2 CDs (1501-1502)</p></li><li><p><strong>MT (30)</strong>: 2 CDs (3001-3002)</p></li><li><p><strong>AK (2)</strong>: 1 CD (200)</p></li></ul></div><div id="X7g0xGeosD" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">query = &quot;&quot;&quot;
SELECT DISTINCT sc.value as cd_geoid
FROM strata s
JOIN stratum_constraints sc ON s.stratum_id = sc.stratum_id
WHERE s.stratum_group_id = 1
  AND sc.constraint_variable = &#x27;congressional_district_geoid&#x27;
  AND (
    sc.value LIKE &#x27;37__&#x27;
    OR sc.value LIKE &#x27;150_&#x27;
    OR sc.value LIKE &#x27;300_&#x27;
    OR sc.value = &#x27;200&#x27; OR sc.value = &#x27;201&#x27;
  )
ORDER BY sc.value
&quot;&quot;&quot;

with engine.connect() as conn:
    result = conn.execute(text(query)).fetchall()
    test_cds = [row[0] for row in result]

print(f&quot;Testing with {len(test_cds)} congressional districts:&quot;)
print(f&quot;  NC (37): {[cd for cd in test_cds if cd.startswith(&#x27;37&#x27;)]}&quot;)
print(f&quot;  HI (15): {[cd for cd in test_cds if cd.startswith(&#x27;15&#x27;)]}&quot;)
print(f&quot;  MT (30): {[cd for cd in test_cds if cd.startswith(&#x27;30&#x27;)]}&quot;)
print(f&quot;  AK (2):  {[cd for cd in test_cds if cd.startswith(&#x27;20&#x27;)]}&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="JcqfrzonScqUA0f2SiLKy" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>Testing with 19 congressional districts:
  NC (37): [&#x27;3701&#x27;, &#x27;3702&#x27;, &#x27;3703&#x27;, &#x27;3704&#x27;, &#x27;3705&#x27;, &#x27;3706&#x27;, &#x27;3707&#x27;, &#x27;3708&#x27;, &#x27;3709&#x27;, &#x27;3710&#x27;, &#x27;3711&#x27;, &#x27;3712&#x27;, &#x27;3713&#x27;, &#x27;3714&#x27;]
  HI (15): [&#x27;1501&#x27;, &#x27;1502&#x27;]
  MT (30): [&#x27;3001&#x27;, &#x27;3002&#x27;]
  AK (2):  [&#x27;201&#x27;]
</span></code></pre></div></div></div></div><div id="Hq2WmHJoCT" class="myst-jp-nb-block relative group/block"><h2 id="section-3-build-the-sparse-matrix" class="relative group"><span class="heading-text">Section 3: Build the Sparse Matrix</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#section-3-build-the-sparse-matrix" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>The sparse matrix <code>X_sparse</code> has:</p><ul><li><p><strong>Rows</strong>: Calibration targets (e.g., SNAP totals by geography)</p></li><li><p><strong>Columns</strong>: (household × CD) pairs - each household appears once per CD</p></li></ul><p>We filter to SNAP targets only (stratum_group_id=4) for this demonstration.</p></div><div id="rfJ7tX4INg" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">sim = Microsimulation(dataset=dataset_path)

builder = SparseMatrixBuilder(
    db_uri,
    time_period=2023,
    cds_to_calibrate=test_cds,
    dataset_path=dataset_path,
)

targets_df, X_sparse, household_id_mapping = builder.build_matrix(
    sim, target_filter={&quot;stratum_group_ids&quot;: [4], &quot;variables&quot;: [&quot;snap&quot;]}
)

print(f&quot;X_sparse shape: {X_sparse.shape}&quot;)
print(f&quot;  Rows (targets): {X_sparse.shape[0]}&quot;)
print(f&quot;  Columns (household × CD pairs): {X_sparse.shape[1]}&quot;)
print(f&quot;  Non-zero entries: {X_sparse.nnz:,}&quot;)
print(f&quot;  Sparsity: {1 - X_sparse.nnz / (X_sparse.shape[0] * X_sparse.shape[1]):.2%}&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="27Cgz_D0yXwaXbFcikTj0" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>X_sparse shape: (539, 256633)
  Rows (targets): 539
  Columns (household × CD pairs): 256633
  Non-zero entries: 67,756
  Sparsity: 99.95%
</span></code></pre></div></div></div></div><div id="UhADLNYSgo" class="myst-jp-nb-block relative group/block"><h2 id="section-4-understanding-the-matrix-structure-with-matrixtracer" class="relative group"><span class="heading-text">Section 4: Understanding the Matrix Structure with MatrixTracer</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#section-4-understanding-the-matrix-structure-with-matrixtracer" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>The <code>MatrixTracer</code> helps navigate the sparse matrix by providing lookups between:</p><ul><li><p>Column indices ↔ (household_id, CD) pairs</p></li><li><p>Row indices ↔ target definitions</p></li></ul></div><div id="zabZvB3XKx" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">tracer = MatrixTracer(
    targets_df, X_sparse, household_id_mapping, test_cds, sim
)

tracer.print_matrix_structure()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="-_WBgv3h-7okZGtVA6dA3" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>
================================================================================
MATRIX STRUCTURE BREAKDOWN
================================================================================

Matrix dimensions: 539 rows x 256633 columns
  Rows = 539 targets
  Columns = 13507 households x 19 CDs
           = 13,507 x 19 = 256,633

--------------------------------------------------------------------------------
COLUMN STRUCTURE (Households stacked by CD)
--------------------------------------------------------------------------------

Showing first and last 5 CDs of 19 total:

First 5 CDs:
cd_geoid  start_col  end_col  n_households
    1501          0    13506         13507
    1502      13507    27013         13507
     201      27014    40520         13507
    3001      40521    54027         13507
    3002      54028    67534         13507

Last 5 CDs:
cd_geoid  start_col  end_col  n_households
    3710     189098   202604         13507
    3711     202605   216111         13507
    3712     216112   229618         13507
    3713     229619   243125         13507
    3714     243126   256632         13507

--------------------------------------------------------------------------------
ROW STRUCTURE (Targets)
--------------------------------------------------------------------------------

Total targets: 539

Targets by stratum group:
                  n_targets  n_unique_vars
stratum_group_id                          
1                         1              1
4                       538              2

--------------------------------------------------------------------------------
TARGET GROUPS (for loss calculation)
--------------------------------------------------------------------------------

=== Creating Target Groups ===

National targets:
  Group 0: Snap = 107,062,860,000

State targets:
  Group 1: SNAP Household Count (51 targets)
  Group 2: Snap (51 targets)

District targets:
  Group 3: SNAP Household Count (436 targets)

Total groups created: 4
========================================
  Group 0: National Snap (1 target, value=107,062,860,000) - rows [0]
  Group 1: State SNAP Household Count (51 targets) - rows [1, 2, 3, ..., 50, 51]
  Group 2: State Snap (51 targets) - rows [52, 53, 54, ..., 101, 102]
  Group 3: District SNAP Household Count (436 targets) - rows [103, 104, 105, ..., 537, 538]

================================================================================
</span></code></pre></div></div></div></div><div id="lui3K8kkMI" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">target_groups, group_info = create_target_groups(targets_df)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="FrQfpSVE0oRMFqXGQJE0s" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>
=== Creating Target Groups ===

National targets:
  Group 0: Snap = 107,062,860,000

State targets:
  Group 1: SNAP Household Count (51 targets)
  Group 2: Snap (51 targets)

District targets:
  Group 3: SNAP Household Count (436 targets)

Total groups created: 4
========================================
</span></code></pre></div></div></div></div><div id="DSpe1zdIOk" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">target_group = tracer.get_group_rows(2)
row_loc = target_group.iloc[28][&#x27;row_index&#x27;]  # Manually found the index value 28
row_info = tracer.get_row_info(row_loc)
var = row_info[&#x27;variable&#x27;]
var_desc = row_info[&#x27;variable_desc&#x27;]
target_geo_id = int(row_info[&#x27;geographic_id&#x27;])

print(&quot;Row info for North Carolina&#x27;s SNAP benefit amount:&quot;)
print(row_info)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="nbRRgHNAp9fgW-a8JHpOR" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>Row info for North Carolina&#x27;s SNAP benefit amount:
{&#x27;row_index&#x27;: 80, &#x27;variable&#x27;: &#x27;snap&#x27;, &#x27;variable_desc&#x27;: &#x27;SNAP allotment&#x27;, &#x27;geographic_id&#x27;: &#x27;37&#x27;, &#x27;target_value&#x27;: 4041086120.0, &#x27;stratum_id&#x27;: 9799, &#x27;stratum_group_id&#x27;: 4}
</span></code></pre></div></div></div></div><div id="Xdq1yvRCRE" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">hh_snap_df = pd.DataFrame(sim.calculate_dataframe([
    &quot;household_id&quot;, &quot;household_weight&quot;, &quot;state_fips&quot;, &quot;snap&quot;])                                        
)
print(hh_snap_df)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="1jeN27Hkflt9fWBbNsA63" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>       household_id  household_weight  state_fips        snap
0                25       1229.699951          23  789.199951
1                76       3119.330078          23    0.000000
2                92       1368.089966          23    0.000000
3               110       1457.579956          23    0.000000
4               140       1445.209961          23    0.000000
...             ...               ...         ...         ...
13502        178916          0.000000          15    0.000000
13503        178918          0.000000          15    0.000000
13504        178926          0.000000          15    0.000000
13505        178935          0.000000          15    0.000000
13506        178945          0.000000          15    0.000000

[13507 rows x 4 columns]
</span></code></pre></div></div></div></div><div id="rMudk0lpiF" class="myst-jp-nb-block relative group/block"><p>If we were to include <code>congressional_district_geoid</code> above, they would all be zeros. It’s not until we do the calibration, i.e., come back with a vector of weights <code>w</code> to multiply <code>X_sparse</code> with, that we will set <code>congressional_district_geoid</code>.</p><p>However, every household is already a donor to every contressional district. You can get the column positions for every household (remember targets are on the rows, donor households on the columns) by running tracer’s get_household_column_positions with the <em>original</em> <code>household_id</code>.</p></div><div id="iIkn5nELsg" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Reverse lookup: get all column positions for a specific household
hh_id = hh_snap_df.loc[hh_snap_df.snap &gt; 0].household_id.values[0]
print(hh_snap_df.loc[hh_snap_df.household_id == hh_id])

print(&quot;\nEvaluating the tracer.get_household_column_positions dictionary:\n&quot;)
positions = tracer.get_household_column_positions(hh_id)
print(positions)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="-ufcjOKkt27UOk3pS8N5w" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>   household_id  household_weight  state_fips        snap
0            25       1229.699951          23  789.199951

Evaluating the tracer.get_household_column_positions dictionary:

{&#x27;1501&#x27;: 0, &#x27;1502&#x27;: 13507, &#x27;201&#x27;: 27014, &#x27;3001&#x27;: 40521, &#x27;3002&#x27;: 54028, &#x27;3701&#x27;: 67535, &#x27;3702&#x27;: 81042, &#x27;3703&#x27;: 94549, &#x27;3704&#x27;: 108056, &#x27;3705&#x27;: 121563, &#x27;3706&#x27;: 135070, &#x27;3707&#x27;: 148577, &#x27;3708&#x27;: 162084, &#x27;3709&#x27;: 175591, &#x27;3710&#x27;: 189098, &#x27;3711&#x27;: 202605, &#x27;3712&#x27;: 216112, &#x27;3713&#x27;: 229619, &#x27;3714&#x27;: 243126}
</span></code></pre></div></div></div></div><div id="TU9mVj15NP" class="myst-jp-nb-block relative group/block"><h2 id="section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector" class="relative group"><span class="heading-text">Section 5: Understanding the cells of the X_Sparse matrix and Target vector</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="Mwpkth2LAl" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">print(&quot;Remember, this is a North Carolina target:\n&quot;)
print(targets_df.iloc[row_loc])

print(&quot;\nHousehold donated to NC&#x27;s 2nd district, 2023 SNAP dollars:&quot;)
print(X_sparse[row_loc, positions[&#x27;3702&#x27;]])  # Household donated to NC&#x27;s 2nd district

print(&quot;\nHousehold donated to NC&#x27;s 2nd district, 2023 SNAP dollars:&quot;)
print(X_sparse[row_loc, positions[&#x27;201&#x27;]])  # Household donated to AK&#x27;s at Large District</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="QgsXhWKdd6EwjvFBweirV" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>Remember, this is a North Carolina target:

target_id                   9372
stratum_id                  9799
variable                    snap
value               4041086120.0
period                      2023
stratum_group_id               4
geographic_id                 37
Name: 80, dtype: object

Household donated to NC&#x27;s 2nd district, 2023 SNAP dollars:
789.19995

Household donated to NC&#x27;s 2nd district, 2023 SNAP dollars:
0.0
</span></code></pre></div></div></div></div><div id="LN5y1nxPT2" class="myst-jp-nb-block relative group/block"><p>Key property: For state-level targets, only CDs in that state should have non-zero values.</p><p>Example: A NC state SNAP target should have zeros for HI, MT, and AK CD columns.</p><p>So let’s see that same household’s value for the Alaska state target:</p></div><div id="GhqGdl7QnV" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">target_group = tracer.get_group_rows(2)
new_row_loc = target_group.iloc[10][&#x27;row_index&#x27;]   # Manually found the index value 10
row_info = tracer.get_row_info(row_loc)
var = row_info[&#x27;variable&#x27;]
var_desc = row_info[&#x27;variable_desc&#x27;]
target_geo_id = int(row_info[&#x27;geographic_id&#x27;])

print(&quot;Row info for Alaska&#x27;s SNAP benefit amount:&quot;)
print(row_info)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="_luHufmnNw1nQwupLmzu-" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>Row info for Alaska&#x27;s SNAP benefit amount:
{&#x27;row_index&#x27;: 80, &#x27;variable&#x27;: &#x27;snap&#x27;, &#x27;variable_desc&#x27;: &#x27;SNAP allotment&#x27;, &#x27;geographic_id&#x27;: &#x27;37&#x27;, &#x27;target_value&#x27;: 4041086120.0, &#x27;stratum_id&#x27;: 9799, &#x27;stratum_group_id&#x27;: 4}
</span></code></pre></div></div></div></div><div id="h4uEPadIf7" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">print(&quot;\nHousehold donated to AK&#x27;s 1st district, 2023 SNAP dollars:&quot;)
print(X_sparse[new_row_loc, positions[&#x27;201&#x27;]])  # Household donated to AK&#x27;s at Large District</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="0gqBQz6O_RhJgV_c9cdZA" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>
Household donated to AK&#x27;s 1st district, 2023 SNAP dollars:
342.48004
</span></code></pre></div></div></div></div><div id="fewLcDe9YK" class="myst-jp-nb-block relative group/block"><h2 id="section-6-simulating-state-swapped-calculations" class="relative group"><span class="heading-text">Section 6: Simulating State-Swapped Calculations</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#section-6-simulating-state-swapped-calculations" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>When a household is “transplanted” to a different state, state-dependent benefits like SNAP are recalculated under the destination state’s rules.</p></div><div id="q2XzJp05u8" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">def create_state_simulation(state_fips):
    &quot;&quot;&quot;Create a simulation with all households assigned to a specific state.&quot;&quot;&quot;
    s = Microsimulation(dataset=dataset_path)
    s.set_input(
        &quot;state_fips&quot;, 2023, np.full(hh_snap_df.shape[0], state_fips, dtype=np.int32)
    )
    for var in get_calculated_variables(s):
        s.delete_arrays(var)
    return s

# Compare SNAP for first 5 households under NC vs AK rules
nc_sim = create_state_simulation(37)  # NC
ak_sim = create_state_simulation(2)   # AK

nc_snap = nc_sim.calculate(&quot;snap&quot;, map_to=&quot;household&quot;).values[:5]
ak_snap = ak_sim.calculate(&quot;snap&quot;, map_to=&quot;household&quot;).values[:5]

print(&quot;SNAP values for first 5 households under different state rules:&quot;)
print(f&quot;  NC rules: {nc_snap}&quot;)
print(f&quot;  AK rules: {ak_snap}&quot;)
print(f&quot;  Difference: {ak_snap - nc_snap}&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="oGxOEL88EM_dGIlHhRNFo" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>SNAP values for first 5 households under different state rules:
  NC rules: [789.19995117   0.           0.           0.           0.        ]
  AK rules: [342.4800415   0.          0.          0.          0.       ]
  Difference: [-446.71990967    0.            0.            0.            0.        ]
</span></code></pre></div></div></div></div><div id="MnH7CdiQdn" class="myst-jp-nb-block relative group/block"><h2 id="section-7-creating-the-h5-files" class="relative group"><span class="heading-text">Section 7: Creating the h5 files</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#section-7-creating-the-h5-files" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p><code>w</code> (required)</p><ul><li><p>The calibrated weight vector from L0 calibration</p></li><li><p>Shape: (n_cds * n_households,) — a flattened matrix where each CD has weights for all households</p></li><li><p>Gets reshaped to (n_cds, n_households) internally</p></li></ul><p><code>cds_to_calibrate</code> (required)</p><ul><li><p>The ordered list of CD GEOIDs used when building w</p></li><li><p>Serves two purposes:
a. Tells us how to reshape w (via its length)
b. Provides the index mapping so we can extract the right rows for any cd_subset</p></li></ul><p><code>cd_subset</code> (optional, default None)</p><ul><li><p>Which CDs to actually include in the output dataset</p></li><li><p>Must be a subset of cds_to_calibrate</p></li><li><p>If None, all CDs are included</p></li><li><p>Use cases: build a single-state file, a single-CD file for testing, etc.</p></li></ul><p><code>output_path</code> (optional but effectively required — raises if None)</p><ul><li><p>Where to save the resulting .h5 file</p></li><li><p>Creates parent directories if needed</p></li></ul><p><code>dataset_path</code> (optional, default None)</p><ul><li><p>Path to the base .h5 dataset that was used during calibration</p></li><li><p>This is the “template” — household structure, demographics, etc.</p></li><li><p>The function loads this, reweights households per CD, updates geography, and stacks</p></li></ul></div><div id="gevt6p8fzL" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">import os

from policyengine_us_data.datasets.cps.local_area_calibration.stacked_dataset_builder import create_sparse_cd_stacked_dataset

# Initialize the weights w for demonstration
# We can&#x27;t allow too many w cells to be positive for a given state, or the reindexing will fail
w = np.random.binomial(n=1, p=0.01, size=X_sparse.shape[1]).astype(float)

# We&#x27;ll make sure our earlier household is included:
household_ids = sim.calculate(&quot;household_id&quot;, map_to=&quot;household&quot;).values
hh_idx = np.where(household_ids == hh_id)[0][0]

cd_idx = test_cds.index(&#x27;3701&#x27;)
flat_idx = cd_idx * len(household_ids) + hh_idx
w[flat_idx] = 2.5

cd_idx = test_cds.index(&#x27;201&#x27;)
flat_idx = cd_idx * len(household_ids) + hh_idx
w[flat_idx] = 3.5

# Create a folder for the outputs of the function that is to come.
new_folder_name = &quot;calibration_output&quot;
os.makedirs(new_folder_name, exist_ok=True)
output_path = os.path.join(new_folder_name, &quot;results.h5&quot;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="kyAYvqMYhfD4b0fIZdCd1" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="ihj94aY4YV" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">cd_subset = [&#x27;3701&#x27;, &#x27;201&#x27;]
create_sparse_cd_stacked_dataset(
    w,
    test_cds, # cds_to_calibrate - Defines the structure of the weight vector w
    cd_subset=cd_subset, #  cd_subset - Specifies which CDs to actually include in the output dataset (optional, defaults to all).
    dataset_path=dataset_path,
    output_path=output_path,
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="TuK3kLkyPe8er36gQ-GAe" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>Processing subset of 2 CDs: 3701, 201...
Output path: calibration_output/results.h5

Original dataset has 13,507 households
Extracted weights for 2 CDs from full weight matrix
Total active household-CD pairs: 284
Total weight in W matrix: 288
Processing CD 201 (2/2)...

Combining 2 CD DataFrames...
Total households across all CDs: 284
Combined DataFrame shape: (898, 167)

Reindexing all entity IDs using 25k ranges per CD...
  Created 284 unique households across 2 CDs
  Reindexing persons using 25k ranges...
  Reindexing tax units...
  Reindexing SPM units...
  Reindexing marital units...
  Final persons: 898
  Final households: 284
  Final tax units: 438
  Final SPM units: 298
  Final marital units: 693

Weights in combined_df AFTER reindexing:
  HH weight sum: 0.00M
  Person weight sum: 0.00M
  Ratio: 1.00

Overflow check:
  Max person ID after reindexing: 5,125,419
  Max person ID × 100: 512,541,900
  int32 max: 2,147,483,647
  ✓ No overflow risk!

Creating Dataset from combined DataFrame...
Building simulation from Dataset...

Saving to calibration_output/results.h5...
Found 165 input variables to save
Variables saved: 163
Variables skipped: 3491
Sparse CD-stacked dataset saved successfully!
Household mapping saved to calibration_output/mappings/results_household_mapping.csv

Verifying saved file...
  Final households: 284
  Final persons: 898
  Total population (from household weights): 288
</span></code></pre></div></div><div data-name="safe-output-text" class="font-mono text-sm whitespace-pre-wrap myst-jp-safe-output-text"><code><span>&#x27;calibration_output/results.h5&#x27;</span></code></div></div></div><div id="g2kBwdjQPl" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%ls calibration_output</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="vUaRPiCjhAk_vTYXoi0qC" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span style="color:rgb(0, 0, 187);font-weight:bold">mappings</span><span>/  results.h5
</span></code></pre></div></div></div></div><div id="SvjzC39xkk" class="myst-jp-nb-block relative group/block"><p>Note that there is a <em>mappings</em> directory that has also been created by create_sparse_cd_stacked_dataset. This contains the CSV file that links the original households to the donor households. The reason it’s a seperate folder is to keep the h5 files and the mapping CSVs organized when this function is run for all districts or states.</p></div><div id="QJv2LsYYRz" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%ls calibration_output/mappings</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="buWtCchXHNBYSBsbPWFYH" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>results_household_mapping.csv
</span></code></pre></div></div></div></div><div id="AiHuTPkBhh" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">sim_after = Microsimulation(dataset=&quot;./calibration_output/results.h5&quot;)

hh_after_df =  pd.DataFrame(sim_after.calculate_dataframe([
    &quot;household_id&quot;, &quot;congressional_district_geoid&quot;, &quot;county&quot;, &quot;household_weight&quot;, &quot;state_fips&quot;, &quot;snap&quot;])                                        
)
print(hh_after_df)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="eJhKcCqG7wC_UzuoTXWeo" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>     household_id  congressional_district_geoid  \
0           50000                           201   
1           50001                           201   
2           50002                           201   
3           50003                           201   
4           50004                           201   
..            ...                           ...   
279        125125                          3701   
280        125126                          3701   
281        125127                          3701   
282        125128                          3701   
283        125129                          3701   

                            county  household_weight  state_fips         snap  
0    ALEUTIANS_WEST_CENSUS_AREA_AK               3.5           2   342.480042  
1     YUKON_KOYUKUK_CENSUS_AREA_AK               1.0           2  3433.199707  
2        ALEUTIANS_EAST_BOROUGH_AK               1.0           2     0.000000  
3        SITKA_CITY_AND_BOROUGH_AK               1.0           2     0.000000  
4        ANCHORAGE_MUNICIPALITY_AK               1.0           2     0.000000  
..                             ...               ...         ...          ...  
279               LENOIR_COUNTY_NC               1.0          37     0.000000  
280               CHOWAN_COUNTY_NC               1.0          37     0.000000  
281               LENOIR_COUNTY_NC               1.0          37     0.000000  
282                WAYNE_COUNTY_NC               1.0          37     0.000000  
283            EDGECOMBE_COUNTY_NC               1.0          37     0.000000  

[284 rows x 6 columns]
</span></code></pre></div></div></div></div><div id="TLhZJf0IC5" class="myst-jp-nb-block relative group/block"><p>We can see one of the correct instances above but let’s confirm that this new household id does in fact link back to the original in both cases.</p></div><div id="Yy720yKAFG" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">mapping_df = pd.read_csv(&quot;calibration_output/mappings/results_household_mapping.csv&quot;)
mapping_df.loc[mapping_df.original_household_id == hh_id]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="oz_zrdPHnW5n71B70h0m1" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="gI8naxUOf2" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">new_hh_ids = mapping_df.loc[mapping_df.original_household_id == hh_id].new_household_id
hh_after_df.loc[hh_after_df.household_id.isin(new_hh_ids)]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="ud9WloFM8KP-Z6bgfLBvd" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="gH2LCo9W1y" class="myst-jp-nb-block relative group/block"><p>And we can see that the snap numbers still match their values from the different US state systems. However note that due to the use of policyengine-core’s random function in a component of snap_gross_income, for some households, the value in the final simulation will not match the one used in creating the X matrix (<code>X_sparse</code> here). This is outlined in <a href="https://github.com/PolicyEngine/policyengine-core/issues/412" class="hover-link" target="_blank" rel="noreferrer" data-state="closed">Issue 412</a>.</p></div><div id="eVV60twrQd" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%rm -r calibration_output</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="cD8YySe8v1Yj7yZkFHsKD" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div class="myst-backmatter-parts"></div><div class="myst-footer-links flex pt-10 mb-10 space-x-4"><a class="myst-footer-link flex-1 block p-4 font-normal text-gray-600 no-underline border border-gray-200 rounded shadow-sm group hover:border-blue-600 dark:hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400 dark:text-gray-100 dark:border-gray-500 hover:shadow-lg dark:shadow-neutral-700 myst-footer-link-prev" href="/policyengine-us-data/long-term-projections"><div class="flex h-full align-middle"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.5rem" height="1.5rem" class="myst-footer-link-icon self-center transition-transform group-hover:-translate-x-1 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path></svg><div class="flex-grow text-right"><div class="myst-footer-link-group text-xs text-gray-500 dark:text-gray-400">PolicyEngine US Data</div>Long Term Projections</div></div></a><a class="myst-footer-link flex-1 block p-4 font-normal text-gray-600 no-underline border border-gray-200 rounded shadow-sm group hover:border-blue-600 dark:hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400 dark:text-gray-100 dark:border-gray-500 hover:shadow-lg dark:shadow-neutral-700 myst-footer-link-next" href="/policyengine-us-data/discussion"><div class="flex h-full align-middle"><div class="flex-grow"><div class="myst-footer-link-group text-xs text-gray-500 dark:text-gray-400">PolicyEngine US Data</div>Discussion</div><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.5rem" height="1.5rem" class="myst-footer-link-icon self-center transition-transform group-hover:translate-x-1 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3"></path></svg></div></a></div></article></main><script>((a,l)=>{if(!window.history.state||!window.history.state.key){let u=Math.random().toString(32).slice(2);window.history.replaceState({key:u},"")}try{let d=JSON.parse(sessionStorage.getItem(a)||"{}")[l||window.history.state.key];typeof d=="number"&&window.scrollTo(0,d)}catch(u){console.error(u),sessionStorage.removeItem(a)}})("positions", null)</script><link rel="modulepreload" href="/policyengine-us-data/build/entry.client-PCJPW7TK.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-AQ2CODAG.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-JJXTQVMA.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-OZE3FFNP.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-7UUHRSK3.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-C4DFGG5C.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-J7TUH54J.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-FZ2S7OYD.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-JEM6JXYA.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-34XIY2DH.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-KQM5FBHR.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-OCWQY3HK.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-7HNKBP4B.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-CUKUDK3R.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-3EBOCCHJ.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-O4VQNZ62.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-4OEDG4JQ.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-GUCIBHGO.js"/><link rel="modulepreload" href="/policyengine-us-data/build/root-EDJFWIEV.js"/><link rel="modulepreload" href="/policyengine-us-data/build/_shared/chunk-ECLX7DIY.js"/><link rel="modulepreload" href="/policyengine-us-data/build/routes/$-AD65NCUT.js"/><script>window.__remixContext = {"url":"/local-area-calibration-setup","state":{"loaderData":{"root":{"config":{"version":3,"myst":"1.7.1","options":{"logo":"/policyengine-us-data/build/logo-3819769fbc672330a888a5cbb49b5159.png","analytics_google":"","folders":true},"nav":[],"actions":[],"projects":[{"bibliography":["/home/runner/work/policyengine-us-data/policyengine-us-data/docs/references.bib"],"title":"PolicyEngine US Data","authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","toc":[{"file":"abstract.md"},{"file":"introduction.md"},{"file":"background.md"},{"file":"data.md"},{"file":"methodology.md"},{"file":"long_term_projections.md"},{"file":"local_area_calibration_setup.ipynb"},{"file":"discussion.md"},{"file":"conclusion.md"},{"file":"appendix.md"}],"exports":[],"index":"index","pages":[{"slug":"introduction","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"background","title":"Background","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"data","title":"Data Sources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"methodology","title":"Methodology","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"long-term-projections","title":"Long Term Projections","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"local-area-calibration-setup","title":"Local Area Calibration Setup","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"discussion","title":"Discussion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"conclusion","title":"Conclusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"appendix","title":"Appendix","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1}]}]},"CONTENT_CDN_PORT":"3100","MODE":"static","BASE_URL":"/policyengine-us-data"},"routes/$":{"config":{"version":3,"myst":"1.7.1","options":{"logo":"/policyengine-us-data/build/logo-3819769fbc672330a888a5cbb49b5159.png","analytics_google":"","folders":true},"nav":[],"actions":[],"projects":[{"bibliography":["/home/runner/work/policyengine-us-data/policyengine-us-data/docs/references.bib"],"title":"PolicyEngine US Data","authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","toc":[{"file":"abstract.md"},{"file":"introduction.md"},{"file":"background.md"},{"file":"data.md"},{"file":"methodology.md"},{"file":"long_term_projections.md"},{"file":"local_area_calibration_setup.ipynb"},{"file":"discussion.md"},{"file":"conclusion.md"},{"file":"appendix.md"}],"exports":[],"index":"index","pages":[{"slug":"introduction","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"background","title":"Background","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"data","title":"Data Sources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"methodology","title":"Methodology","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"long-term-projections","title":"Long Term Projections","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"local-area-calibration-setup","title":"Local Area Calibration Setup","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"discussion","title":"Discussion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"conclusion","title":"Conclusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"appendix","title":"Appendix","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1}]}]},"page":{"version":3,"kind":"Notebook","sha256":"dd7bf5a986896f96b0e1d62008150c26e481e58b27b29043d62c889b9bfadc7e","slug":"local-area-calibration-setup","location":"/local_area_calibration_setup.ipynb","dependencies":[],"frontmatter":{"title":"Local Area Calibration Setup","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","source_url":"https://github.com/policyengine/policyengine-us-data/blob/main/docs/local_area_calibration_setup.ipynb","edit_url":"https://github.com/policyengine/policyengine-us-data/edit/main/docs/local_area_calibration_setup.ipynb","exports":[{"format":"ipynb","filename":"local_area_calibration_setup.ipynb","url":"/policyengine-us-data/build/local_area_calibrati-a346bda7ffecd45b45e1becefacd9bf3.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates the sparse matrix construction for local area (congressional district) calibration. It uses a subset of CDs from NC, HI, MT, and AK for manageable runtime.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FkKbMc68HA"}],"key":"sZQgFwbHH8"}],"key":"SWflHsDo1S"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 1: Setup \u0026 Configuration","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OGuM3IcRb3"}],"identifier":"section-1-setup-configuration","label":"Section 1: Setup \u0026 Configuration","html_id":"section-1-setup-configuration","implicit":true,"key":"oW5OfHOcU4"}],"key":"yTrQIeddwl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from sqlalchemy import create_engine, text\nimport pandas as pd\nimport numpy as np\n\nfrom policyengine_us import Microsimulation\nfrom policyengine_us_data.storage import STORAGE_FOLDER\nfrom policyengine_us_data.datasets.cps.local_area_calibration.sparse_matrix_builder import (\n    SparseMatrixBuilder,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.matrix_tracer import (\n    MatrixTracer,\n)\nfrom policyengine_us_data.datasets.cps.local_area_calibration.calibration_utils import (\n    get_calculated_variables,\n    create_target_groups,\n)","key":"UbSpHurwPr"},{"type":"outputs","id":"XopmPZLCDuk_TdsTwtknI","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/home/baogorek/envs/pe/lib/python3.13/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html\n  from .autonotebook import tqdm as notebook_tqdm\n"},"children":[],"key":"HbTMF7BNp9"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"TEST_LITE == False\n"},"children":[],"key":"zAQb8TccPp"}],"key":"YnQdiVNUVm"}],"key":"WK6DT4fyac"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"db_path = STORAGE_FOLDER / \"calibration\" / \"policy_data.db\"\ndb_uri = f\"sqlite:///{db_path}\"\ndataset_path = str(STORAGE_FOLDER / \"stratified_extended_cps_2023.h5\")\n\nengine = create_engine(db_uri)","key":"TrE6FXwBPh"},{"type":"outputs","id":"ZCMYXBQEkCZMkVHTIhWCs","children":[],"key":"E8u7QxOyL2"}],"key":"VHEuYvpwCi"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 2: Select Test Congressional Districts","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GizYFIrdYv"}],"identifier":"section-2-select-test-congressional-districts","label":"Section 2: Select Test Congressional Districts","html_id":"section-2-select-test-congressional-districts","implicit":true,"key":"N12Xs8Gpd7"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We use CDs from 4 states for testing:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"H3K8vxJhYv"}],"key":"Fg5PQTk9BA"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"NC (37)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"pTo4Glo5BH"}],"key":"uDt8slDssr"},{"type":"text","value":": 14 CDs (3701-3714) - provides same-state different-CD test cases","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"vr8zk9uaqV"}],"key":"BTRAFb3mgo"}],"key":"Yo7ExMVZgx"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"HI (15)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"koYxpiHbTL"}],"key":"ICK0SH9cg5"},{"type":"text","value":": 2 CDs (1501-1502)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"L9tyjipffO"}],"key":"naCyeWDczO"}],"key":"IMwtkbGuj7"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"MT (30)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"NrHtpSGiqf"}],"key":"A6bE8xPYXX"},{"type":"text","value":": 2 CDs (3001-3002)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"JBfeVPkoJR"}],"key":"gvAl8X6QNV"}],"key":"Jfs45G9Xqy"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"AK (2)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"otn4VLOeUO"}],"key":"qytNhMpaRC"},{"type":"text","value":": 1 CD (200)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"dJIuChAmOv"}],"key":"HLWV6RghIh"}],"key":"hqJWSaZFht"}],"key":"GmdmtU57FP"}],"key":"KumCWbfNy9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"query = \"\"\"\nSELECT DISTINCT sc.value as cd_geoid\nFROM strata s\nJOIN stratum_constraints sc ON s.stratum_id = sc.stratum_id\nWHERE s.stratum_group_id = 1\n  AND sc.constraint_variable = 'congressional_district_geoid'\n  AND (\n    sc.value LIKE '37__'\n    OR sc.value LIKE '150_'\n    OR sc.value LIKE '300_'\n    OR sc.value = '200' OR sc.value = '201'\n  )\nORDER BY sc.value\n\"\"\"\n\nwith engine.connect() as conn:\n    result = conn.execute(text(query)).fetchall()\n    test_cds = [row[0] for row in result]\n\nprint(f\"Testing with {len(test_cds)} congressional districts:\")\nprint(f\"  NC (37): {[cd for cd in test_cds if cd.startswith('37')]}\")\nprint(f\"  HI (15): {[cd for cd in test_cds if cd.startswith('15')]}\")\nprint(f\"  MT (30): {[cd for cd in test_cds if cd.startswith('30')]}\")\nprint(f\"  AK (2):  {[cd for cd in test_cds if cd.startswith('20')]}\")","key":"EHpvhTTaVj"},{"type":"outputs","id":"JcqfrzonScqUA0f2SiLKy","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Testing with 19 congressional districts:\n  NC (37): ['3701', '3702', '3703', '3704', '3705', '3706', '3707', '3708', '3709', '3710', '3711', '3712', '3713', '3714']\n  HI (15): ['1501', '1502']\n  MT (30): ['3001', '3002']\n  AK (2):  ['201']\n"},"children":[],"key":"scPskbJ62I"}],"key":"M9os0hpqty"}],"key":"X7g0xGeosD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 3: Build the Sparse Matrix","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nr9RMAZ0uQ"}],"identifier":"section-3-build-the-sparse-matrix","label":"Section 3: Build the Sparse Matrix","html_id":"section-3-build-the-sparse-matrix","implicit":true,"key":"Q399jydNgd"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The sparse matrix ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yBGRuEWE1F"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DUUXZ2mwyD"},{"type":"text","value":" has:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mXi1R47Nnw"}],"key":"q0TaYsMnal"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Rows","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"YpqHRNQYBO"}],"key":"o4WexVTG78"},{"type":"text","value":": Calibration targets (e.g., SNAP totals by geography)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"K4tEJXmE3T"}],"key":"ctjd0XEELv"}],"key":"ktd36HxYMg"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Columns","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Lhf1MmcGTs"}],"key":"YN8Y1YbOxM"},{"type":"text","value":": (household × CD) pairs - each household appears once per CD","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"cwdqt95nTY"}],"key":"iq0sc6cryX"}],"key":"H6cbh1R6WG"}],"key":"Ud9FFYrrm6"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We filter to SNAP targets only (stratum_group_id=4) for this demonstration.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"w8XQDmoiAX"}],"key":"zfOWPiyQx5"}],"key":"Hq2WmHJoCT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim = Microsimulation(dataset=dataset_path)\n\nbuilder = SparseMatrixBuilder(\n    db_uri,\n    time_period=2023,\n    cds_to_calibrate=test_cds,\n    dataset_path=dataset_path,\n)\n\ntargets_df, X_sparse, household_id_mapping = builder.build_matrix(\n    sim, target_filter={\"stratum_group_ids\": [4], \"variables\": [\"snap\"]}\n)\n\nprint(f\"X_sparse shape: {X_sparse.shape}\")\nprint(f\"  Rows (targets): {X_sparse.shape[0]}\")\nprint(f\"  Columns (household × CD pairs): {X_sparse.shape[1]}\")\nprint(f\"  Non-zero entries: {X_sparse.nnz:,}\")\nprint(f\"  Sparsity: {1 - X_sparse.nnz / (X_sparse.shape[0] * X_sparse.shape[1]):.2%}\")","key":"nTxv2iSLd6"},{"type":"outputs","id":"27Cgz_D0yXwaXbFcikTj0","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"X_sparse shape: (539, 256633)\n  Rows (targets): 539\n  Columns (household × CD pairs): 256633\n  Non-zero entries: 67,756\n  Sparsity: 99.95%\n"},"children":[],"key":"ApR9Q3bLBi"}],"key":"aM7ZoYXUHf"}],"key":"rfJ7tX4INg"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 4: Understanding the Matrix Structure with MatrixTracer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FYZlWGigQG"}],"identifier":"section-4-understanding-the-matrix-structure-with-matrixtracer","label":"Section 4: Understanding the Matrix Structure with MatrixTracer","html_id":"section-4-understanding-the-matrix-structure-with-matrixtracer","implicit":true,"key":"IfWkjoEKMY"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dygFOZt8Zu"},{"type":"inlineCode","value":"MatrixTracer","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fxBKlYR2BG"},{"type":"text","value":" helps navigate the sparse matrix by providing lookups between:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sNTomNu1A6"}],"key":"HUIkWnJ1uL"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Column indices ↔ (household_id, CD) pairs","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"YnM4VmY9R0"}],"key":"vCgtTO7gTW"}],"key":"nm9NR3ZMeh"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Row indices ↔ target definitions","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"HerN75cILb"}],"key":"wuqxcd6Uuw"}],"key":"fExZKFozgW"}],"key":"cqbbCB3g9d"}],"key":"UhADLNYSgo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tracer = MatrixTracer(\n    targets_df, X_sparse, household_id_mapping, test_cds, sim\n)\n\ntracer.print_matrix_structure()","key":"Iu2sUPZHwG"},{"type":"outputs","id":"-_WBgv3h-7okZGtVA6dA3","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\n================================================================================\nMATRIX STRUCTURE BREAKDOWN\n================================================================================\n\nMatrix dimensions: 539 rows x 256633 columns\n  Rows = 539 targets\n  Columns = 13507 households x 19 CDs\n           = 13,507 x 19 = 256,633\n\n--------------------------------------------------------------------------------\nCOLUMN STRUCTURE (Households stacked by CD)\n--------------------------------------------------------------------------------\n\nShowing first and last 5 CDs of 19 total:\n\nFirst 5 CDs:\ncd_geoid  start_col  end_col  n_households\n    1501          0    13506         13507\n    1502      13507    27013         13507\n     201      27014    40520         13507\n    3001      40521    54027         13507\n    3002      54028    67534         13507\n\nLast 5 CDs:\ncd_geoid  start_col  end_col  n_households\n    3710     189098   202604         13507\n    3711     202605   216111         13507\n    3712     216112   229618         13507\n    3713     229619   243125         13507\n    3714     243126   256632         13507\n\n--------------------------------------------------------------------------------\nROW STRUCTURE (Targets)\n--------------------------------------------------------------------------------\n\nTotal targets: 539\n\nTargets by stratum group:\n                  n_targets  n_unique_vars\nstratum_group_id                          \n1                         1              1\n4                       538              2\n\n--------------------------------------------------------------------------------\nTARGET GROUPS (for loss calculation)\n--------------------------------------------------------------------------------\n\n=== Creating Target Groups ===\n\nNational targets:\n  Group 0: Snap = 107,062,860,000\n\nState targets:\n  Group 1: SNAP Household Count (51 targets)\n  Group 2: Snap (51 targets)\n\nDistrict targets:\n  Group 3: SNAP Household Count (436 targets)\n\nTotal groups created: 4\n========================================\n  Group 0: National Snap (1 target, value=107,062,860,000) - rows [0]\n  Group 1: State SNAP Household Count (51 targets) - rows [1, 2, 3, ..., 50, 51]\n  Group 2: State Snap (51 targets) - rows [52, 53, 54, ..., 101, 102]\n  Group 3: District SNAP Household Count (436 targets) - rows [103, 104, 105, ..., 537, 538]\n\n================================================================================\n"},"children":[],"key":"JJUu4LrkWR"}],"key":"PD2qqKrLpV"}],"key":"zabZvB3XKx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_groups, group_info = create_target_groups(targets_df)","key":"AXutpIbuOb"},{"type":"outputs","id":"FrQfpSVE0oRMFqXGQJE0s","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\n=== Creating Target Groups ===\n\nNational targets:\n  Group 0: Snap = 107,062,860,000\n\nState targets:\n  Group 1: SNAP Household Count (51 targets)\n  Group 2: Snap (51 targets)\n\nDistrict targets:\n  Group 3: SNAP Household Count (436 targets)\n\nTotal groups created: 4\n========================================\n"},"children":[],"key":"aYi6TTpDL9"}],"key":"KYbV5IOLmG"}],"key":"lui3K8kkMI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nrow_loc = target_group.iloc[28]['row_index']  # Manually found the index value 28\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for North Carolina's SNAP benefit amount:\")\nprint(row_info)","key":"EEpxiEuU0q"},{"type":"outputs","id":"nbRRgHNAp9fgW-a8JHpOR","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Row info for North Carolina's SNAP benefit amount:\n{'row_index': 80, 'variable': 'snap', 'variable_desc': 'SNAP allotment', 'geographic_id': '37', 'target_value': 4041086120.0, 'stratum_id': 9799, 'stratum_group_id': 4}\n"},"children":[],"key":"dl49hX8s4e"}],"key":"cTdteZVabz"}],"key":"DSpe1zdIOk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hh_snap_df = pd.DataFrame(sim.calculate_dataframe([\n    \"household_id\", \"household_weight\", \"state_fips\", \"snap\"])                                        \n)\nprint(hh_snap_df)","key":"IJ41BhOCme"},{"type":"outputs","id":"1jeN27Hkflt9fWBbNsA63","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"       household_id  household_weight  state_fips        snap\n0                25       1229.699951          23  789.199951\n1                76       3119.330078          23    0.000000\n2                92       1368.089966          23    0.000000\n3               110       1457.579956          23    0.000000\n4               140       1445.209961          23    0.000000\n...             ...               ...         ...         ...\n13502        178916          0.000000          15    0.000000\n13503        178918          0.000000          15    0.000000\n13504        178926          0.000000          15    0.000000\n13505        178935          0.000000          15    0.000000\n13506        178945          0.000000          15    0.000000\n\n[13507 rows x 4 columns]\n"},"children":[],"key":"InFEeYyJ6i"}],"key":"C7EkQhqRVa"}],"key":"Xdq1yvRCRE"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If we were to include ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"V8nfU3POwO"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JsBhxzHDh3"},{"type":"text","value":" above, they would all be zeros. It’s not until we do the calibration, i.e., come back with a vector of weights ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"M1SSEkKPar"},{"type":"inlineCode","value":"w","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"or3aT2Xahk"},{"type":"text","value":" to multiply ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fEdIlVA6VU"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"v9vJvH3yYe"},{"type":"text","value":" with, that we will set ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tz8Z7T00hv"},{"type":"inlineCode","value":"congressional_district_geoid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HZlSL7geYb"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LjXN608FyA"}],"key":"jP41BlruJP"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"However, every household is already a donor to every contressional district. You can get the column positions for every household (remember targets are on the rows, donor households on the columns) by running tracer’s get_household_column_positions with the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GGqEVfovsn"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"original","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MsNnCUOmFc"}],"key":"BNrEZamtOZ"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"z5387gEcoY"},{"type":"inlineCode","value":"household_id","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"opWuYHAiy1"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QirqmC2dm7"}],"key":"jPRGB5Ysw3"}],"key":"rMudk0lpiF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Reverse lookup: get all column positions for a specific household\nhh_id = hh_snap_df.loc[hh_snap_df.snap \u003e 0].household_id.values[0]\nprint(hh_snap_df.loc[hh_snap_df.household_id == hh_id])\n\nprint(\"\\nEvaluating the tracer.get_household_column_positions dictionary:\\n\")\npositions = tracer.get_household_column_positions(hh_id)\nprint(positions)","key":"pNX93ruKAe"},{"type":"outputs","id":"-ufcjOKkt27UOk3pS8N5w","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"   household_id  household_weight  state_fips        snap\n0            25       1229.699951          23  789.199951\n\nEvaluating the tracer.get_household_column_positions dictionary:\n\n{'1501': 0, '1502': 13507, '201': 27014, '3001': 40521, '3002': 54028, '3701': 67535, '3702': 81042, '3703': 94549, '3704': 108056, '3705': 121563, '3706': 135070, '3707': 148577, '3708': 162084, '3709': 175591, '3710': 189098, '3711': 202605, '3712': 216112, '3713': 229619, '3714': 243126}\n"},"children":[],"key":"fY80IjnGUP"}],"key":"TTnoO5vJuq"}],"key":"iIkn5nELsg"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lyo5VpLjOs"}],"identifier":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","label":"Section 5: Understanding the cells of the X_Sparse matrix and Target vector","html_id":"section-5-understanding-the-cells-of-the-x-sparse-matrix-and-target-vector","implicit":true,"key":"cD2OR4MKS1"}],"key":"TU9mVj15NP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"Remember, this is a North Carolina target:\\n\")\nprint(targets_df.iloc[row_loc])\n\nprint(\"\\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['3702']])  # Household donated to NC's 2nd district\n\nprint(\"\\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\")\nprint(X_sparse[row_loc, positions['201']])  # Household donated to AK's at Large District","key":"zxenM8X3fb"},{"type":"outputs","id":"QgsXhWKdd6EwjvFBweirV","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Remember, this is a North Carolina target:\n\ntarget_id                   9372\nstratum_id                  9799\nvariable                    snap\nvalue               4041086120.0\nperiod                      2023\nstratum_group_id               4\ngeographic_id                 37\nName: 80, dtype: object\n\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\n789.19995\n\nHousehold donated to NC's 2nd district, 2023 SNAP dollars:\n0.0\n"},"children":[],"key":"mYWZW8ZH5G"}],"key":"jpLKUFu3nS"}],"key":"Mwpkth2LAl"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Key property: For state-level targets, only CDs in that state should have non-zero values.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XBELP1OYS2"}],"key":"tnnfgSnFn4"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Example: A NC state SNAP target should have zeros for HI, MT, and AK CD columns.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XLPcHPUA74"}],"key":"elXCNRX2XD"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"So let’s see that same household’s value for the Alaska state target:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"lbRfdq1GYT"}],"key":"q7WgQ2gbes"}],"key":"LN5y1nxPT2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"target_group = tracer.get_group_rows(2)\nnew_row_loc = target_group.iloc[10]['row_index']   # Manually found the index value 10\nrow_info = tracer.get_row_info(row_loc)\nvar = row_info['variable']\nvar_desc = row_info['variable_desc']\ntarget_geo_id = int(row_info['geographic_id'])\n\nprint(\"Row info for Alaska's SNAP benefit amount:\")\nprint(row_info)","key":"doOLbAQNHr"},{"type":"outputs","id":"_luHufmnNw1nQwupLmzu-","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Row info for Alaska's SNAP benefit amount:\n{'row_index': 80, 'variable': 'snap', 'variable_desc': 'SNAP allotment', 'geographic_id': '37', 'target_value': 4041086120.0, 'stratum_id': 9799, 'stratum_group_id': 4}\n"},"children":[],"key":"qgqMudxn5f"}],"key":"SqhZZxbyFZ"}],"key":"GhqGdl7QnV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(\"\\nHousehold donated to AK's 1st district, 2023 SNAP dollars:\")\nprint(X_sparse[new_row_loc, positions['201']])  # Household donated to AK's at Large District","key":"oK2YYA6P51"},{"type":"outputs","id":"0gqBQz6O_RhJgV_c9cdZA","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\nHousehold donated to AK's 1st district, 2023 SNAP dollars:\n342.48004\n"},"children":[],"key":"n840AWo38y"}],"key":"HOy7k0tYnm"}],"key":"h4uEPadIf7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 6: Simulating State-Swapped Calculations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kZYEIbKGAZ"}],"identifier":"section-6-simulating-state-swapped-calculations","label":"Section 6: Simulating State-Swapped Calculations","html_id":"section-6-simulating-state-swapped-calculations","implicit":true,"key":"I09zdpjpK8"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When a household is “transplanted” to a different state, state-dependent benefits like SNAP are recalculated under the destination state’s rules.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YNl6orOHf8"}],"key":"NGtLTqiaOH"}],"key":"fewLcDe9YK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def create_state_simulation(state_fips):\n    \"\"\"Create a simulation with all households assigned to a specific state.\"\"\"\n    s = Microsimulation(dataset=dataset_path)\n    s.set_input(\n        \"state_fips\", 2023, np.full(hh_snap_df.shape[0], state_fips, dtype=np.int32)\n    )\n    for var in get_calculated_variables(s):\n        s.delete_arrays(var)\n    return s\n\n# Compare SNAP for first 5 households under NC vs AK rules\nnc_sim = create_state_simulation(37)  # NC\nak_sim = create_state_simulation(2)   # AK\n\nnc_snap = nc_sim.calculate(\"snap\", map_to=\"household\").values[:5]\nak_snap = ak_sim.calculate(\"snap\", map_to=\"household\").values[:5]\n\nprint(\"SNAP values for first 5 households under different state rules:\")\nprint(f\"  NC rules: {nc_snap}\")\nprint(f\"  AK rules: {ak_snap}\")\nprint(f\"  Difference: {ak_snap - nc_snap}\")","key":"CkAt4023kn"},{"type":"outputs","id":"oGxOEL88EM_dGIlHhRNFo","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"SNAP values for first 5 households under different state rules:\n  NC rules: [789.19995117   0.           0.           0.           0.        ]\n  AK rules: [342.4800415   0.          0.          0.          0.       ]\n  Difference: [-446.71990967    0.            0.            0.            0.        ]\n"},"children":[],"key":"GkP4nYiXEO"}],"key":"gPkuaUp6kq"}],"key":"q2XzJp05u8"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Section 7: Creating the h5 files","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iTRwVKO36f"}],"identifier":"section-7-creating-the-h5-files","label":"Section 7: Creating the h5 files","html_id":"section-7-creating-the-h5-files","implicit":true,"key":"ObwfNB7ZyY"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"w","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"rnemP7E3KG"},{"type":"text","value":" (required)","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NgS1TMs38a"}],"key":"KOewY5dwcE"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The calibrated weight vector from L0 calibration","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"n7TetabNJd"}],"key":"xh0WAZZRBl"}],"key":"wMOG8cAisN"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Shape: (n_cds * n_households,) — a flattened matrix where each CD has weights for all households","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"S9YLOhQ0N9"}],"key":"I8ikNtQyAZ"}],"key":"nxfQbzwVaY"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Gets reshaped to (n_cds, n_households) internally","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"j6ncKkpEfl"}],"key":"OxdwVuhVyg"}],"key":"fpBNTi7GIF"}],"key":"JJ11kvGeI2"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"inlineCode","value":"cds_to_calibrate","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"tPTetOQdk3"},{"type":"text","value":" (required)","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"d7XgOQjRdE"}],"key":"iQPT66L5dt"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The ordered list of CD GEOIDs used when building w","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"kYQF7dv9Cx"}],"key":"Wzq2UMWvSV"}],"key":"bAX3jyz0vp"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Serves two purposes:\na. Tells us how to reshape w (via its length)\nb. Provides the index mapping so we can extract the right rows for any cd_subset","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"m8oY1a2rpk"}],"key":"UatP1YWde1"}],"key":"og89hIGAAj"}],"key":"fIY8XgmnFf"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"inlineCode","value":"cd_subset","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"CR9Ol6ead2"},{"type":"text","value":" (optional, default None)","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"wrn0tQiuTa"}],"key":"IlVovPDM1l"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Which CDs to actually include in the output dataset","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"n1y4Krr9Dr"}],"key":"PwGmi760gZ"}],"key":"cCuGUKb9bn"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Must be a subset of cds_to_calibrate","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"nNNfohORQ6"}],"key":"avAZkFjEwE"}],"key":"ECBOZBZlya"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"If None, all CDs are included","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"aCfsXuOI5i"}],"key":"jHBTBqRjWY"}],"key":"dVeKX5G92r"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Use cases: build a single-state file, a single-CD file for testing, etc.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"kIGpU3kmYQ"}],"key":"HXCfw8pwIG"}],"key":"x6NoI2S5Yz"}],"key":"wDAcVm7wSP"},{"type":"paragraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"inlineCode","value":"output_path","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"AVBp7gP1rr"},{"type":"text","value":" (optional but effectively required — raises if None)","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"CfNQT9wTv6"}],"key":"OnOCEFRfZQ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":21,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Where to save the resulting .h5 file","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"sMqGKjoE4D"}],"key":"tsQWNbtyhw"}],"key":"ps3orRdmgC"},{"type":"listItem","spread":true,"position":{"start":{"line":22,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Creates parent directories if needed","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"hFM2sQ1HGd"}],"key":"bBoR6OILaG"}],"key":"VZspuMnh8R"}],"key":"sv8jTlYYDy"},{"type":"paragraph","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"inlineCode","value":"dataset_path","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"sbDsAmlqL5"},{"type":"text","value":" (optional, default None)","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"R70TAlrRz6"}],"key":"orWOkXXcz0"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":25,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Path to the base .h5 dataset that was used during calibration","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"xyQivbmadY"}],"key":"Ce1THdOd6U"}],"key":"fbftZ8PoP3"},{"type":"listItem","spread":true,"position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"This is the “template” — household structure, demographics, etc.","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"g2viiFJhdW"}],"key":"Ja6fdeyITB"}],"key":"Xq0AK9b3hL"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The function loads this, reweights households per CD, updates geography, and stacks","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"sVMhrXt98t"}],"key":"WJT5koJdwc"}],"key":"IUL86wE0mC"}],"key":"ELFNSEeRCR"}],"key":"MnH7CdiQdn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\n\nfrom policyengine_us_data.datasets.cps.local_area_calibration.stacked_dataset_builder import create_sparse_cd_stacked_dataset\n\n# Initialize the weights w for demonstration\n# We can't allow too many w cells to be positive for a given state, or the reindexing will fail\nw = np.random.binomial(n=1, p=0.01, size=X_sparse.shape[1]).astype(float)\n\n# We'll make sure our earlier household is included:\nhousehold_ids = sim.calculate(\"household_id\", map_to=\"household\").values\nhh_idx = np.where(household_ids == hh_id)[0][0]\n\ncd_idx = test_cds.index('3701')\nflat_idx = cd_idx * len(household_ids) + hh_idx\nw[flat_idx] = 2.5\n\ncd_idx = test_cds.index('201')\nflat_idx = cd_idx * len(household_ids) + hh_idx\nw[flat_idx] = 3.5\n\n# Create a folder for the outputs of the function that is to come.\nnew_folder_name = \"calibration_output\"\nos.makedirs(new_folder_name, exist_ok=True)\noutput_path = os.path.join(new_folder_name, \"results.h5\")","key":"g42hFkmgQv"},{"type":"outputs","id":"kyAYvqMYhfD4b0fIZdCd1","children":[],"key":"Aq8jayt4fC"}],"key":"gevt6p8fzL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cd_subset = ['3701', '201']\ncreate_sparse_cd_stacked_dataset(\n    w,\n    test_cds, # cds_to_calibrate - Defines the structure of the weight vector w\n    cd_subset=cd_subset, #  cd_subset - Specifies which CDs to actually include in the output dataset (optional, defaults to all).\n    dataset_path=dataset_path,\n    output_path=output_path,\n)","key":"lCVdpK9Ya1"},{"type":"outputs","id":"TuK3kLkyPe8er36gQ-GAe","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Processing subset of 2 CDs: 3701, 201...\nOutput path: calibration_output/results.h5\n\nOriginal dataset has 13,507 households\nExtracted weights for 2 CDs from full weight matrix\nTotal active household-CD pairs: 284\nTotal weight in W matrix: 288\nProcessing CD 201 (2/2)...\n\nCombining 2 CD DataFrames...\nTotal households across all CDs: 284\nCombined DataFrame shape: (898, 167)\n\nReindexing all entity IDs using 25k ranges per CD...\n  Created 284 unique households across 2 CDs\n  Reindexing persons using 25k ranges...\n  Reindexing tax units...\n  Reindexing SPM units...\n  Reindexing marital units...\n  Final persons: 898\n  Final households: 284\n  Final tax units: 438\n  Final SPM units: 298\n  Final marital units: 693\n\nWeights in combined_df AFTER reindexing:\n  HH weight sum: 0.00M\n  Person weight sum: 0.00M\n  Ratio: 1.00\n\nOverflow check:\n  Max person ID after reindexing: 5,125,419\n  Max person ID × 100: 512,541,900\n  int32 max: 2,147,483,647\n  ✓ No overflow risk!\n\nCreating Dataset from combined DataFrame...\nBuilding simulation from Dataset...\n\nSaving to calibration_output/results.h5...\nFound 165 input variables to save\nVariables saved: 163\nVariables skipped: 3491\nSparse CD-stacked dataset saved successfully!\nHousehold mapping saved to calibration_output/mappings/results_household_mapping.csv\n\nVerifying saved file...\n  Final households: 284\n  Final persons: 898\n  Total population (from household weights): 288\n"},"children":[],"key":"gc8kxRLbZL"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":16,"metadata":{},"data":{"text/plain":{"content":"'calibration_output/results.h5'","content_type":"text/plain"}}},"children":[],"key":"cdA09YcjFo"}],"key":"um7FAzoEWk"}],"key":"ihj94aY4YV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%ls calibration_output","key":"PaLE8kJfuM"},{"type":"outputs","id":"vUaRPiCjhAk_vTYXoi0qC","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\u001b[0m\u001b[01;34mmappings\u001b[0m/  results.h5\n"},"children":[],"key":"M3SikVUbOs"}],"key":"dv9CNjfX2O"}],"key":"g2kBwdjQPl"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note that there is a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Md2D44sB0z"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"mappings","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IrY4L5Yd2Z"}],"key":"yqKJBWmeGf"},{"type":"text","value":" directory that has also been created by create_sparse_cd_stacked_dataset. This contains the CSV file that links the original households to the donor households. The reason it’s a seperate folder is to keep the h5 files and the mapping CSVs organized when this function is run for all districts or states.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"L2zu0mOmpQ"}],"key":"pk3fI3tdmp"}],"key":"SvjzC39xkk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%ls calibration_output/mappings","key":"b9DtTqanYC"},{"type":"outputs","id":"buWtCchXHNBYSBsbPWFYH","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"results_household_mapping.csv\n"},"children":[],"key":"oGRLiWBCuf"}],"key":"NEG6jbzQy6"}],"key":"QJv2LsYYRz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sim_after = Microsimulation(dataset=\"./calibration_output/results.h5\")\n\nhh_after_df =  pd.DataFrame(sim_after.calculate_dataframe([\n    \"household_id\", \"congressional_district_geoid\", \"county\", \"household_weight\", \"state_fips\", \"snap\"])                                        \n)\nprint(hh_after_df)","key":"lzVT1Es3g8"},{"type":"outputs","id":"eJhKcCqG7wC_UzuoTXWeo","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"     household_id  congressional_district_geoid  \\\n0           50000                           201   \n1           50001                           201   \n2           50002                           201   \n3           50003                           201   \n4           50004                           201   \n..            ...                           ...   \n279        125125                          3701   \n280        125126                          3701   \n281        125127                          3701   \n282        125128                          3701   \n283        125129                          3701   \n\n                            county  household_weight  state_fips         snap  \n0    ALEUTIANS_WEST_CENSUS_AREA_AK               3.5           2   342.480042  \n1     YUKON_KOYUKUK_CENSUS_AREA_AK               1.0           2  3433.199707  \n2        ALEUTIANS_EAST_BOROUGH_AK               1.0           2     0.000000  \n3        SITKA_CITY_AND_BOROUGH_AK               1.0           2     0.000000  \n4        ANCHORAGE_MUNICIPALITY_AK               1.0           2     0.000000  \n..                             ...               ...         ...          ...  \n279               LENOIR_COUNTY_NC               1.0          37     0.000000  \n280               CHOWAN_COUNTY_NC               1.0          37     0.000000  \n281               LENOIR_COUNTY_NC               1.0          37     0.000000  \n282                WAYNE_COUNTY_NC               1.0          37     0.000000  \n283            EDGECOMBE_COUNTY_NC               1.0          37     0.000000  \n\n[284 rows x 6 columns]\n"},"children":[],"key":"vjp2bCC8E2"}],"key":"X67Y6JM4Cj"}],"key":"AiHuTPkBhh"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can see one of the correct instances above but let’s confirm that this new household id does in fact link back to the original in both cases.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y0DPRrMgXG"}],"key":"xn1gvuJLQd"}],"key":"TLhZJf0IC5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"mapping_df = pd.read_csv(\"calibration_output/mappings/results_household_mapping.csv\")\nmapping_df.loc[mapping_df.original_household_id == hh_id]","key":"Zl89QrLDmx"},{"type":"outputs","id":"oz_zrdPHnW5n71B70h0m1","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":20,"metadata":{},"data":{"text/html":{"content":"\u003cdiv\u003e\n\u003cstyle scoped\u003e\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n\u003c/style\u003e\n\u003ctable border=\"1\" class=\"dataframe\"\u003e\n  \u003cthead\u003e\n    \u003ctr style=\"text-align: right;\"\u003e\n      \u003cth\u003e\u003c/th\u003e\n      \u003cth\u003enew_household_id\u003c/th\u003e\n      \u003cth\u003eoriginal_household_id\u003c/th\u003e\n      \u003cth\u003econgressional_district\u003c/th\u003e\n      \u003cth\u003estate_fips\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003cth\u003e0\u003c/th\u003e\n      \u003ctd\u003e50000\u003c/td\u003e\n      \u003ctd\u003e25\u003c/td\u003e\n      \u003ctd\u003e201\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e1\u003c/th\u003e\n      \u003ctd\u003e125000\u003c/td\u003e\n      \u003ctd\u003e25\u003c/td\u003e\n      \u003ctd\u003e3701\u003c/td\u003e\n      \u003ctd\u003e37\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003c/div\u003e","content_type":"text/html"},"text/plain":{"content":"   new_household_id  original_household_id  congressional_district  state_fips\n0             50000                     25                     201           2\n1            125000                     25                    3701          37","content_type":"text/plain"}}},"children":[],"key":"BY0hmiiJiy"}],"key":"irAcX93yUl"}],"key":"Yy720yKAFG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"new_hh_ids = mapping_df.loc[mapping_df.original_household_id == hh_id].new_household_id\nhh_after_df.loc[hh_after_df.household_id.isin(new_hh_ids)]","key":"k69K4DaWUm"},{"type":"outputs","id":"ud9WloFM8KP-Z6bgfLBvd","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":21,"metadata":{},"data":{"text/html":{"content":"\u003cdiv\u003e\n\u003cstyle scoped\u003e\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n\u003c/style\u003e\n\u003ctable border=\"1\" class=\"dataframe\"\u003e\n  \u003cthead\u003e\n    \u003ctr style=\"text-align: right;\"\u003e\n      \u003cth\u003e\u003c/th\u003e\n      \u003cth\u003ehousehold_id\u003c/th\u003e\n      \u003cth\u003econgressional_district_geoid\u003c/th\u003e\n      \u003cth\u003ecounty\u003c/th\u003e\n      \u003cth\u003ehousehold_weight\u003c/th\u003e\n      \u003cth\u003estate_fips\u003c/th\u003e\n      \u003cth\u003esnap\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003cth\u003e0\u003c/th\u003e\n      \u003ctd\u003e50000\u003c/td\u003e\n      \u003ctd\u003e201\u003c/td\u003e\n      \u003ctd\u003eALEUTIANS_WEST_CENSUS_AREA_AK\u003c/td\u003e\n      \u003ctd\u003e3.5\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n      \u003ctd\u003e342.480042\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e154\u003c/th\u003e\n      \u003ctd\u003e125000\u003c/td\u003e\n      \u003ctd\u003e3701\u003c/td\u003e\n      \u003ctd\u003eVANCE_COUNTY_NC\u003c/td\u003e\n      \u003ctd\u003e2.5\u003c/td\u003e\n      \u003ctd\u003e37\u003c/td\u003e\n      \u003ctd\u003e789.199951\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003c/div\u003e","content_type":"text/html"},"text/plain":{"content":"     household_id  congressional_district_geoid  \\\n0           50000                           201   \n154        125000                          3701   \n\n                            county  household_weight  state_fips        snap  \n0    ALEUTIANS_WEST_CENSUS_AREA_AK               3.5           2  342.480042  \n154                VANCE_COUNTY_NC               2.5          37  789.199951  ","content_type":"text/plain"}}},"children":[],"key":"OpEkh93ok2"}],"key":"uL0LxisTAz"}],"key":"gI8naxUOf2"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And we can see that the snap numbers still match their values from the different US state systems. However note that due to the use of policyengine-core’s random function in a component of snap_gross_income, for some households, the value in the final simulation will not match the one used in creating the X matrix (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cdqlstHOrk"},{"type":"inlineCode","value":"X_sparse","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qO7QaeyvJg"},{"type":"text","value":" here). This is outlined in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"crs5wj0PhQ"},{"type":"link","url":"https://github.com/PolicyEngine/policyengine-core/issues/412","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Issue 412","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JqOEV0CN86"}],"urlSource":"https://github.com/PolicyEngine/policyengine-core/issues/412","data":{"kind":"issue","org":"PolicyEngine","repo":"policyengine-core","issue_number":"412"},"internal":false,"protocol":"github","key":"fHX3ZNYaI2"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ueRgKuOQSt"}],"key":"HxE0w2mTV5"}],"key":"gH2LCo9W1y"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%rm -r calibration_output","key":"q7QK4qO7Vi"},{"type":"outputs","id":"cD8YySe8v1Yj7yZkFHsKD","children":[],"key":"IK2tbPqDo0"}],"key":"eVV60twrQd"}],"key":"qHQtzYWp48"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Long Term Projections","url":"/long-term-projections","group":"PolicyEngine US Data"},"next":{"title":"Discussion","url":"/discussion","group":"PolicyEngine US Data"}}},"domain":"http://localhost:3000"},"project":{"bibliography":["/home/runner/work/policyengine-us-data/policyengine-us-data/docs/references.bib"],"title":"PolicyEngine US Data","authors":[{"nameParsed":{"given":"PolicyEngine","family":"Team","literal":"PolicyEngine Team"},"name":"PolicyEngine Team","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/policyengine/policyengine-us-data","copyright":"2024","toc":[{"file":"abstract.md"},{"file":"introduction.md"},{"file":"background.md"},{"file":"data.md"},{"file":"methodology.md"},{"file":"long_term_projections.md"},{"file":"local_area_calibration_setup.ipynb"},{"file":"discussion.md"},{"file":"conclusion.md"},{"file":"appendix.md"}],"exports":[],"index":"index","pages":[{"slug":"introduction","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"background","title":"Background","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"data","title":"Data Sources","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"methodology","title":"Methodology","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"long-term-projections","title":"Long Term Projections","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"local-area-calibration-setup","title":"Local Area Calibration Setup","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"discussion","title":"Discussion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"conclusion","title":"Conclusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1},{"slug":"appendix","title":"Appendix","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":1}]}}},"actionData":null,"errors":null},"future":{"unstable_dev":false,"unstable_postcss":false,"unstable_tailwind":false,"v2_errorBoundary":true,"v2_headers":true,"v2_meta":true,"v2_normalizeFormMethod":true,"v2_routeConvention":true}};</script><script type="module" async="">import "/policyengine-us-data/build/manifest-7B0967AD.js";
import * as route0 from "/policyengine-us-data/build/root-EDJFWIEV.js";
import * as route1 from "/policyengine-us-data/build/routes/$-AD65NCUT.js";
window.__remixRouteModules = {"root":route0,"routes/$":route1};

import("/policyengine-us-data/build/entry.client-PCJPW7TK.js");</script></body></html>